"use strict";var __extends=this&&this.__extends||function(){var t=function(e,a){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])})(e,a)};return function(e,a){function i(){this.constructor=e}t(e,a),e.prototype=null===a?Object.create(a):(i.prototype=a.prototype,new i)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),moment_es6_1=require("moment-es6"),pagination_1=require("../../ui/components/pagination/pagination"),sanitize_1=require("../../common/sanitize"),component_1=require("../../core/component"),add_1=require("../../icon/add"),arrow_drop_down_1=require("../../icon/arrow-drop-down"),expand_more_1=require("../../icon/expand-more"),expand_less_1=require("../../icon/expand-less"),PdSDKTable=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.createCellData=function(t,a,i,n){var s="",l=t[a],r=n[a];if(r&&r.complex&&(l=a.indexOf("[")>0?lodash_1.get(t,a):e.getValue(t,a)),l){for(var d=e.dataToArr(l),o=0,c=d;o<c.length;o++){var p=c[o];p=e.createCellSingleData(p,a,n,t),s+=","+p}s=s.substring(1)}else s=e.createCellSingleData("",a,n,t);if(i[a]){var f=l;l||(f="链接"),s=e.createLink(t[i[a]],f),l&&!s&&(s=l)}return s},e.createCellSingleData=function(t,a,i,n){var s="",l=i[a],r=l?l.type||l:"string";try{if("year"===r)s=e.formatYear(t);else if("date"===r)s=e.formatDate(t);else if("dateTime"===r)s=e.formatDatetime(t);else if("json"===r)s=JSON.stringify(t);else if("link"===r)s=e.createLink(t,l.name,"pdsdk-table-btn-link");else if(r instanceof Function)s=r(t,n);else{var d=new sanitize_1.PdSanitizeUtil;s=d.cleanHTML(t)}}catch(o){}return s},e.createLink=function(t,e,a){return void 0===e&&(e="查看"),void 0===a&&(a=""),t?'<a href="'+t+'" target="_blank" class="'+a+'">'+e+"</a>":""},e.cutStr=function(t,e){if(t){var a=$("<div>"+t+"</div>").text();return a.length>e?a.substring(0,e)+"...":a}return""},e.dataToArr=function(t){var e=[];if(t instanceof Array)e=t;else if("string"==typeof t)if(0===t.indexOf("["))try{e=JSON.parse(t)}catch(a){e=[t]}else e=[t];else e=[t];return e},e.formatDate=function(t){return moment_es6_1["default"](t).format("YYYYMMDD")},e.formatDatetime=function(t){return moment_es6_1["default"](t).format("YYYY-MM-DD HH:mm:ss")},e.formatYear=function(t){return moment_es6_1["default"](t).format("YYYY")},e.getValue=function(t,a){if(a.indexOf(".")>0){var i=a.split(".")[0],n=t[i];if(n instanceof Array){for(var s=[],l=0,r=n;l<r.length;l++){var d=r[l];s.push(e.getValue(d,a.substring(a.indexOf(".")+1)))}return s}return e.getValue(n,a.substring(a.indexOf(".")+1))}return t[a]},e.mapFieldsLink=function(t,e){for(var a={},i=0,n=t;i<n.length;i++){var s=n[i],l=e[s];if(l&&l instanceof Object&&"link"===l.type&&l.fields)for(var r=0,d=l.fields;r<d.length;r++){var o=d[r];a[o]=s}}return a},e.updateCellData=function(t,a,i,n){var s=a?a instanceof Object?a.type||"string":a:"string";if("string"===s){var l=a?a.len:n;if(l)if(i){if(t){var r=$(t);t=r.length?r.text(e.cutStr(r.text(),l))[0].outerHTML:e.cutStr(t,l)}}else t=e.cutStr(t,l)}return t},e.prototype.getData=function(){return this.data},e.prototype.getFilterKeyword=function(){return this.select(".pdsdk-table-search-kw-container").find("input").val()},e.prototype.getFilterOptions=function(){var t={};return this.select(".pdsdk-table-filter-item").each(function(e,a){var i="",n=$(a).find("span[data-pdsdk-option-value].active");if(n.length){var s=!1,l=[];n.each(function(t,e){var a=$(e).attr("data-pdsdk-option-value");a?(i=$(e).attr("data-pdsdk-option-key"),l.push(a)):s=!0}),s||(t[i]=l)}}),t},e.prototype.getSelectedData=function(){return lodash_1.filter(this.data,["checked",!0])},e.prototype.getTableContainer=function(){return this.select(".pdsdk-table-content")},e.prototype.load=function(t){return this.settings.loader(t)},e.prototype.setData=function(t){this.data=t,this.rendererData()},e.prototype.setPage=function(t,e,a){var i=this;if(this.pageNo=e,this.settings.pageEnable)if(t>0){var n={totalItem:t,pageSize:a,current:e,selector:this.select(".pagination"),callback:function(t,e){i.load(e)}};$.extend(!0,n,this.settings.pageSettings),this.pagination=new pagination_1.PdUIPagination(n)}else this.select(".pagination").empty()},e.prototype.bindEvent=function(){var e=this;t.prototype.bindEvent.call(this),this.bindFilterEvent(),this.select(".pdsdk-table-content").on("click",".pdsdk-table-data-angle",function(t){$(t.currentTarget).toggleClass("on").closest("tr").next("tr.pdsdk-table-detail-line").toggleClass("hide")}),this.$el.on("click",'th input[type="checkbox"]',function(t){var a=t.currentTarget,i=a.checked;e.data=lodash_1.flatMap(e.data,function(t){return t.checked=i,t}),e.updateCheckboxStatus()}).on("click",'td input[type="checkbox"]',function(t){var a=t.currentTarget,i=a.checked,n=$(a).closest("tr").index();e.data[n].checked=i,e.updateCheckboxStatus()})},e.prototype.bindFilterEvent=function(){var t=this;this.select(".pdsdk-table-filter").on("click","span[data-pdsdk-option-value]",function(e){var a=$(e.currentTarget);a.closest(".pdsdk-table-filter-item").hasClass("multi")?a.toggleClass("active"):(a.hasClass("active")?a.removeClass("active"):a.addClass("active").siblings(".active").removeClass("active"),t.load(1))}),this.select(".pdsdk-table-filter").on("click",".pdsdk-table-filter-more",function(t){var e=$(t.currentTarget);e.closest(".pdsdk-table-filter-item").addClass("expend")}),this.select(".pdsdk-table-filter").on("click",".pdsdk-table-filter-less",function(t){var e=$(t.currentTarget);e.closest(".pdsdk-table-filter-item").removeClass("expend")}),this.select(".pdsdk-table-filter").on("click",".pdsdk-table-filter-multi",function(t){var e=$(t.currentTarget);e.closest(".pdsdk-table-filter-item").addClass("multi")}),this.select(".pdsdk-table-filter").on("click",".pdsdk-table-btn-confirm",function(e){var a=$(e.currentTarget);a.closest(".pdsdk-table-filter-item").removeClass("multi"),t.load(1)}),this.select(".pdsdk-table-filter").on("click",".pdsdk-table-btn-cancel",function(t){var e=$(t.currentTarget);e.closest(".pdsdk-table-filter-item").removeClass("multi")}),this.select(".pdsdk-table-search-kw-container").on("keydown","input",function(e){var a=window.event?e.keyCode:e.which;13===a&&t.load(1)})},e.prototype.buildFilter=function(t){for(var e="",a=this.settings.filters,i=0,n=a;i<n.length;i++){for(var s=n[i],l=s.label||s.key,r="",d=0,o=s.options;d<o.length;d++){var c=o[d];if(c instanceof Object)if(void 0!==c.key&&void 0!==c.value){var p=c;r+='<span data-pdsdk-option-value="'+p.value+'" data-pdsdk-option-key="'+s.key+'">'+p.key+"</span>"}else{var p=c;for(var f in p)p.hasOwnProperty(f)&&(r+='<span data-pdsdk-option-value="'+p[f]+'" data-pdsdk-option-key="'+s.key+'">'+p[f]+"</span>")}else r+='<span data-pdsdk-option-value="'+c+'" data-pdsdk-option-key="'+s.key+'">'+c+"</span>"}var u=add_1["default"](16),b=expand_more_1["default"](16),k=expand_less_1["default"](16),h=s.multi!==!1?'<span class="pdsdk-table-filter-multi">'+u+' 多选</span><button class="pdui-btn pdui-btn-xs pdui-btn-primary pdsdk-table-btn-confirm">确定</button><button class="pdui-btn pdui-btn-xs pdui-btn-primary-outline pdsdk-table-btn-cancel">取消</button>':"";e+='<div class="pdsdk-table-filter-item '+(h?"pdsdk-table-multi-filter":"")+'"><div class="pdsdk-table-filter-item-label">'+l+'：</div><div class="pdsdk-table-filter-item-content">'+r+'<div class="pdsdk-table-more-container"><span class="pdsdk-table-filter-more">更多 '+b+'</span><span class="pdsdk-table-filter-less">收起 '+k+"</span>"+h+"</div></div></div>"}this.settings.kwEnable&&(e+='<div class="pdsdk-table-filter-item pdsdk-table-filter-item-kw"><div class="pdsdk-table-filter-item-label">关键词：</div><div class="pdsdk-table-filter-item-content"><div class="pdsdk-table-search-kw-container"><input type="text" class="pdui-input pdui-input-sm"><button class="pdui-btn pdui-btn-sm pdui-btn-primary pdsdk-table-btn-confirm">确定</button></div></div></div>'),t.prepend('<div class="pdsdk-table-filter">'+e+"</div>")},e.prototype.initSettings=function(a){return $.extend(!0,{},t.prototype.initSettings.call(this,e.defaultSettings),a)},e.prototype.initTemplate=function(){var t=$(this.settings.selector);return this.saveOriginClass(t),t.addClass("pdsdk-table"),t.append('<div class="pdsdk-table-content"></div><div class="pdsdk-table-page"><div class="pagination-outter"><ul class="pagination"></ul></div></div>'),this.buildFilter(t),t},e.prototype.mounted=function(){t.prototype.mounted.call(this),this.bindEvent();var e=this.settings.payload;e&&(e.data&&this.setData(e.data),e.page&&this.setPage(e.page.totalItem,e.page.pageNo||1,e.page.pageSize))},e.prototype.rendererData=function(){var t=this.settings,a="<thead><tr>",i="<tbody>",n=t.tableEnable,s=n&&t.selectEnable,l=t.detailEnable,r=t.fields,d=t.tableFields||r,o=t.detailFields||r,c=$.extend({},t.tableRendererList,t.rendererList),p=$.extend({},t.detailRendererList,t.rendererList),f={};for(var u in r)r.hasOwnProperty(u)&&(f[r[u]]=t.fieldsName?t.fieldsName[u]:r[u]);var b=e.mapFieldsLink(r,c),k=e.mapFieldsLink(r,p);if(n){s&&(a+='<th class="pdsdk-table-select"><label class="pdui-checkbox"><input type="checkbox"><span>全选</span></label></th>'),l&&(a+="<th></th>");for(var h=lodash_1.values(b),v=0,g=d;v<g.length;v++){var m=g[v];lodash_1.indexOf(h,m)<0&&(a+="<th>"+f[m]+"</th>")}}for(var y=0,_=this.data;y<_.length;y++){var m=_[y],x=0;if(n){var C="<tr>";if(s&&(C+='<td class="pdsdk-table-select"><label class="pdui-checkbox"><input type="checkbox"><span>&nbsp;</span></label></td>'),l){var w=arrow_drop_down_1["default"](20);C+='<td class="pdsdk-table-data-angle">'+w+" </td>"}for(var D=0,S=d;D<S.length;D++){var O=S[D];x++;var T=c[O];if(!T||!T.fields){var E=e.createCellData(m,O,b,c),F=$("<div>"+E+"</div>").text();E=e.updateCellData(E,T,b[O],40);var P="",Y="";T&&T.style&&(T.style.align&&(P=' align="'+T.style.align+'"'),T.style.width&&(Y=' width="'+T.style.width+'"')),C+='<td title="'+F+'"'+P+Y+">"+E+"</td>"}}C+="</tr>",i+=C}var L=n?"hide":"";if(l){for(var C='<tr class="pdsdk-table-detail-line '+L+'"><td colspan="'+(x+1)+'">',q=0,j=o;q<j.length;q++){var M=j[q],T=p[M];if(!T||!T.fields){var E=e.createCellData(m,M,k,p),z=T&&T.label?"<label>"+f[M]+":</label>":"";E=e.updateCellData(E,T,k[M]),C+='<div class="pdsdk-table-detail-'+M+'">'+z+E+"</div>"}}C+="</td></tr>",i+=C}}i+="</body>",a+="</tr></thead>",n||(a=""),this.select(".pdsdk-table-content").html('<table class="pdsdk-table-normal">'+a+i+"</table>")},e.prototype.updateCheckboxStatus=function(){var t=this,e=this.data.length;this.select('th input[type="checkbox"]').prop("checked",e&&lodash_1.filter(this.data,["checked",!0]).length===e),this.select("tbody tr").each(function(e,a){$(a).find('input[type="checkbox"]').prop("checked",t.data[e].checked)})},e.prototype.unbindEvent=function(){t.prototype.unbindEvent.call(this),this.unbindFilterEvent(),this.select(".pdsdk-table-content").off("click",".pdsdk-table-data-angle"),this.$el.off("click",'th input[type="checkbox"]').off("click",'td input[type="checkbox"]')},e.prototype.unbindFilterEvent=function(){this.select(".pdsdk-table-filter").off("click","span[data-pdsdk-option-value]"),this.select(".pdsdk-table-filter").off("click",".pdsdk-table-filter-more"),this.select(".pdsdk-table-filter").off("click",".pdsdk-table-filter-less"),this.select(".pdsdk-table-filter").off("click",".pdsdk-table-filter-multi"),this.select(".pdsdk-table-filter").off("click",".pdsdk-table-btn-confirm"),this.select(".pdsdk-table-filter").off("click",".pdsdk-table-btn-cancel"),this.select(".pdsdk-table-search-kw-container").off("keydown","input")},e.defaultSettings={pageEnable:!0,kwEnable:!0,tableEnable:!0},e}(component_1.PdComponent);exports.PdSDKTable=PdSDKTable;