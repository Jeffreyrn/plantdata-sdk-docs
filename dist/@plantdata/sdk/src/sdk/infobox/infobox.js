"use strict";var __extends=this&&this.__extends||function(){var t=function(i,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var n in i)i.hasOwnProperty(n)&&(t[n]=i[n])})(i,n)};return function(i,n){function s(){this.constructor=i}t(i,n),i.prototype=null===n?Object.create(n):(s.prototype=n.prototype,new s)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),component_1=require("../../core/component"),common_1=require("../../common/common"),utils_1=require("../utils/utils"),refresh_1=require("../../icon/refresh"),PdSDKInfobox=function(t){function i(i){return t.call(this,i)||this}return __extends(i,t),i.prototype.buildInfobox=function(t){if(this.clear(),t&&t.self){this.$el.append('<div class="pdsdk-infobox-head"><div class="pdsdk-infobox-info"></div></div><div class="pdsdk-infobox-body"></div>');var i=this.buildEntity(t.self,!1),n=refresh_1["default"](18,{"class":"pdsdk-infobox-refresh"});if(this.$el.find(".pdsdk-infobox-info").append('<div class="pdsdk-infobox-title">'+i+n+"</div>"),t.self.img){var s=t.self.img;0!==t.self.img.indexOf("http")&&(s=this.settings.imgBuilder?this.settings.imgBuilder(t.self.img):t.self.img),this.$el.find(".pdsdk-infobox-head").prepend('<div class="pdsdk-infobox-img"><img src="'+s+'" alt=""></div>')}if(t.self.extra){var e="";for(var o in t.self.extra)if(t.self.extra.hasOwnProperty(o)){var a=t.self.extra[o];this.settings.attrVisible&&!this.settings.attrVisible(a.k,t)||(e+=this.buildExtra(a))}if(t.atts)for(var r in t.atts)if(t.atts.hasOwnProperty(r)){var l=t.atts[r],d="";for(var f in l.v)l.v.hasOwnProperty(f)&&(d+="<li>"+this.buildEntity(l.v[f],!0)+"</li>");this.settings.attrVisible&&!this.settings.attrVisible(l.k,t)||(e+='<tr><td class="pdsdk-infobox-info-label">'+l.k+'</td><td class="pdsdk-infobox-info-detail"><ul>'+d+"</ul></td></tr>")}this.$el.find(".pdsdk-infobox-body").append("<table><tbody>"+e+'</tbody><tfoot><tr><td rowspan="2">其他信息暂缺</td></tr></tfoot></table>')}if(t.pars){this.$el.find(".pdsdk-infobox-info").append('<div class="pdsdk-infobox-pars"><label class="pdsdk-infobox-label">所属：</label><ul></ul></div>');for(var p in t.pars)t.pars.hasOwnProperty(p)&&this.$el.find(".pdsdk-infobox-pars ul").append("<li>"+this.buildEntity(t.pars[p],!0)+"</li>")}if(t.sons){var e="";for(var c in t.sons)t.sons.hasOwnProperty(c)&&(e+="<li>"+this.buildEntity(t.sons[c],!0)+"</li>");this.$el.find(".pdsdk-infobox-head").append('<div class="pdsdk-infobox-pars"><label class="pdsdk-infobox-label">相关：</label><ul>'+e+"</ul></div>")}}else this.showNoData()},i.prototype.clear=function(){this.$el.empty()},i.prototype.destroy=function(){t.prototype.destroy.call(this),this.removeDOM()},i.prototype.load=function(t,i){var n=this;return this.loadParams={query:t,callback:i},this.clear(),this.settings.loader?this.settings.loader(this,t).then(function(t){return t?(n.buildInfobox(t),Promise.resolve(t)):(n.showNoData(),Promise.reject(t))},function(){n.showNoData()}):this.loader(t,i)},i.prototype.reLoad=function(){this.load(this.loadParams.query,this.loadParams.callback)},i.prototype.showNoData=function(){this.$el.html(common_1.PdCommonUtils.buildNoData("知识卡片读取失败"))},i.prototype.bindEvent=function(){var i=this;t.prototype.bindEvent.call(this),this.$el.on("click",".pdsdk-infobox-link",function(t){var n=$(t.currentTarget).attr("data-pdsdk-id");i.settings.onLinkClick?i.settings.onLinkClick(n,i):i.onLinkClick(n)}),this.$el.on("click",".pdsdk-infobox-info-detail a",function(t){$(t.currentTarget).closest(".pdsdk-infobox-info-detail").toggleClass("on")}).on("click",".pdsdk-infobox-refresh",function(t){i.reLoad()})},i.prototype.buildEntity=function(t,i){var n=t.meaningTag?"("+t.meaningTag+")":"",s=t.name+n,e='<span class="pdsdk-infobox-name" title="'+s+'">'+t.name+'<span class="pdsdk-infobox-meaningTag" title="'+s+'">'+n+"</span></span>";return i&&this.settings.linkEnable?'<a href="javascript:void(0)" class="pdsdk-infobox-link" data-pdsdk-id="'+t.id+'">'+e+"</a>":e},i.prototype.buildExtra=function(t){if(this.settings.emptyAttrVisible||t.v){var i=t.v||"-";if(51===t.type&&"-"!==i){var n=i;n.href?(n.name||(n.name=n.href),i='<a target="_blank" href="'+n.href+'" tar>'+n.name+"</a>"):i=n.name||"-"}else if("number"==typeof this.settings.maxLen){var s=this.settings.maxLen>0?this.settings.maxLen:1/0;t.v.length>s&&(i='<span class="pdsdk-infobox-info-detail-short">'+t.v.substring(0,s)+'<a href="javascript:void(0)">查看全部&gt;&gt;</a></span><span class="pdsdk-infobox-info-detail-long">'+t.v+'<a href="javascript:void(0)">收起&lt;&lt;</a></span>')}return'<tr><td class="pdsdk-infobox-info-label line-hidden" title="'+t.k+'">'+t.k+'</td><td class="pdsdk-infobox-info-detail">'+i+"</td></tr>"}return""},i.prototype.initSettings=function(n){return $.extend(!0,{},t.prototype.initSettings.call(this,i.defaultSettings),n)},i.prototype.initTemplate=function(){return $('<div class="pdsdk-infobox"></div>')},i.prototype.loader=function(t,i){var n=this,s=this.settings.ajaxSettings,e=s.queryData||{},o=s.formData||{};e.kgName=this.settings.kgName,o=$.extend(!0,{},o,t);var a=this.settings.container?$(this.settings.container)[0]:"",r={url:s.baseUrl+"app/infobox",type:"POST",data:o,el:a};return r=$.extend(!0,{},r,s),r.url=utils_1.PdSDKUtils.buildUrl(r.url,e),utils_1.PdSDKUtils.ajax(r).then(function(t){return r.success?t:(t?(n.buildInfobox(t),i&&(n.callback=i,i(t))):n.showNoData(),t)},function(){n.showNoData()})},i.prototype.mounted=function(){t.prototype.mounted.call(this),this.settings.container&&$(this.settings.container).append(this.$el),this.bindEvent()},i.prototype.onLinkClick=function(t){this.load({id:t},this.callback)},i.prototype.unbindEvent=function(){t.prototype.unbindEvent.call(this),this.$el.off("click",".pdsdk-infobox-link"),this.$el.off("click",".pdsdk-infobox-info-detail a")},i.defaultSettings={linkEnable:!1,emptyAttrVisible:!0,maxLen:80,onLoadFailed:function(t,i){i.showNoData()}},i}(component_1.PdComponent);exports.PdSDKInfobox=PdSDKInfobox;