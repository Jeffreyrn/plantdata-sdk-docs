"use strict";var __extends=this&&this.__extends||function(){var t=function(e,a){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])})(e,a)};return function(e,a){function s(){this.constructor=e}t(e,a),e.prototype=null===a?Object.create(a):(s.prototype=a.prototype,new s)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),common_1=require("../../../../../common/common"),plugin_1=require("../../plugin"),stats_entity_attrvalue_1=require("./stats-entity-attrvalue"),utils_1=require("../../../../utils/utils"),dialog_1=require("../../../../../vis/utils/modal/dialog/dialog"),form_1=require("../../../../../ui/components/form/form"),utils_2=require("../../../../../vis/utils"),stats_entity_concept_1=require("./stats-entity-concept"),stats_relation_attrname_1=require("./stats-relation-attrname"),stats_relation_attrvalue_1=require("./stats-relation-attrvalue"),add_1=require("../../../../../icon/add"),bar_chart_1=require("../../../../../icon/bar-chart"),PdSDKPluginStatsChart=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.add=function(t,e){var a=this;return this.addRequest(t,e).then(function(e){return a.addStat(a.createStatItem(t,e)),e})},e.prototype.clearStats=function(){if(this.statTools){for(var t=0,e=this.statTools;t<e.length;t++){var a=e[t];a.destroy()}this.select(".pdsdk-stats-chart-body").empty()}},e.prototype["delete"]=function(t){var e=this;return this.deleteRequest(t).then(function(a){var s=lodash_1.findIndex(e.getStatsSettings(),["id",t]);e.deleteStat(e.statTools[s])})},e.prototype.destroy=function(){this.clearStats(),t.prototype.destroy.call(this)},e.prototype.getPluginType=function(){return"statsChart"},e.prototype.getStatsSettings=function(){for(var t=[],e=0,a=this.statTools;e<a.length;e++){var s=a[e];t.push(s.getStatsSettings())}return t},e.prototype.load=function(t){var e=this;return void 0===t&&(t=1),this.listRequest(t).then(function(){return e.getStatsSettings()})},e.prototype.stats=function(){if(this.clearStats(),this.statTools)for(var t=0,e=this.statTools;t<e.length;t++){var a=e[t];a.rendererData()}},e.prototype.addRequest=function(t,e){var a=$.extend(!0,{ajaxSettings:this.settings.ajaxSettings,kgName:this.settings.kgName},this.settings.addSettings),s=a.ajaxSettings,i=s.queryData||{};i.kgName=a.kgName;var n=s.formData||{};n.type=t,n.rule=e;var r={url:s.baseUrl+"graph/stat/settings/add",type:"POST",el:this.container.$el[0],data:n};return r=$.extend(!0,{},r,s),r.url=utils_1.PdSDKUtils.buildUrl(r.url,i),utils_1.PdSDKUtils.ajax(r)},e.prototype.addStat=function(t){this.select(".pdsdk-stats-chart-body").append(t.$el),this.statTools.push(t);var e=this.container.getData();e&&e.nodes&&t.rendererData()},e.prototype.bindEvent=function(){var e=this;t.prototype.bindEvent.call(this),this.$el.on("click",".pdsdk-stats-chart-add button",function(t){e.addDialog.open({event:t})})},e.prototype.createStatItem=function(t,e){switch(void 0===e&&(e={}),t){case stats_entity_attrvalue_1.PdSDKPluginStatsEntityAttrValue.type:return new stats_entity_attrvalue_1.PdSDKPluginStatsEntityAttrValue(this.createStatsToolSettings(e));case stats_relation_attrvalue_1.PdSDKPluginStatsRelationAttrValue.type:return new stats_relation_attrvalue_1.PdSDKPluginStatsRelationAttrValue(this.createStatsToolSettings(e));case stats_relation_attrname_1.PdSDKPluginStatsRelationAttrName.type:return new stats_relation_attrname_1.PdSDKPluginStatsRelationAttrName(this.createStatsToolSettings(e));case stats_entity_concept_1.PdSDKPluginStatsEntityConcept.type:return new stats_entity_concept_1.PdSDKPluginStatsEntityConcept(this.createStatsToolSettings(e))}},e.prototype.createStatsToolSettings=function(t,e){var a=this;return $.extend(!0,{schema:this.settings.schema,kgName:this.settings.kgName,ajaxSettings:this.settings.ajaxSettings,editable:this.settings.editable,deletable:this.settings.editable,highlightTrigger:this.settings.highlightTrigger,highlightMode:this.settings.highlightMode,chartSettings:this.settings.chartSettings,netChart:this.settings.container,sdkNetChart:this.settings.sdkNetChart,beforeDelete:function(t,e){return t.id?a["delete"](t.id):t},onDelete:function(t,e){a.deleteStat(e)},beforeUpdate:function(t,e){return a.updateRequest(t.id,t.type,t.rule).then(function(t){return t})}},e,t)},e.prototype.deleteRequest=function(t){var e=$.extend(!0,{ajaxSettings:this.settings.ajaxSettings,kgName:this.settings.kgName},this.settings.deleteSettings),a=e.ajaxSettings,s=a.queryData||{};s.kgName=e.kgName;var i=a.formData||{};i.id=t;var n={url:a.baseUrl+"graph/stat/settings/delete",type:"POST",el:this.container.$el[0],data:i};return n=$.extend(!0,{},n,a),n.url=utils_1.PdSDKUtils.buildUrl(n.url,s),utils_1.PdSDKUtils.ajax(n)},e.prototype.deleteStat=function(t){for(var e=0;e<this.statTools.length;e++)this.statTools[e]===t&&this.statTools.splice(e,1)},e.prototype.initSettings=function(a){return $.extend(!0,{},t.prototype.initSettings.call(this,e.defaultSettings),a)},e.prototype.initTemplate=function(){var t="图统计",e=bar_chart_1["default"](20),a=add_1["default"](24),s=common_1.PdCommonUtils.createId("pdsdk-stats-chart-"),i='<div class="pdsdk-stats-chart-add"><button class="pdui-btn pdui-btn-primary-outline" data-id="'+s+'">'+a+"添加分析</button></div>",n='<div class="pdsdk-stats-chart pdsdk-stats-chart-edit-'+this.settings.editable+'"><div class="pdsdk-stats-chart-body"></div>'+i+"</div>";return this.buildPluginTemplate(n,e,t)},e.prototype.listRequest=function(t){var e=this;void 0===t&&(t=1);var a=$.extend(!0,{ajaxSettings:this.settings.ajaxSettings,kgName:this.settings.kgName},this.settings.listSettings),s=a.ajaxSettings,i=$.extend(!0,{pageSize:10},s.formData);i.pageNo=t,i.kgName=a.kgName;var n={url:s.baseUrl+"graph/stat/settings/get/list",type:"GET",el:this.container.$el[0]};return n=$.extend(!0,{},n,s),n.url=utils_1.PdSDKUtils.buildUrl(n.url,i),this.clearStats(),utils_1.PdSDKUtils.ajax(n).then(function(t){if(n.success)return t;for(var a=0,s=t||[];a<s.length;a++){var i=s[a];e.addStat(e.createStatItem(i.type,i))}return t})},e.prototype.mounted=function(){var e=this;if(t.prototype.mounted.call(this),this.bindEvent(),this.statTools=this.statTools||[],this.settings.statsSettings)for(var a=0,s=this.settings.statsSettings||[];a<s.length;a++){var i=s[a];this.addStat(this.createStatItem(i.type,i))}else this.listRequest();this.addDialog=new dialog_1.PdVisDialog({cls:"pdsdk-stats-chart-add-dialog",title:"添加分析",body:function(){if(e.settings.items&&e.settings.items.length){for(var t=[{label:"",value:""}],a=0,s=e.settings.items;a<s.length;a++){var i=s[a];switch(i){case stats_entity_attrvalue_1.PdSDKPluginStatsEntityAttrValue.type:t.push({label:stats_entity_attrvalue_1.PdSDKPluginStatsEntityAttrValue.typeName,value:stats_entity_attrvalue_1.PdSDKPluginStatsEntityAttrValue.type});break;case stats_relation_attrvalue_1.PdSDKPluginStatsRelationAttrValue.type:t.push({label:stats_relation_attrvalue_1.PdSDKPluginStatsRelationAttrValue.typeName,value:stats_relation_attrvalue_1.PdSDKPluginStatsRelationAttrValue.type});break;case stats_relation_attrname_1.PdSDKPluginStatsRelationAttrName.type:t.push({label:stats_relation_attrname_1.PdSDKPluginStatsRelationAttrName.typeName,value:stats_relation_attrname_1.PdSDKPluginStatsRelationAttrName.type});break;case stats_entity_concept_1.PdSDKPluginStatsEntityConcept.type:t.push({label:stats_entity_concept_1.PdSDKPluginStatsEntityConcept.typeName,value:stats_entity_concept_1.PdSDKPluginStatsEntityConcept.type})}}e.$addForm=$("<div></div>");var n=$(utils_2.PdVisEditItem.gentEditItem({type:"select",key:"type",label:"统计方式",value:t[0].value,options:t,mode:"label"}));return n.find("select").on("change",function(t){e.updateAddForm()}),e.$addForm.append(n),e.$addForm.append('<div class="pdsdk-stats-chart-add-form"></div>'),e.updateAddForm(),e.$addForm}return"暂无可选统计"},positiveClick:function(t,a){var s=e.$addForm.find('[name="type"]').val();if(s){var i=e.statEdit.getEditorData();return i?e.addRequest(s,i).then(function(t){return e.statEdit.setStatsSettings(e.createStatsToolSettings(t)),e.addStat(e.statEdit),e.statEdit.hideEdit(),e.statEdit.rendererData(),Promise.resolve(i)}):Promise.reject(new Error("配置错误"))}return common_1.PdCommonUtils.error("请选择统计类型"),Promise.reject(new Error("请选择统计类型"))}})},e.prototype.unbindEvent=function(){t.prototype.unbindEvent.call(this),this.$el.off("click",".pdsdk-stats-chart-add button")},e.prototype.updateAddForm=function(t){if(t||(t=form_1.PdUIForm.getFormData(this.$addForm).type),this.statEdit&&this.$addForm.find(".pdsdk-stats-chart-add-form").empty(),t){var e=void 0;switch(t){case stats_entity_attrvalue_1.PdSDKPluginStatsEntityAttrValue.type:this.statEdit=this.createStatItem(stats_entity_attrvalue_1.PdSDKPluginStatsEntityAttrValue.type,{editable:!0}),e=this.statEdit.$el.addClass(stats_entity_attrvalue_1.PdSDKPluginStatsEntityAttrValue.type);break;case stats_relation_attrvalue_1.PdSDKPluginStatsRelationAttrValue.type:this.statEdit=this.createStatItem(stats_relation_attrvalue_1.PdSDKPluginStatsRelationAttrValue.type,{editable:!0}),e=this.statEdit.$el.addClass(stats_relation_attrvalue_1.PdSDKPluginStatsRelationAttrValue.type);break;case stats_relation_attrname_1.PdSDKPluginStatsRelationAttrName.type:this.statEdit=this.createStatItem(stats_relation_attrname_1.PdSDKPluginStatsRelationAttrName.type,{editable:!0}),e=this.statEdit.$el.addClass(stats_relation_attrname_1.PdSDKPluginStatsRelationAttrName.type);break;case stats_entity_concept_1.PdSDKPluginStatsEntityConcept.type:this.statEdit=this.createStatItem(stats_entity_concept_1.PdSDKPluginStatsEntityConcept.type,{editable:!0}),e=this.statEdit.$el.addClass(stats_entity_concept_1.PdSDKPluginStatsEntityConcept.type)}this.statEdit.showEdit(),e&&this.$addForm.find(".pdsdk-stats-chart-add-form").append(e)}},e.prototype.updateRequest=function(t,e,a){var s=$.extend(!0,{ajaxSettings:this.settings.ajaxSettings,kgName:this.settings.kgName},this.settings.editSettings),i=s.ajaxSettings,n=i.queryData||{};n.kgName=s.kgName;var r=i.formData||{};r.id=t,r.type=e,r.rule=a;var l={url:i.baseUrl+"graph/stat/settings/update",type:"POST",el:this.container.$el[0],data:r};return l=$.extend(!0,{},l,i),l.url=utils_1.PdSDKUtils.buildUrl(l.url,n),utils_1.PdSDKUtils.ajax(l)},e.defaultSettings={side:"right",editable:!0,highlightTrigger:"click",highlightMode:"single",items:[stats_entity_attrvalue_1.PdSDKPluginStatsEntityAttrValue.type,stats_relation_attrvalue_1.PdSDKPluginStatsRelationAttrValue.type,stats_relation_attrname_1.PdSDKPluginStatsRelationAttrName.type,stats_entity_concept_1.PdSDKPluginStatsEntityConcept.type]},e}(plugin_1.PdSDKPlugin);exports.PdSDKPluginStatsChart=PdSDKPluginStatsChart;