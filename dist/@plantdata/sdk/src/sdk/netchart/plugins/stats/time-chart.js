"use strict";var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),echarts=require("echarts/lib/echarts");require("echarts/lib/chart/line"),require("echarts/lib/component/tooltip"),require("echarts/lib/component/grid"),require("echarts/lib/component/dataZoom"),require("echarts/lib/component/timeline");var lodash_1=require("lodash"),netchart_1=require("../../../../vis/netchart/netchart"),common_1=require("../../../../common/common"),utils_1=require("../../../../vis/utils/utils"),plugin_1=require("../plugin"),settings_1=require("../../../../icon/settings"),play_circle_outline_1=require("../../../../icon/play-circle-outline"),stop_circle_outline_1=require("../../../../icon/stop-circle-outline"),keyboard_arrow_up_1=require("../../../../icon/keyboard-arrow-up"),PdSDKPluginTimeChart=function(t){function e(e){var i=t.call(this,e)||this;return i.counts=[],i.end=null,i.eventList=[],i.start=null,i.times=[],i}return __extends(e,t),e.today=function(){var t=new Date,e=t.getMonth()+1+"";e.length<2&&(e=0+e);var i=t.getDate()+"";return i.length<2&&(i=0+i),t.getFullYear()+"-"+e+"-"+i},e.prototype.destroy=function(){this.container.deleteFilter(["time-chart-event"]),this.timeChart.dispose(),t.prototype.destroy.call(this)},e.prototype.getPluginType=function(){return"timeChart"},e.prototype.getSettings=function(){return this.timeFilterSettings},e.prototype.setSettings=function(t){this.timeFilterSettings=t,this.settingsPanel&&(this.settingsPanel.find('[name="'+this.namePrefix+'-node"][value="'+this.timeFilterSettings.nodesShowType+'"]').prop("checked",!0),this.settingsPanel.find('[name="'+this.namePrefix+'-from"]').val(this.timeFilterSettings.fromTime),this.settingsPanel.find('[name="'+this.namePrefix+'-to"]').val(this.timeFilterSettings.toTime))},e.prototype.bindEvent=function(){var e=this;t.prototype.bindEvent.call(this),this.buildEventsTimeRange(),this.rendererTimeChart(),this.addEvent("beforeload",function(){e.start=null,e.end=null}),this.addEvent("beforedraw",function(){e.buildEventsTimeRange(),e.rendererTimeChart()}),this.addEvent("resize",function(){e.timeChart.resize()}),this.select(".pdsdk-timechart-control").on("click",function(){e.$el.toggleClass("pdsdk-is-simple")}),this.select(".pdsdk-timechart-play").on("click",function(){e.$el.addClass("pdsdk-in-play"),e.showDynamicTimeChart()}),this.select(".pdsdk-timechart-stop").on("click",function(){e.$el.removeClass("pdsdk-in-play"),e.showStaticTimeChart()}),this.select(".pdsdk-timechart-settings").on("click",function(){e.settingsPanel.toggleClass("hide")}),this.settingsPanel.find(".pdsdk-btn-settings").on("click",function(){e.updateSettings()&&(e.container.reload(),e.settingsPanel.addClass("hide"))}),this.settingsPanel.find(".pdsdk-btn-settings-close").on("click",function(){e.settingsPanel.addClass("hide")}),this.addEvent("viewChange",function(t){e.timeChart.resize()},this.container,"resize"),this.addEvent("takeSnapshot",function(t){t.snapshot.timeChart={start:e.start,end:e.end,settings:lodash_1.cloneDeep(e.getSettings())}}),this.addEvent("restoreSnapshot",function(t){e.start=t.snapshot.timeChart.start,e.end=t.snapshot.timeChart.end,e.setSettings(lodash_1.cloneDeep(t.snapshot.timeChart.settings))})},e.prototype.buildEventsTimeRange=function(){var t=this.container.getAvailableData();if(t){for(var i=t.links,n=[],s=0,a=i;s<a.length;s++){var r=a[s];if(r.startTime&&r.startTime.length)for(var o=0,d=r.startTime;o<d.length;o++){var l=d[o],h=$.extend(!0,{},r),p=new Date(l);h.time=l,h.timestamp=p.getTime(),n.push(h)}else{var c=$.extend(!0,{},r);c.timestamp=0,n.push(c)}}this.eventList=n;var u=lodash_1.filter(this.eventList,function(t){return t.timestamp>0}),m=lodash_1.minBy(u,"timestamp");this.start||(this.start=m?m.time:e.today());var f=lodash_1.maxBy(u,"timestamp");this.end||(this.end=f?f.time:e.today())}},e.prototype.eventFilter=function(t){var e=this;if(t){var i=lodash_1.cloneDeep(t),n=[],s=[];if(this.start||this.end){t.links=lodash_1.filter(t.links,function(t){if(lodash_1.find(e.container.fixedLinks,function(e){return e.id===t.id}))return!0;if(t.startTime&&t.startTime.length){for(var i=!1,n=0,a=t.startTime;n<a.length;n++){var r=a[n];r>=e.start&&r<=e.end&&(i=!0)}return i||s.push(t.id),i}return!0});var a=lodash_1.uniq(lodash_1.flatMap(t.links,function(t){return[t.from,t.to]}));t.nodes=lodash_1.filter(t.nodes,function(t){var i=e.container.isFixedNode(t.id)||!!lodash_1.find(a,function(e){return netchart_1.PdVisNetChart.idEquals(e,t.id)});return i||n.push(t.id),i})}if("vague"===this.timeFilterSettings.nodesShowType)return this.container.clearReducedLink(),this.container.clearReducedNode(),this.container.setReducedNode(n),this.container.setReducedLink(s),i}return t},e.prototype.initSettings=function(i){return $.extend(!0,{},t.prototype.initSettings.call(this,e.defaultSettings),i)},e.prototype.initTemplate=function(){var t="事件统计",e="",i=settings_1["default"](20),n=play_circle_outline_1["default"](20),s=stop_circle_outline_1["default"](20),a=keyboard_arrow_up_1["default"](20),r=$('<div class="pdsdk-timechart-container pdsdk-is-simple">\n        <div class="pdsdk-timechart-controls">\n        <button class="pdsdk-timechart-settings pdui-btn pdui-btn-primary"\n         data-pdui-tooltip="hover" data-pdui-tooltip-position="top" title="设置">'+i+"\n        </button>\n        "+(this.settings.isShowPlay?'<span class="pdsdk-timechart-split"></span>\n        <button class="pdsdk-timechart-play pdui-btn pdui-btn-primary"\n         data-pdui-tooltip="hover" data-pdui-tooltip-position="top" title="开始播放">'+n+"\n        </button>":"")+'\n        <button class="pdsdk-timechart-stop pdui-btn pdui-btn-primary"\n         data-pdui-tooltip="hover" data-pdui-tooltip-position="top" title="停止播放">'+s+'\n        </button>\n        <span class="pdsdk-timechart-split"></span>\n        <button class="pdsdk-timechart-control pdui-btn pdui-btn-primary"\n         data-pdui-tooltip="hover" data-pdui-tooltip-position="top" title="收起/展开">'+a+'\n        </button>\n        </div>\n        <div class="pdsdk-timechart-chart-container">\n        <div class="pdsdk-timechart"></div>\n        </div>\n        </div>');this.namePrefix=common_1.PdCommonUtils.createId("pdvisSettingsModal-");var o=utils_1.PdVisUtils.buildCRHTML({id:this.namePrefix+"-hide-node",name:this.namePrefix+"-node",type:"radio",label:"隐藏节点",value:"hide"}),d=utils_1.PdVisUtils.buildCRHTML({id:this.namePrefix+"-vague-node",name:this.namePrefix+"-node",type:"radio",label:"虚化节点",value:"vague",checked:!0});return this.settingsPanel=$('<div class="pdsdk-settings-panel pdsdk-settings-timechart hide">\n                <div class="pdsdk-panel-head">\n                    设置\n                </div>\n                <div class="pdsdk-panel-body">\n                    <table>\n                        <tr>\n                            <td>\n                            <ul>\n                                <li>'+d+"</li>\n                                <li>"+o+'</li>\n                            </ul>\n                            </td>\n                        </tr>\n                        <tr class="time">\n                            <td>\n                            <div class="pdsdk-input-daterange">\n                            <input type="date" placeholder="开始时间" class="pdui-input pdui-input-sm" name="'+this.namePrefix+'-from">\n                            <div class="pdsdk-settings-date-split"></div>\n                            <input type="date" placeholder="截止时间" class="pdui-input pdui-input-sm" name="'+this.namePrefix+'-to">\n                            </div>\n                            <div class="pdsdk-settings-tip"></div>\n                            </td>\n                        </tr>\n                    </table>\n                    </div>\n                    <div class="pdsdk-panel-foot">\n                      <button class="pdui-btn pdui-btn-sm pdui-btn-primary-outline pdsdk-btn-settings-close">\n                        取消\n                      </button>\n                      <button class="pdui-btn pdui-btn-sm pdui-btn-primary pdsdk-btn-settings">\n                        确定\n                      </button>\n                    </div>\n                </div>'),this.updateSettings(),r.append(this.settingsPanel),this.buildPluginTemplate(r,e,t)},e.prototype.mounted=function(){var e=this;t.prototype.mounted.call(this),this.bindEvent(),this.container.setFilter({type:"time-chart-event",filter:function(t){return e.eventFilter(t)}}),setTimeout(function(){e.timeChart&&e.timeChart.resize()},300)},e.prototype.rendererTimeChart=function(){if(this.container.getAvailableData()){var t=lodash_1.countBy(this.eventList,"time"),e=[];for(var i in t)t.hasOwnProperty(i)&&"undefined"!==i&&e.push({key:i,value:t[i]});var n=lodash_1.orderBy(e,["key"],["asc"]);this.times=lodash_1.map(n,"key"),this.counts=lodash_1.map(n,"value"),this.$el.removeClass("pdsdk-in-play"),this.showStaticTimeChart()}},e.prototype.showDynamicTimeChart=function(){var t=this;this.timeChart&&this.timeChart.dispose();var e=this.select(".pdsdk-timechart");this.timeChart=echarts.init(e[0]);var i=this.settings.timelineSettings;i.timeline.data=this.times,this.timeChart.setOption(i),this.timeChart.on("timelinechanged",function(e){t.start=t.times[e.currentIndex],t.end=t.times[e.currentIndex],t.container.updateChart()})},e.prototype.showStaticTimeChart=function(){var t=this;this.timeChart&&this.timeChart.dispose();var e=this.select(".pdsdk-timechart");this.timeChart=echarts.init(e[0]);var i=this.settings.settings;i.xAxis[0].data=this.times,this.times.length&&(i.dataZoom[0].startValue=this.start||this.container.getData().computerTime||0,i.dataZoom[0].endValue=this.end||this.times.length-1),i.series[0].data=this.counts,this.timeChart.setOption(i),this.timeChart.on("datazoom",function(){var e=t.timeChart.getOption().dataZoom[0];t.start=t.times[e.startValue],t.end=t.times[e.endValue],clearTimeout(t.chartUpdateTimeout),t.chartUpdateTimeout=setTimeout(function(){t.container.updateChart()},t.settings.chartUpdateInterval)})},e.prototype.updateSettings=function(){this.timeFilterSettings||(this.timeFilterSettings={}),this.settingsPanel.find(".pdsdk-settings-tip:visible").eq(0).text(""),this.timeFilterSettings.fromTime="",this.timeFilterSettings.toTime=e.today();var t=this.settingsPanel.find('[name="'+this.namePrefix+'-from"]').val(),i=this.settingsPanel.find('[name="'+this.namePrefix+'-to"]').val();return t>i?(this.settingsPanel.find(".pdsdk-settings-tip:visible").eq(1).text("*开始时间不能大于结束时间"),!1):(this.settingsPanel.find(".pdsdk-settings-tip:visible").eq(1).text(""),this.timeFilterSettings.fromTime=t,this.timeFilterSettings.toTime=i,this.timeFilterSettings.nodesShowType=this.settingsPanel.find('[name="'+this.namePrefix+'-node"]:checked').val(),!0)},e.prototype.unbindEvent=function(){t.prototype.unbindEvent.call(this),this.select(".pdsdk-timechart-control").off("click"),this.select(".pdsdk-timechart-play").off("click"),this.select(".pdsdk-timechart-stop").off("click"),this.select(".pdsdk-timechart-settings").off("click"),this.settingsPanel.find(".pdsdk-btn-settings").off("click"),this.settingsPanel.find(".pdsdk-btn-settings-close").off("click"),this.settingsPanel.off("click",'tr:first-child [type="radio"]')},e.prototype.unknowEventEnable=function(t){return 0===t.timestamp||this.settings.unknowVisible},e.defaultSettings={side:"bottom",isFloat:!0,chartUpdateInterval:0,unknowVisible:!0,style:{top:"auto",right:"15px",bottom:"0",left:"15px"},settings:{color:[netchart_1.PdVisNetChart.primaryColor],tooltip:{trigger:"item"},grid:{left:"80px",right:"80px",top:"10px",bottom:"60px",containLabel:!0},xAxis:[{type:"category",boundaryGap:!1,interval:0}],yAxis:[{type:"value",splitLine:{show:!1},axisLabel:{show:!1},axisTick:{show:!1},axisLine:{show:!1}}],dataZoom:[{show:!0,realtime:!0,fillerColor:"rgba(0, 179, 138, 0.3)",labelFormatter:"{value}\n\n\n\n"}],series:[{name:"事件数量",type:"line",stack:"数量",symbolSize:5,areaStyle:{normal:{}}}]},timelineSettings:{timeline:{axisType:"category",autoPlay:!0,currentIndex:-1,playInterval:3e3,checkpointStyle:{color:netchart_1.PdVisNetChart.primaryColor,borderColor:"rgba(0,179,138,0.3)"},controlStyle:{emphasis:{color:netchart_1.PdVisNetChart.primaryColor,borderColor:netchart_1.PdVisNetChart.primaryColor}},label:{normal:{textStyle:{}},emphasis:{textStyle:{color:netchart_1.PdVisNetChart.primaryColor}}},itemStyle:{emphasis:{color:netchart_1.PdVisNetChart.primaryColor}}}}},e}(plugin_1.PdSDKPlugin);exports.PdSDKPluginTimeChart=PdSDKPluginTimeChart;