"use strict";var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),edit_item_1=require("../../../../../vis/utils/edit-item/edit-item"),utils_1=require("../../../../utils/utils"),stats_netchart_bar_tool_1=require("./stats-netchart-bar-tool"),common_1=require("../../../../../common/common"),PdSDKPluginStatsEntityAttrValue=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.showEdit=function(){this.settings.rule.conceptId&&this.updateAttsOptions(this.settings.rule.conceptId),t.prototype.showEdit.call(this)},e.prototype.activeBar=function(t){var e=this.settings.netChart.getAvailableData();if(e){var i=lodash_1.map(e.links,"id");this.settings.netChart.setReducedLink(i);var s=this.data[t].ids;if(s.length){for(var n=[],r=0,o=s;r<o.length;r++){var a=o[r];n.push(a.toString())}if(this.settings.netChart.setEmphasisNode(n),"single"===this.settings.highlightMode&&e.nodes){var l=this.settings.rule,d=lodash_1.map(lodash_1.filter(e.nodes,["classId",l.conceptId.toString()]),"id");this.settings.netChart.setLockedNode(lodash_1.xor(d,n))}}else{var d=lodash_1.map(e.nodes,"id");this.settings.netChart.setReducedNode(d)}}},e.prototype.bindEvent=function(){var e=this;t.prototype.bindEvent.call(this),this.addEvent("schemaUpdate",function(t){e.settings.schema=t.schema,e.updateConceptOptions()},this.settings.sdkNetChart),this.addEvent("beforedraw",function(){Object.keys(e.settings.rule).length&&(e.inactiveBar(),e.rendererData())},this.settings.netChart),this.$el.on("change",'[name="conceptId"]',function(){e.updateAttsOptions()})},e.prototype.buildRequest=function(){var t=this.settings.ajaxSettings,e=$.extend(!0,{size:6},t.formData);e.kgName=this.settings.kgName;var i=$.extend(!0,{},t.formData,{entityIds:this.getRelatedNodeIds(),attrId:this.settings.rule.xAxis,isMerge:this.settings.rule.isMerge,returnType:1}),s={url:t.baseUrl+"graph/stat/entity/count/group/by/attrvalue",type:"POST",el:this.$el[0],data:i};return s=$.extend(!0,{},s,t),s.url=utils_1.PdSDKUtils.buildUrl(s.url,e),s},e.prototype.createTitle=function(){var t=this.settings.rule.conceptId,e=lodash_1.find(this.settings.schema.types,["k",t.toString()]);if(e){var i=lodash_1.find(this.getAtts(t.toString()),["value",this.settings.rule.xAxis.toString()]),s=lodash_1.find(this.settings.yAxisOptions,["value",this.settings.rule.yAxis.toString()]);return e.v+(i?i.label:"")+"的"+(s?s.label:"")+"统计"}return"错误的配置"},e.prototype.createEditForm=function(){var e=edit_item_1.PdVisEditItem.createSelect({key:"isMerge",options:{"true":"合并","false":"不合并"}}),i='<div class="pdsdk-stats-chart-edit-merge"><label>按范围自动合并:</label>'+e+"</div>",s=t.prototype.createEditForm.call(this).addClass("pdsdk-stats-entity-attrvalue");return s.find(".pdsdk-stats-chart-edit-form").append(i),s},e.prototype.createXSelect=function(){this.settings.xAxisOptions=[];var t=edit_item_1.PdVisEditItem.createSelect({key:"conceptId",options:[]}),e=edit_item_1.PdVisEditItem.createSelect({key:"xAxis",options:[]});return t+e},e.prototype.getAtts=function(t){for(var e=lodash_1.filter(this.settings.schema.atts,function(e){return e.domain.toString()===t&&0===e.type}),i=[],s=0,n=e;s<n.length;s++){var r=n[s];i.push({value:r.k.toString(),label:r.v})}return i.length||common_1.PdCommonUtils.error("选择概念不存在可以统计的数值属性"),i},e.prototype.getRelatedNodeIds=function(){for(var t=this.settings.netChart.getData(),e=t?t.nodes:[],i=[],s=0,n=e;s<n.length;s++){var r=n[s];r.classId===this.settings.rule.conceptId.toString()&&i.push(r.id)}return i},e.prototype.initSettings=function(i){var s=$.extend(!0,{},t.prototype.initSettings.call(this,e.defaultSettings),i);return s.rule&&(s.rule.attrId&&(s.rule.xAxis=s.rule.attrId),s.rule.yAxis||(s.rule.yAxis=s.yAxisOptions[0].value),void 0!==s.rule.isMerge&&(s.rule.isMerge=s.rule.isMerge.toString())),s},e.prototype.mounted=function(){this.updateConceptOptions(),t.prototype.mounted.call(this)},e.prototype.unbindEvent=function(){t.prototype.unbindEvent.call(this),this.$el.off("change",'[name="conceptId"]')},e.prototype.updateAttsOptions=function(t){void 0===t&&(t=this.select('[name="conceptId"]').val());var e=this.select('[name="xAxis"]').empty();if(t){var i=this.getAtts(t.toString());this.settings.xAxisOptions=i;for(var s="",n=0,r=i;n<r.length;n++){var o=r[n];s+='<option value="'+o.value+'">'+o.label+"</option>"}e.html(s)}},e.prototype.updateConceptOptions=function(){var t=[{value:"",label:""}].concat(lodash_1.map(this.settings.schema.types,function(t){return{value:t.k.toString(),label:t.v}})),e=edit_item_1.PdVisEditItem.createSelect({key:"conceptId",options:t});this.select('[name="conceptId"]').replaceWith(e),this.updateAttsOptions()},e.defaultSettings={highlightMode:"single"},e.type="statsEntityAttrValue",e.typeName="计算节点的数值属性",e}(stats_netchart_bar_tool_1.PdSDKPluginStatsNetChartBarTool);exports.PdSDKPluginStatsEntityAttrValue=PdSDKPluginStatsEntityAttrValue;