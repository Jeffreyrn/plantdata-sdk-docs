"use strict";var __extends=this&&this.__extends||function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};return function(e,n){function a(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(a.prototype=n.prototype,new a)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),plugins_1=require("../../../../vis/netchart/plugins"),utils_1=require("../../../utils"),PdSDKPluginMapx=function(t){function e(e){var n=t.call(this,e)||this;return n.client={x:0,y:0},n.isMapx=!1,n.mapxCacheMap={},n}return __extends(e,t),e.prototype.getPluginType=function(){return"mapx"},e.prototype.bindEvent=function(){var e=this;t.prototype.bindEvent.call(this),$(this.settings.chartSettings.selector).on("mousemove",function(t){e.client={x:t.clientX-$(t.currentTarget).offset().left,y:t.clientY-$(t.currentTarget).offset().top}}),this.mapxInterval=setInterval(function(){var t=e.container.chart.zoom();if(e.zoomValue!==t)e.zoomValue=t,e.isZoomChanged||(e.baseZoomValue=t),e.isZoomChanged=!0;else if(e.isZoomChanged){e.isZoomChanged=!1;var n=e.getNode(),a=e.container.chart.getNode(n.id),i=a.radius*t;i<=e.settings.min&&e.isMapx?(e.isMapx=!1,e.recoverData()):i>=e.settings.max&&!e.isMapx&&(e.isMapx=!0,function(){return e.mapxCacheMap[n.id]?Promise.resolve(e.mapxCacheMap[n.id]):e.loadExtraData(n).then(function(t){return e.mapxCacheMap[n.id]=t,Promise.resolve(t)})}().then(function(t){e.originalData=e.container.getData(),lodash_1.map(t.nodes,function(t){t.id=t.id.toString()}),lodash_1.map(t.links,function(t){t.id=t.id.toString()}),e.settings.isMerge&&(t.nodes=lodash_1.uniqBy(lodash_1.concat(t.nodes,e.originalData.nodes),"id"),t.links=lodash_1.uniqBy(lodash_1.concat(t.links,e.originalData.links),"id")),t=lodash_1.pick(t,["nodes","links"]),e.container.chart.replaceData(t)}))}},300)},e.prototype.initSettings=function(t){return $.extend(!0,{},e.defaultSettings,t)},e.prototype.initTemplate=function(){var t=$('<div class="pdsdk-mapx"></div>');return t.appendTo(this.settings.parent),t},e.prototype.getNode=function(){var t,e=this,n=9999999;return lodash_1.map(this.container.chart.nodes(),function(a){var i=Math.pow(Math.pow(e.client.x-a.shape.x,2)*Math.pow(e.client.y-a.shape.y,2),.5);n>i&&(n=i,t=a)}),t.data},e.prototype.loadExtraData=function(t){var e=this.settings.ajaxSettings;return e.queryData.kgName=this.settings.kgName,this.settings.handleParams&&(e=this.settings.handleParams(e,t)),e.url=utils_1.PdSDKUtils.buildUrl(e.url,e.queryData),utils_1.PdSDKUtils.ajax(e)},e.prototype.mounted=function(){t.prototype.mounted.call(this),this.bindEvent()},e.prototype.recoverData=function(){this.container.chart.replaceData(this.originalData)},e.defaultSettings={ajaxSettings:{url:"plantdata_sdk/api/grpah",type:"POST",queryData:{},data:{}},isMerge:!0,max:25,min:15},e}(plugins_1.PdVisPlugin);exports.PdSDKPluginMapx=PdSDKPluginMapx;