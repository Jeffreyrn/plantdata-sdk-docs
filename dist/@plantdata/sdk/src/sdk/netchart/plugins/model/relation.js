"use strict";var __extends=this&&this.__extends||function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};return function(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),common_1=require("../../../../common/common"),prompt_1=require("../../../prompt/prompt"),plugin_1=require("../plugin"),close_1=require("../../../../icon/close"),bubble_chart_1=require("../../../../icon/bubble-chart"),PdSDKPluginRelation=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.getLoadParams=function(){var t=this.getRelationNodes();if(t.length>1){var e={id:lodash_1.flatMap(t,function(t){return t.id}).join(",")};return e.nodes=t,e.$type="relation",e}return common_1.PdCommonUtils.error("分析对象不能少于两个"),null},e.prototype.getPluginType=function(){return"relation"},e.prototype.addRelationNode=function(t){if(this.inRelationNodes(t))return void common_1.PdCommonUtils.error("该对象已添加");if(t.name){var e=t.name;t.meaningTag&&(e+="["+t.meaningTag+"]");var n=close_1["default"](20),i=$('<li title="'+e+'">'+e+n+"</li>").data("data",t);this.select(".pdsdk-relation-data-container ul").append(i)}},e.prototype.bindEvent=function(){var e=this;t.prototype.bindEvent.call(this),this.setRelationInfo(),this.addEvent("beforedraw",function(){var t=e.container.loadParams.$source;"dblClick"!==t&&"merge"!==t&&e.setRelationInfo()}),this.select(".pdsdk-relation-preview .pdsdk-relation-btn-preview").on("click",function(){var t=e.getLoadParams();t&&e.container.load(t,"api-relation")}),this.select(".pdsdk-relation-data-container").on("click","li svg",function(t){$(t.target).closest("li").remove()})},e.prototype.getRelationNodes=function(){var t=[];return this.select(".pdsdk-relation-data-container ul").children("li").each(function(e,n){t.push($(n).data("data"))}),t},e.prototype.initSettings=function(n){return $.extend(!0,{},t.prototype.initSettings.call(this,e.defaultSettings),n)},e.prototype.initTemplate=function(){var t="关联分析",e=bubble_chart_1["default"](20),n='<div class="pdsdk-relation"><div class="pdsdk-relation-prompt-container"><div class="pdsdk-relation-label">添加对象：</div><div class="pdsdk-relation-prompt"></div></div><div class="pdsdk-relation-data-container"><div class="pdsdk-relation-data-title">分析对象</div><ul></ul><div class="pdsdk-relation-tip">请添加两个以上您要分析的对象,<br/>然后点击“预览”</div></div><div class="pdsdk-relation-preview"><button class="pdui-btn pdui-btn-primary pdsdk-relation-btn-preview">分析</button></div></div>';return this.buildPluginTemplate(n,e,t)},e.prototype.inRelationNodes=function(t){var e=this.getRelationNodes();return!!lodash_1.find(e,["id",t.id])},e.prototype.mounted=function(){var e=this;t.prototype.mounted.call(this);var n={autocompleteSettings:{theme:"normal",size:"sm",placeholder:"请添加分析对象",onSearch:function(t,n){n.find('input[type="text"]').val(""),e.addRelationNode(t)}}},i=$.extend(!0,{},n,this.settings.promptSettings);i.selector=".pdsdk-relation-prompt",this.relationPrompt=new prompt_1.PdSDKPrompt(i),this.bindEvent()},e.prototype.setRelationInfo=function(){this.select(".pdsdk-relation-data-container ul").empty();var t=this.container,e=t.loadParams;if(e){if(e.nodes)for(var n=0,i=e.nodes;n<i.length;n++){var o=i[n];this.addRelationNode(o)}e.id=e.id||common_1.PdCommonUtils.createId("relation-")}},e.prototype.unbindEvent=function(){t.prototype.unbindEvent.call(this),this.select(".pdsdk-relation-preview .pdsdk-relation-btn-preview").off("click"),this.select(".pdsdk-relation-data-container").off("click","li svg"),this.select(".pdsdk-relation-data-container").off("mouseenter","li"),this.select(".pdsdk-relation-data-container").off("mouseleave","li")},e.defaultSettings={side:"left",promptSettings:{autocompleteSettings:{size:"md",theme:"normal"}}},e}(plugin_1.PdSDKPlugin);exports.PdSDKPluginRelation=PdSDKPluginRelation;