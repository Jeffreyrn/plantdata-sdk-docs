"use strict";var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),common_1=require("../../../../common/common"),form_1=require("../../../../ui/components/form/form"),editor_define_1=require("./editor-define"),tag_prompt_1=require("../../../utils/tag-prompt/tag-prompt"),dialog_1=require("../../../../vis/utils/modal/dialog/dialog"),edit_item_1=require("../../../../vis/utils/edit-item/edit-item"),close_circle_1=require("../../../../icon/close-circle"),mode_edit_1=require("../../../../icon/mode-edit"),PdSDKEditorDefineRelation=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.destroy=function(){this.addPromptTag.destroy(),this.editPromptTag.destroy(),t.prototype.destroy.call(this)},e.prototype.getAttributeTr=function(t){var e=close_circle_1["default"](20,{"class":"pdsdk-editor-define-attribute-list-delete"}),i=mode_edit_1["default"](20,{"class":"pdsdk-editor-define-attribute-list-edit"}),r=t[this.settings.rangeKey]?t[this.settings.rangeKey].split(" "):[],d=lodash_1.filter(this.settings.schema.types,function(t){return lodash_1.indexOf(r,t.k.toString())>=0}),n="";return d&&d.length&&(n=lodash_1.map(d,"v").join("、")),'<tr data-id="'+t[this.settings.key]+'">\n                        <td class="pdsdk-editor-define-attribute-table-text pdsdk-editor-define-attribute-attr-name">\n                            '+t.name+'\n                        </td>\n                        <td title="'+n+'"\n                         class="pdsdk-editor-define-attribute-table-text pdsdk-editor-define-attribute-type">\n                            '+n+'\n                        </td>\n                        <td class="pdsdk-editor-define-attribute-operation center">\n                            '+i+"\n                            "+e+"\n                        </td>\n                    </tr>"},e.prototype.updateSchemaFun=function(t,e,i){},e.prototype.bindEvent=function(){var e=this;t.prototype.bindEvent.call(this),this.$attributeList.on("click",".pdsdk-editor-define-attribute-list-edit",function(t){var i=$(t.currentTarget).closest("tr").attr("data-id");e.editData=lodash_1.find(e.attributeListData,function(t){return t[e.settings.key].toString()===i.toString()});for(var r=e.editData[e.settings.rangeKey]?e.editData[e.settings.rangeKey].split(" "):[],d=[],n=function(t){var i=lodash_1.find(e.settings.schema.types,function(e){return e.k.toString()===t});i&&d.push({id:i.k,name:i.v})},a=0,o=r;a<o.length;a++){var s=o[a];n(s)}e.editPromptTag.setData(d)}),this.addDialog.$el.on("change",".pdsdk-editor-define-attribute-table-select",function(t){var e=$(t.currentTarget).val().toString(),i=$(t.currentTarget).closest(".pdsdk-editor-define-attribute-table-type").siblings(".pdsdk-editor-define-attribute-table-dataUnit").find("input");"1"===e||"2"===e?i.prop("disabled",!1):i.val("").prop("disabled",!0)}),this.editDialog.$el.on("change",".pdsdk-editor-define-attribute-table-select",function(t){var i=$(t.currentTarget).val().toString();"1"===i||"2"===i?e.editDialog.$el.find('input[name="dataUnit"]').prop("disabled",!1):e.editDialog.$el.find('input[name="dataUnit"]').val("").prop("disabled",!0)})},e.prototype.createEditDialogSettings=function(){for(var t=this,e="",i=this.getEditFormSettings(),r=0,d=i;r<d.length;r++){var n=d[r];e+=edit_item_1.PdVisEditItem.gentEditItem(n)}return{cls:"pdsdk-editor-define-relation-edit-dialog pdsdk-editor-common-dialog",title:this.settings.title,body:e,positiveClick:function(){var e=form_1.PdUIForm.getFormData(t.editDialog.$el),i=t.editPromptTag.getData()||[];return e[t.settings.rangeKey]=lodash_1.map(i,"id").join(" "),e=$.extend(!0,{},t.editData,e),e.name&&e[t.settings.rangeKey]?t.updateAttribute(e).then(function(i){common_1.PdCommonUtils.success("修改成功");for(var r=0;r<t.attributeListData.length;r++)t.attributeListData[r][t.settings.key].toString()===e[t.settings.key].toString()&&(t.attributeListData[r]=e);t.$attributeList.find("tr[data-id="+e[t.settings.key]+"]").empty().append($(t.getAttributeTr(e)).find("td"))}):(common_1.PdCommonUtils.error(""),Promise.reject({}))}}},e.prototype.mounted=function(){var t=this;this.drawAttributeListContainer(this.settings.sdkNetChart.settings.selector);var e=this.createEditDialogSettings();if(e){this.editDialog=new dialog_1.PdVisDialog(e);var i=this.editDialog.$el.find(".pdsdk-editor-define-relation-prompt"),r=$.extend(!0,{},{kgName:this.settings.kgName,autocompleteSettings:{placeholder:"值域"},ajaxSettings:this.settings.ajaxSettings},this.settings.editPromptSettings);this.editPromptTag=new tag_prompt_1.PdSDKTagPrompt({size:"sm",data:[],labelKey:"name",valueKey:"id",selector:i,beforeAdd:function(t){return Promise.resolve(t)},beforeDelete:function(t){return Promise.resolve(t)},promptSettings:r}),e.cls="pdsdk-editor-define-relation-add-dialog pdsdk-editor-common-dialog",e.buttons=[{settings:{type:"primary",size:"sm",cls:"pdvis-modal-add-more",html:"继续添加"},events:{click:function(e){var i=form_1.PdUIForm.getFormData(t.addDialog.$el),r=t.addPromptTag.getData()||[];return i[t.settings.rangeKey]=lodash_1.map(r,"id").join(" "),i&&i.name&&i[t.settings.rangeKey]?t.addAttribute(i).then(function(e){return t.updateSchemaFun(e,i,r),common_1.PdCommonUtils.success("添加成功"),form_1.PdUIForm.setFormData(t.addDialog.$el,{name:"",isFunctional:"0"}),t.addPromptTag.setData([]),i[t.settings.key]=e,t.attributeListData.push(i),t.$attributeList.find(".pdsdk-editor-define-attribute-num").text(t.attributeListData.length),1===t.attributeListData.length?t.$attributeList.find(".pdsdk-editor-define-attribute-list tbody").html(t.getAttributeTr(i)):t.$attributeList.find(".pdsdk-editor-define-attribute-list tbody").append(t.getAttributeTr(i)),Promise.resolve(i)}):(common_1.PdCommonUtils.error("必填项必填"),Promise.reject("必填项必填"))}}}],e.positiveClick=function(){var e=form_1.PdUIForm.getFormData(t.addDialog.$el),i=t.addPromptTag.getData()||[];return e[t.settings.rangeKey]=lodash_1.map(i,"id").join(" "),e&&e.name&&e[t.settings.rangeKey]?t.addAttribute(e).then(function(r){return form_1.PdUIForm.setFormData(t.addDialog.$el,{name:"",isFunctional:"0"}),t.addPromptTag.setData([]),t.updateSchemaFun(r,e,i),common_1.PdCommonUtils.success("关系添加成功"),e[t.settings.key]=r,t.attributeListData.push(e),t.$attributeList.find(".pdsdk-editor-define-attribute-num").text(t.attributeListData.length),1===t.attributeListData.length?t.$attributeList.find(".pdsdk-editor-define-attribute-list tbody").html(t.getAttributeTr(e)):t.$attributeList.find(".pdsdk-editor-define-attribute-list tbody").append(t.getAttributeTr(e)),Promise.resolve(e)}):(common_1.PdCommonUtils.error("必填项必填"),Promise.reject("必填项必填"))},this.addDialog=new dialog_1.PdVisDialog(e);var d=this.addDialog.$el.find(".pdsdk-editor-define-relation-prompt"),n=$.extend(!0,{},{kgName:this.settings.kgName,autocompleteSettings:{placeholder:"值域"},ajaxSettings:this.settings.ajaxSettings},this.settings.addPromptSettings);this.addPromptTag=new tag_prompt_1.PdSDKTagPrompt({size:"sm",data:[],labelKey:"name",valueKey:"id",selector:d,beforeAdd:function(t){return Promise.resolve(t)},beforeDelete:function(t){return Promise.resolve(t)},promptSettings:n});var a=this.addDialog.$el.find(".pdvis-edit-item").eq(0);"定义域"===a.find(".pdvis-edit-item-label").text()&&a.addClass("hide")}this.bindEvent()},e.prototype.unbindEvent=function(){t.prototype.unbindEvent.call(this),this.addDialog.$el.off("change",".pdsdk-editor-define-attribute-table-select"),this.editDialog.$el.off("change",".pdsdk-editor-define-attribute-table-select")},e.defaultPromptSettings={promptType:"100"},e.defaultSettings={},e}(editor_define_1.PdSDKEditorDefine);exports.PdSDKEditorDefineRelation=PdSDKEditorDefineRelation;