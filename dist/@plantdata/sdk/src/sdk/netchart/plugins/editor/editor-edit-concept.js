"use strict";var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),form_1=require("../../../../ui/components/form/form"),common_1=require("../../../../common/common"),utils_1=require("../../../utils/utils"),tag_prompt_1=require("../../../utils/tag-prompt/tag-prompt"),edit_item_1=require("../../../../vis/utils/edit-item/edit-item"),editor_edit_entity_1=require("./editor-edit-entity"),mode_edit_1=require("../../../../icon/mode-edit"),PdSDKEditorEditConcept=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.addParent=function(t){var e=this.settings.ajaxSettings,i=e.queryData||{},n=e.formData||{};i.kgName=this.settings.kgName,n.conceptId=this.data.id,n.parentIds=t.id,delete n.parentId,delete n.parent;var a={url:e.baseUrl+"concept/add/parent",type:"POST",data:n};return a=$.extend(!0,{},a,e,this.settings.addParentSettings),a.url=utils_1.PdSDKUtils.buildUrl(a.url,i),utils_1.PdSDKUtils.ajax(a)},e.prototype.deleteParent=function(t){var e=this.settings.ajaxSettings,i=e.queryData||{},n=e.formData||{};i.kgName=this.settings.kgName,n.conceptId=this.data.id,n.parentId=t.id,delete n.parent;var a={url:e.baseUrl+"concept/delete/parent",type:"POST",data:n};return a=$.extend(!0,{},a,e,this.settings.deleteParentSettings),a.url=utils_1.PdSDKUtils.buildUrl(a.url,i),utils_1.PdSDKUtils.ajax(a)},e.prototype.destroy=function(){this.sonsPromptTag.destroy(),t.prototype.destroy.call(this)},e.prototype.updateStatusBySelection=function(t,e,i){if(1===t.length&&0===e.length){var n=t[0];1===n.type?(this.updateStatus(!1),this.updateVisibility(!1)):0===n.type&&(this.data=n,this.updateVisibility(!0),this.updateStatus("0"!==t[0].id.toString()))}else this.updateStatus(!1),this.updateVisibility(!1)},e.prototype.updateAbstract=function(t){var e=this.settings.ajaxSettings,i=e.queryData||{},n=e.formData||{};i.kgName=this.settings.kgName,n=$.extend(!0,{},t),n.conceptId=this.data.id;var a={url:e.baseUrl+"concept/update/abstract",type:"POST",data:n};return a=$.extend(!0,{},a,e,this.settings.updateAbstractSettings),a.url=utils_1.PdSDKUtils.buildUrl(a.url,i),utils_1.PdSDKUtils.ajax(a)},e.prototype.updateNameAndMeaningTag=function(t){var e=this.settings.ajaxSettings,i=e.queryData||{},n=e.formData||{};i.kgName=this.settings.kgName,n=$.extend(!0,{},t),n.conceptId=this.data.id;var a={url:e.baseUrl+"concept/update/nameAndMeaningTag",type:"POST",data:n};return a=$.extend(!0,{},a,e,this.settings.nameAndMeaningTagSettings),a.url=utils_1.PdSDKUtils.buildUrl(a.url,i),utils_1.PdSDKUtils.ajax(a)},e.prototype.addChild=function(t){var e=this.settings.ajaxSettings,i=e.queryData||{},n=e.formData||{};i.kgName=this.settings.kgName,n.conceptId=this.data.id,n.childId=t.id,delete n.parentId,delete n.parent;var a={url:e.baseUrl+"concept/add/child",type:"POST",data:n};return a=$.extend(!0,{},a,e,this.settings.addChildSettings),a.url=utils_1.PdSDKUtils.buildUrl(a.url,i),utils_1.PdSDKUtils.ajax(a)},e.prototype.bindDialogEvent=function(){var e=this;this.editDialog.$el.find(".pdvis-edit-item").on("blur",'input[name="name"]',function(t){if($(t.currentTarget).hasClass("pdsdk-editor-change")){var i=$(t.currentTarget).val(),n=e.editDialog.$el.find(".pdvis-edit-item").find('input[name="meaningTag"]').val();if(i)return e.updateNameAndMeaningTag({name:i,meaningTag:n}).then(function(n){e.data.name=i,e.updateNode(e.settings.netChart,e.data),common_1.PdCommonUtils.success("概念名称修改成功"),$(t.currentTarget).removeClass("pdsdk-editor-change")});common_1.PdCommonUtils.error("概念名不能为空")}}),t.prototype.bindDialogEvent.call(this)},e.prototype.createEditDialogSettings=function(){for(var t="",i=0,n=e.editFormSettings;i<n.length;i++){var a=n[i];t+=edit_item_1.PdVisEditItem.gentEditItem(a)}return{cls:"pdsdk-editor-edit-entity-dialog pdsdk-editor-common-dialog",title:'概念"<span class="pdsdk-editor-concept-name"></span>"'+this.settings.title,body:t,positiveClick:function(){return Promise.resolve({})}}},e.prototype.deleteChild=function(t){var e=this.settings.ajaxSettings,i=e.queryData||{},n=e.formData||{};i.kgName=this.settings.kgName,n.conceptId=this.data.id,n.childId=t.id,delete n.parent;var a={url:e.baseUrl+"concept/delete/child",type:"POST",data:n};return a=$.extend(!0,{},a,e,this.settings.deleteChildSettings),a.url=utils_1.PdSDKUtils.buildUrl(a.url,i),utils_1.PdSDKUtils.ajax(a)},e.prototype.getConceptDetail=function(){var t=this.settings.ajaxSettings,e=t.queryData||{};e.kgName=this.settings.kgName,e.conceptId=this.data.id;var i={url:t.baseUrl+"concept/get",type:"GET"};return i=$.extend(!0,{},i,t,this.settings.conceptDetailSettings),i.url=utils_1.PdSDKUtils.buildUrl(i.url,e),utils_1.PdSDKUtils.ajax(i)},e.prototype.initPrompts=function(){var e=this;t.prototype.initPrompts.call(this);var i=this.editDialog.$el.find(".pdsdk-editor-edit-concept-sons-prompt"),n=$.extend(!0,{},{kgName:this.settings.kgName,ajaxSettings:this.settings.ajaxSettings},this.settings.childPromptSettings);this.sonsPromptTag=new tag_prompt_1.PdSDKTagPrompt({size:"sm",data:this.sons,labelKey:"name",valueKey:"id",selector:i,beforeAdd:function(t){return e.addChild(t).then(function(i){common_1.PdCommonUtils.success("子概念添加成功");var n=lodash_1.find(e.settings.netChart.getData().nodes,function(e){return e.id.toString()===t.id.toString()});if(n){var a={id:common_1.PdCommonUtils.createId(),from:t.id.toString(),to:e.data.id.toString()};e.addLink(e.settings.netChart,a)}return Promise.resolve(t)})},beforeDelete:function(t){return e.deleteChild(t).then(function(i){common_1.PdCommonUtils.success("子概念删除成功");var n=lodash_1.find(e.settings.netChart.getData().links,function(i){return i.from.toString()===t.id.toString()&&i.to.toString()===e.data.id.toString()||i.to.toString()===t.id.toString()&&i.from.toString()===e.data.id.toString()});return n&&e.deleteLink(e.settings.netChart,n),Promise.resolve(i)})},promptSettings:n})},e.prototype.initSettings=function(i){var n=$.extend(!0,{},e.defaultSettings);return n.parentPromptSettings.ajaxSettings=$.extend(!0,{},i.ajaxSettings,n.parentPromptSettings.ajaxSettings),n.childPromptSettings.ajaxSettings=$.extend(!0,{},i.ajaxSettings,n.childPromptSettings.ajaxSettings),$.extend(!0,{},t.prototype.initSettings.call(this,n),i)},e.prototype.onClick=function(t){var e=this;this.editDialog.$el.find(".pdsdk-editor-concept-name").text(this.data.name),this.getConceptDetail().then(function(t){e.pars=t.pars||[],e.sons=t.sons||[],form_1.PdUIForm.setFormData(e.editDialog.$el,t)}),this.showEdit({},t)},e.prototype.updateImage=function(t){var e=this.settings.ajaxSettings,i=e.queryData||{},n=e.formData||{};i.kgName=this.settings.kgName,i.id=this.data.id,n=$.extend(!0,{},t);var a={url:e.baseUrl+"general/add/imageUrl",type:"POST",data:n};return a=$.extend(!0,{},a,e,this.settings.updateImageUrlSettings),a.url=utils_1.PdSDKUtils.buildUrl(a.url,i),utils_1.PdSDKUtils.ajax(a)},e.defaultPromptSettings={promptType:"100"},e.defaultSettings={cls:["pd-btn-float"],name:"editConcept",title:"编辑",disabled:!0,visible:!1,icon:mode_edit_1["default"](20),parentPromptSettings:e.defaultPromptSettings,childPromptSettings:e.defaultPromptSettings},e.editFormSettings=[{type:"input",key:"name",label:"概念名称",mode:"label",required:!0},{type:"input",key:"meaningTag",label:"消歧标识",mode:"label"},{type:"textarea",key:"abs",label:"描述",mode:"label"},{type:"input",key:"imageUrl",label:"图片",mode:"label"}],e}(editor_edit_entity_1.PdSDKEditorEditEntity);exports.PdSDKEditorEditConcept=PdSDKEditorEditConcept;