"use strict";var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),find_1=require("../../vis/netchart/plugins/find/find"),history_1=require("./plugins/history/history"),node_legend_1=require("../../vis/netchart/plugins/legend/node-legend/node-legend"),schema_1=require("../schema/schema"),utils_1=require("../utils/utils"),common_1=require("../../common/common"),event_1=require("../../core/event"),advanced_prompt_1=require("./plugins/prompt/advanced-prompt"),mixins_1=require("./plugins/mixins/mixins"),mapx_1=require("./plugins/mapx/mapx"),link_legend_1=require("../../vis/netchart/plugins/legend/link-legend/link-legend"),editor_1=require("./plugins/editor/editor"),reset_layout_1=require("../../vis/netchart/plugins/reset-layout/reset-layout"),tree_1=require("../../vis/netchart/view/tree"),data_1=require("./view/data"),word_cloud_1=require("./view/word-cloud"),vis_configure_1=require("./plugins/vis-configure/vis-configure"),infobox_1=require("./plugins/infobox/infobox"),contextmenu_1=require("./plugins/contextmenu/contextmenu"),snapshot_1=require("../../vis/netchart/plugins/snapshot/snapshot"),filter_1=require("./plugins/filter/filter"),PdSDKNetChart=function(t){function e(e,i){var n=t.call(this)||this;return n.defaultType="graph",n.isInit=!1,n.NetChart=e,n.settings=n.initSettings(i),n.initPrepareList={},n.init(),n}return __extends(e,t),e.transformNetChartData=function(t,e,i){t.nodes=t.nodes||t.entityList,t.links=t.links||t.relationList,delete t.entityList,delete t.relationList;for(var n=0,s=t.nodes;n<s.length;n++){var a=s[n];0===a.type&&(a.classId=0),a.typeName=a.typeName||e[a.classId]}for(var r=0,o=t.links;r<o.length;r++){var d=o[r];d.attName=d.attName||i[d.attId]}return t},e.orderRelation=function(t,e){void 0===e&&(e="desc");var i={},n=lodash_1.countBy(t,"from"),s=lodash_1.countBy(t,"to");for(var a in n)n.hasOwnProperty(a)&&(i[a]=(i[a]||0)+(s[a]||0)+n[a]);for(var r in s)s.hasOwnProperty(r)&&(i[r]=(i[r]||0)+(n[r]||0)+s[r]);var o=[];for(var d in i)i.hasOwnProperty(d)&&o.push({k:d,v:i[d]});return lodash_1.orderBy(o,"v",e)},e.prototype.destroy=function(){this.destroyPlugins(),this.destroyMixins(),this.unbindEvent(),this.netChart.$el.removeAttr("data-infobox-position"),this.netChart.destroy()},e.prototype.getNetChart=function(){return this.netChart},e.prototype.getInstance=function(){return this},e.prototype.load=function(t,e){var i=this;void 0===e&&(e="api"),setTimeout(function(){i.isInit?t?i.netChart.load(t,e):i.graphInit():i.load(t)},30)},e.prototype.initNetChartSettings=function(t){var e=this,i={ajaxSettings:t.ajaxSettings,kgName:t.kgName},n=t.infoboxSettings||{enable:!0};if(!t.infoboxSettings||n.enable){var s={imgBuilder:utils_1.PdSDKUtils.imgBuilder,ajaxSettings:{formData:{isRelationAtts:!0}}};s=$.extend(!0,{},i,s,n.settings),n.settings=utils_1.PdSDKUtils.updateUrl(s,n.settings),t.infoboxSettings=n}var a={};a=$.extend(!0,{},i,a,t.loaderSettings),t.loaderSettings=utils_1.PdSDKUtils.updateUrl(a,t.loaderSettings);var r={};r=$.extend(!0,{},i,r,t.promptSettings),t.promptSettings=utils_1.PdSDKUtils.updateUrl(r,t.promptSettings);var o={};o=$.extend(!0,{},i,o,t.initSettings),t.initSettings=utils_1.PdSDKUtils.updateUrl(o,t.initSettings);var d={selector:t.selector,loader:this.loader(t.loaderSettings),main:{extend:!1},beforeAddNewData:function(t,i){return e.dealGraphData(t)}};return t.netChartSettings=$.extend(!0,{},d,t.netChartSettings),t},e.prototype.updateLegendData=function(){var t=this.settings,e=null;this.linkLegend&&t.linkLegend.settings&&(e=t.linkLegend.settings.data),e=this.buildLinkLegendData(e),this.netChart.updateLinkLegend(e);var i=null;this.nodeLegend&&t.nodeLegend.settings&&(i=t.nodeLegend.settings.data),i=this.buildNodeLegendData(i),this.netChart.updateNodeLegend(i),this.netChart.updateChart()},e.prototype.updateSchema=function(t){this.schema=t,this.dispatch("schemaUpdate",{schema:this.schema}),this.updateLegendData()},e.prototype.loadParamsUpdate=function(t){this.updateFixedNodes()},e.prototype.bindEvent=function(){var t=this;this.addEvent("viewChange",function(e){t.dispatch("viewChange",{from:e.from.data.type,to:e.to.data.type})},this.netChart),this.addEvent("nodeDblClick",function(e){t.nodeDblClick(e.node)},this.netChart),this.addEvent("loadParamsUpdate",function(e){t.loadParamsUpdate(e)},this.netChart)},e.prototype.buildLoaderParams=function(t){return{queryData:{},formData:{},url:""}},e.prototype.buildGraphLoaderParams=function(t){t.$type="graph";var e=this.settings.loaderSettings.ajaxSettings,i=$.extend({kgName:this.settings.loaderSettings.kgName,pageNo:1,pageSize:20},e.queryData),n=$.extend({isRelationMerge:!1,isInherit:!this.settings.showAllSchemaOptions,hyponymyDistance:6},e.formData);if(n.id=t.id,n.isTop=!this.settings.showAllSchemaOptions,this.filter){var s=this.filter.getFilterOptions();$.extend(n,s),"dblClick"===t.$source&&("0"!==s["distance-expend"]&&(n.distance=s["distance-expend"]),delete n["distance-expend"])}return{queryData:i,formData:n,url:e.url||e.baseUrl+"app/graph"}},e.prototype.buildLinkLegendData=function(t){var e=[{key:-1,value:"上下位",displayAtts:[]},{key:0,value:"私有关系",displayAtts:[]}],i=function(t){var e=lodash_1.filter(t.extraInfos,["type",0]);return{key:t.k,value:t.v,displayAtts:lodash_1.map(e,function(t){return{label:t.name,value:t.name}})}};if(t){if(this.settings.linkLegend&&this.settings.linkLegend.merge){for(var n=this.schema,s=0,a=n.atts;s<a.length;s++){var r=a[s],o=lodash_1.findIndex(t,["key",r.k]);o<0&&t.push(i(r))}t.concat(e)}}else{for(var d=e,n=this.schema,l=0,h=n.atts;l<h.length;l++){var r=h[l];d.push(i(r))}t=d}for(var g=0,u=t;g<u.length;g++){var r=u[g],p=this.netChart.linkDefaultRadius(r),c=this.netChart.linkLabelDefaultColor(r);r.extra=r.extra||{},r.extra.radius=r.extra.radius||p,r.extra.showLabel="boolean"!=typeof r.extra.showLabel||r.extra.showLabel,r.extra.labelColor=r.extra.labelColor||c,r.extra.length=r.extra.length||this.netChart.linkDefaultLength(),r.extra.showArrow="boolean"!=typeof r.extra.showArrow||r.extra.showArrow,r.color||this.linkLegend||(r.color=this.netChart.linkDefaultColor())}return t},e.prototype.buildNodeLegendData=function(t){var e={key:"0",value:"概念",outline:!0,dashed:!0};if(t){if(this.settings.nodeLegend&&this.settings.nodeLegend.merge){for(var i=this.schema,n=0,s=i.types;n<s.length;n++){var a=s[n];if(this.settings.showAllSchemaOptions||"0"===a.parentId){var r=lodash_1.findIndex(t,["key",a.k]);r<0&&t.push({key:a.k,value:a.v})}}t.push(e)}}else{for(var o=[e],i=this.schema,d=0,l=i.types;d<l.length;d++){var a=l[d];(this.settings.showAllSchemaOptions||"0"===a.parentId)&&o.push({key:a.k,value:a.v})}t=o}for(var h=0,g=t;h<g.length;h++){var a=g[h],u=this.netChart.nodeDefaultRadius(a),p=this.netChart.nodeLabelDefaultColor(a);a.extra=a.extra||{},a.extra.radius=a.extra.radius||u,a.extra.showLabel="boolean"!=typeof a.extra.showLabel||a.extra.showLabel,a.extra.labelColor=a.extra.labelColor||p,a.extra.showImage="boolean"!=typeof a.extra.showImage||a.extra.showImage;var c=a.extra.innerLabel;if(a.extra.innerLabel="boolean"==typeof c?c:"inner"===this.netChart.nodeLabelPosition(),!a.color){this.nodeLegend||(a.color=this.netChart.nodeDefaultColor());var f=lodash_1.find(this.schema.types,["k",a.key]);f&&f.additional&&f.additional.color&&(a.color=f.additional.color)}}return t},e.prototype.createPluginSettings=function(t,e){void 0===t&&(t={}),void 0===e&&(e={});var i=this.settings.pluginSettings||{};i.container=this.netChart;var n={};if(t.mixinsId){var s=this.mixins[t.mixinsId];if(s){var a=$.extend(!0,{},t.mixinsSettings),r=s.addChild(a);n.$parent=s.getBody(r),n.headerFunction=function(t,e,i){s.updateHeader(r,a.title||t,a.icon||e)}}}return $.extend(!0,n,e,i,t.settings)},e.prototype.createSDKPluginSettings=function(t,e){return void 0===e&&(e={}),this.createPluginSettings(t,$.extend(!0,{ajaxSettings:this.settings.ajaxSettings,kgName:this.settings.kgName,schema:this.schema,sdkNetChart:this},e))},e.prototype.createViewSettings=function(t,e){void 0===t&&(t={}),void 0===e&&(e={});var i={};return i.container=this.netChart,i.sdkNetChart=this,$.extend(!0,{},e,i,t.settings)},e.prototype.dealGraphData=function(t){for(var i={},n={},s=this.netChart.getNodeLegends(),a=0,r=s;a<r.length;a++){var o=r[a];i[o.key]=o.value}for(var d=this.netChart.getLinkLegends(),l=0,h=d;l<h.length;l++){var o=h[l];n[o.key]=o.value}return e.transformNetChartData(t,i,n)},e.prototype.destroyMixins=function(){for(var t in this.mixins)this.mixins.hasOwnProperty(t)&&this.mixins[t].destroy()},e.prototype.destroyPlugins=function(){this.advancedPrompt&&this.advancedPrompt.destroy(),this.resetLayout&&this.resetLayout.destroy(),this.editor&&this.editor.destroy(),this.filter&&this.filter.destroy(),this.visConfigure&&this.visConfigure.destroy(),this.history&&this.history.destroy(),this.snapshot&&this.snapshot.destroy(),this.infobox&&this.infobox.destroy(),this.find&&this.find.destroy(),this.contextmenu&&this.contextmenu.destroy(),this.nodeLegend&&this.nodeLegend.destroy(),this.linkLegend&&this.linkLegend.destroy()},e.prototype.graphInit=function(){var t=this,e=this.settings.initSettings.ajaxSettings,i=e.queryData||{},n=e.formData||{};i.kgName=this.settings.initSettings.kgName,n.type=this.defaultType;var s={url:e.baseUrl+"app/graph/default",type:"POST",data:n};return s=$.extend(!0,{},s,e),s.url=utils_1.PdSDKUtils.buildUrl(s.url,i),utils_1.PdSDKUtils.ajax(s).then(function(e){return t.settings.initSettings.ajaxSettings.success?e:(t.graphInitSuccess(e),e)})},e.prototype.graphInitSuccess=function(t){this.initFilterOptions(t.config)},e.prototype.init=function(){var t=this;this.isInit=!1,this.loadSchema().then(function(e){e?(e.types||(e.types=[]),e.atts||(e.atts=[]),t.schema=e,t.initNetChart(),t.initView(),t.bindEvent(),t.initMixins(),t.initPlugins(),t.updateLegendData()):common_1.PdCommonUtils.error("无Schema数据"),t.updateInitStatus()})},e.prototype.initFilterOptions=function(t){if(t&&this.filter){var e=this.filter.getFilterOptions();e=$.extend(!0,{},e,t),this.filter.setFilterOptions(e)}},e.prototype.initMixins=function(){var t=this.settings;if(this.mixins={},t&&t.mixinsSettings)for(var e in t.mixinsSettings)if(t.mixinsSettings.hasOwnProperty(e)){var i=$.extend(!0,{container:this.netChart,sdkNetChart:this},t.mixinsSettings[e]);this.mixins[e]=new mixins_1.PdSDKPluginMixins(i)}},e.prototype.initNetChart=function(){var t=this;this.netChart=new this.NetChart(this.settings.netChartSettings),this.settings.netChartSettings.main.extend||this.netChart.setAvailableDataFilter({type:"extend",filter:function(e){var i=t.netChart.getHistoryData();if(i.length>1){for(var n=[],s=null,a=i.length;a>0&&(s=i[a-1],n.push(s),t.isExtend(s.loadParams));a--);var r=$.extend(!0,{},s.data);return r.nodes=lodash_1.uniqBy(lodash_1.flatMap(n,"data.nodes"),"id"),r.links=lodash_1.uniqBy(lodash_1.flatMap(n,"data.links"),"id"),r}return e}})},e.prototype.buildFilter=function(t){return t},e.prototype.initPlugins=function(){var t=this,e=this.settings;if(e.advancedPrompt&&e.advancedPrompt.enable){var i=this.createSDKPluginSettings(e.advancedPrompt);this.advancedPrompt=new advanced_prompt_1.PdSDKPluginAdvancedPrompt(i)}if(e.resetLayout&&e.resetLayout.enable){var i=this.createPluginSettings(e.resetLayout);this.resetLayout=new reset_layout_1.PdVisPluginResetLayout(i)}if(e.editor&&e.editor.enable){var n={promptSettings:{kgName:this.settings.kgName,ajaxSettings:this.settings.ajaxSettings},editConceptSettings:{parentPromptSettings:{ajaxSettings:this.settings.ajaxSettings},childPromptSettings:{ajaxSettings:this.settings.ajaxSettings},updateAbstractSettings:{}},editInstanceSettings:{parentPromptSettings:{ajaxSettings:this.settings.ajaxSettings}},defineRelationSettings:{addPromptSettings:{ajaxSettings:this.settings.ajaxSettings},editPromptSettings:{ajaxSettings:this.settings.ajaxSettings}},defineRelationEdgeSettings:{addPromptSettings:{ajaxSettings:this.settings.ajaxSettings},editPromptSettings:{ajaxSettings:this.settings.ajaxSettings}},addRelationSettings:{startPromptSettings:{ajaxSettings:this.settings.ajaxSettings},endPromptSettings:{ajaxSettings:this.settings.ajaxSettings}},editEdgeSettings:{instancePromptSettings:{ajaxSettings:this.settings.ajaxSettings}}},i=this.createSDKPluginSettings(e.editor,n);this.editor=new editor_1.PdSDKPluginEditor(i)}if(e.filter&&e.filter.enable){var n={showAllSchemaOptions:this.settings.showAllSchemaOptions},i=this.createSDKPluginSettings(e.filter,n);i.editItemSettings=lodash_1.concat(i.editItemSettings||[],i.filters||[]),i.editItemSettings=this.buildFilter(i.editItemSettings),this.filter=new filter_1.PdSDKPluginFilter(i)}if(e.history&&e.history.enable){var i=this.createSDKPluginSettings(e.history);this.history=new history_1.PdSDKPluginHistory(i)}if(e.snapshot&&e.snapshot.enable){var i=this.createSDKPluginSettings(e.snapshot);this.snapshot=new snapshot_1.PdVisPluginSnapshot(i)}if(e.mapx&&e.mapx.enable){var n={chartSettings:this.settings},i=this.createSDKPluginSettings(e.mapx,n);this.mapx=new mapx_1.PdSDKPluginMapx(i)}if(e.find&&e.find.enable){var i=this.createPluginSettings(e.find);this.find=new find_1.PdVisPluginFind(i)}if(e.nodeLegend&&e.nodeLegend.enable){var i=this.createPluginSettings(e.nodeLegend);this.nodeLegend=new node_legend_1.PdVisPluginNodeLegend(i)}if(e.contextmenu&&e.contextmenu.enable){var s=this.createSDKPluginSettings({settings:{kgName:this.settings.kgName,schema:this.schema,ajaxSettings:this.settings.ajaxSettings,max:1,positiveBtn:{onclick:function(e){var i=e.getTagData();1===i.length&&(t.netChart.load({id:i[0].id},"merge"),e.closeDialog())}}}}),i=this.createSDKPluginSettings(e.contextmenu,{promptSettings:{kgName:this.settings.kgName,ajaxSettings:this.settings.ajaxSettings},editSettings:e.editor&&e.editor.settings,editEnable:e.editor&&e.editor.enable,menu:{"sub-graph":{settings:{advancedPromptDialogSettings:s}}}});this.contextmenu=new contextmenu_1.PdSDKPluginContextmenu(i)}if(e.linkLegend&&e.linkLegend.enable){var i=this.createPluginSettings(e.linkLegend);this.linkLegend=new link_legend_1.PdVisPluginLinkLegend(i)}var a=e.infoboxSettings;if(a.enable&&e.infobox&&e.infobox.enable){var n={infoboxSettings:a.settings},i=this.createSDKPluginSettings(e.infobox,n);this.infobox=new infobox_1.PdSDKPluginInfobox(i)}if(e.visConfigure&&e.visConfigure.enable){var i=this.createSDKPluginSettings(e.visConfigure);this.visConfigure=new vis_configure_1.PdSDKPluginVisConfigure(i)}},e.prototype.initSettings=function(t){return $.extend(!0,{},e.defaultSettings,t)},e.prototype.initView=function(){var t=this.settings;if(t.treeView&&t.treeView.enable){var e=this.createViewSettings(t.treeView);this.treeView=new tree_1.PdVisViewTree(e)}if(t.dataView&&t.dataView.enable){var e=this.createViewSettings(t.dataView);this.dataView=new data_1.PdSDKViewData(e)}if(t.wordCloudView&&t.wordCloudView.enable){var e=this.createViewSettings(t.wordCloudView);this.wordCloudView=new word_cloud_1.PdSDKViewWordCloud(e)}},e.prototype.isExtend=function(t){var e=this.settings.loaderSettings.extend,i=!1;return e instanceof Boolean?i=e===!0:e instanceof Function&&(i=e(t)),i},e.prototype.isGraphFixedNodesUpdateable=function(t){var e=this.settings.loaderSettings.graphFixedNodesUpdateable,i=!1;return e instanceof Boolean?i=e===!0:e instanceof Function&&(i=e(t,this)),i},e.prototype.loader=function(t){var e=this,i=t.ajaxSettings;return function(t,n){var s=e.buildLoaderParams(n),a={url:s.url,type:"POST",data:s.formData,el:e.netChart.select(".pdvis-main-container")[0]};return $.extend(!0,a,i),a.url=utils_1.PdSDKUtils.buildUrl(a.url,s.queryData),utils_1.PdSDKUtils.ajax(a).then(function(t){return a.success?t:t?t:void Promise.reject("无数据")})}},e.prototype.loadSchema=function(){var t=this.settings,e={ajaxSettings:t.ajaxSettings,kgName:t.kgName};if(t.schema)return Promise.resolve(schema_1.PdSDKSchema.transformSchema(t.schema));var i=$(t.selector)[0],n={ajaxSettings:{el:i}};return n=$.extend(!0,{},e,n,t.schemaSettings),t.schemaSettings=utils_1.PdSDKUtils.updateUrl(n,t.schemaSettings),new schema_1.PdSDKSchema(t.schemaSettings).load()},e.prototype.nodeDblClick=function(t){this.load(t,"dblClick")},e.prototype.transferNode2Param=function(t){return lodash_1.pick(t,["id","name"])},e.prototype.updateGraphFixedNodes=function(t){this.netChart.fixedNodes=lodash_1.compact([t])},e.prototype.updateGraphLoadParams=function(){var t=this.netChart,e=t.loadParams,i=t.data;if(e&&i.nodes&&i.nodes.length){var n=e.id?"id":"name";if(e=lodash_1.find(i.nodes,[n,e[n].toString()])||i.nodes[0],this.isGraphFixedNodesUpdateable(t.loadParams))this.updateGraphFixedNodes(e);else for(var s=this.netChart.historyCursor;s>=0;s--){var a=this.netChart.historyList[s].loadParams;if(!this.isExtend(a)){this.netChart.loadParams=a;break}}var r=this.netChart.getHistory();r.fixedNodes?this.netChart.fixedNodes=r.fixedNodes:r.fixedNodes=this.netChart.fixedNodes}},e.prototype.updateInitStatus=function(){var t=!0;for(var e in this.initPrepareList)this.initPrepareList.hasOwnProperty(e)&&this.initPrepareList[e]&&(t=!1);t&&(this.isInit=!0,this.dispatch("inited",this.eventData))},e.prototype.unbindEvent=function(){this.clearEvent()},e.defaultSettings={pluginSettings:{isVisible:function(t,e){var i=e.getPluginType();return!(["history","filter"].indexOf(i)<0)||["netChartView","treeView"].indexOf(t)>=0}},advancedPrompt:{enable:!1},contextmenu:{enable:!0},editor:{enable:!1},filter:{enable:!0},visConfigure:{enable:!0,settings:{lengthSettings:{step:.1}}},find:{enable:!0},history:{enable:!0},snapshot:{enable:!1},infobox:{enable:!0},infoboxSettings:{enable:!0,mode:"contentsMenu",position:"center"},loaderSettings:{extend:function(t){return"dblClick"===t.$source||"merge"===t.$source},graphFixedNodesUpdateable:function(t,e){return!e.isExtend(t)}},linkLegend:{enable:!1},nodeLegend:{enable:!0},resetLayout:{enable:!1},dataView:{enable:!1},treeView:{enable:!1},wordCloudView:{enable:!1}},e}(event_1.PdEvent);exports.PdSDKNetChart=PdSDKNetChart;