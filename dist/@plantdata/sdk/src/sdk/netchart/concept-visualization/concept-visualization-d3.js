"use strict";var __extends=this&&this.__extends||function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};return function(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),d3=require("d3"),common_1=require("../../../common/common"),utils_1=require("../../utils/utils"),component_1=require("../../../core/component"),device_hub_1=require("../../../icon/device-hub"),PdSDKConceptVisualizationD3=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.duration=750,e.dataTypeMap={1:"整数值",2:"浮点值",4:"日期时间",41:"日期",42:"时间",5:"字符串",6:"计算属性",8:"Map型",10:"文本型",51:"超链接"},e.maxLabelLength=0,e}return __extends(e,t),e.diagonal=function(t,e){if(null!=t&&null!=e)return"M "+t.y+" "+t.x+" C "+(t.y+e.y)/2+" "+t.x+","+(t.y+e.y)/2+" "+e.x+", "+e.y+" "+e.x},e.toggleChildren=function(t){return t.children?(t._children=t.children,t.children=null):t._children&&(t.children=t._children,t._children=null),t},e.prototype.destroy=function(){t.prototype.destroy.call(this)},e.prototype.download=function(){var t=this,e=this.treeIns.size(),n=document.getElementsByClassName("pdsdk-concept-visualization-chart-group")[0].getBoundingClientRect();e[2]=e[0]<n.height?n.height:e[0],e[3]=e[1]<n.width+200?n.width+200:e[1];var i=new XMLSerializer;Number(this.chart.attr("height"))<e[2]&&this.chart.attr("height",e[2]),Number(this.chart.attr("width"))<e[3]&&this.chart.attr("width",e[3]);var a=14*this.rootData.data.name.length;this.chart.transition().call(this.zoomListener.transform,d3.zoomIdentity.translate(a,0).scale(1)),setTimeout(function(){var n=i.serializeToString(t.chart.node());n='<?xml version="1.0" standalone="no"?>\r\n'+n;var a="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(n),r=document.createElement("canvas");r.width=e[3],r.height=e[2];var o=r.getContext("2d"),s=new Image;s.src=a,s.onload=function(){o.drawImage(s,0,0);var t=document.createElement("a");t.download="概念可视化.png",t.href=r.toDataURL("image/png"),t.click()}},300)},e.prototype.load=function(){var t=this;this.settings.showRelation?this.settings.allData?(this.allData=this.settings.allData,this.drawChart(this.allData)):this.loadData().then(function(e){t.allData=e,t.drawChart(t.allData)}):this.settings.conceptData?(this.conceptData=this.settings.conceptData,this.drawChart(this.conceptData)):this.loadData().then(function(e){t.conceptData=e,t.drawChart(t.conceptData)})},e.prototype.loadData=function(){var t=this.settings.ajaxSettings,e=t.queryData||{},n=t.formData||{};n.kgName=this.settings.kgName,n.conceptId="0";var i=this.$el.find(".pdsdk-concept-visualization-chart"),a={url:t.baseUrl+"app/model/stat",type:"POST",data:n,el:i[0]};return a=$.extend(!0,{},a,t,{data:{isDisplay:this.settings.showRelation}}),a.url=utils_1.PdSDKUtils.buildUrl(a.url,e),utils_1.PdSDKUtils.ajax(a)},e.prototype.bindEvent=function(){var e=this;t.prototype.bindEvent.call(this),this.chartResize=function(){if(e.chart){var t=e.select(".pdsdk-concept-visualization-content");e.viewerHeight=t.height(),e.viewerWidth=t.width(),e.chart.attr("width",e.viewerWidth).attr("height",e.viewerHeight)}},$(window).on("resize",this.chartResize),this.$el.find(".pdsdk-concept-visualization-header").on("click",".pdsdk-concept-visualization-checkbox input",function(t){e.settings.showRelation=$(t.currentTarget).prop("checked"),e.load()}).on("click",".pdsdk-concept-visualization-btn",function(t){e.download()})},e.prototype.centerNode=function(t){var e=d3.zoomTransform(this.chart.node()),n=-t.y0,i=-t.x0;n=n*e.k+this.viewerWidth/3,i=i*e.k+this.viewerHeight/2,this.chart.transition().duration(this.duration).call(this.zoomListener.transform,d3.zoomIdentity.translate(n,i).scale(e.k))},e.prototype.collapse=function(t){t.children&&(t._children=t.children,t._children.forEach(this.collapse),t.children=null)},e.prototype.drawChart=function(t){var e=this;this.visit(t,function(t,n){e.maxLabelLength=Math.max(t.name.length,e.maxLabelLength)},function(t,e){return t.children&&t.children.length>0?t.children:null},0),this.rootData=d3.hierarchy(t,function(t){return t.children}),this.visit(this.rootData,function(t,e){},function(t,n){return t.children&&t.children.length>0?n>=e.settings.initialTreeDepth?(t._children=t.children,delete t.children,t._children):t.children:null},0),this.rootData.x0=0,this.rootData.y0=0,this.update(this.rootData),this.centerNode(this.rootData)},e.prototype.drawInfo=function(t){var e=this.select(".pdsdk-concept-visualization-content"),n=d3.mouse(e[0]),i=this.select(".pdsdk-concept-visualization-info"),a='<div class="pdsdk-concept-visualization-info-title">'+t.data.name+"</div>";if(t.data.numAtts&&t.data.numAtts.length){for(var r="",o=0;o<t.data.numAtts.length;o++){var s=t.data.numAtts[o];r+="<li><span>"+s.name+": </span><span>"+(this.dataTypeMap[s.dataType]||s.dataType)+"</span></li>"}a+="<ul>"+r+"</ul>"}var c=n[0]+15,l=n[1]+15;i.css({display:"block"}).html(a),c+i.width()>e.width()&&(c=c-i.width()-30),l+i.height()>e.height()&&(l=l-i.height()-30),i.css({top:l+"px",left:c+"px"})},e.prototype.expand=function(t){t._children&&(t.children=t._children,t.children.forEach(this.expand),t._children=null)},e.prototype.initChart=function(){var t=this,e=this.select(".pdsdk-concept-visualization-chart");this.viewerHeight=e.height(),this.viewerWidth=e.width(),this.chart=d3.select(e[0]).append("svg").attr("width",this.viewerWidth).attr("height",this.viewerHeight).attr("class","overlay pdsdk-concept-visualization-chart-svg").call(d3.zoom().scaleExtent([.1,3]).on("zoom",function(){null!=d3.event.transform&&t.treeGroup.attr("transform",d3.event.transform)})),this.chart.style("display","block"),this.treeGroup=this.chart.append("g").attr("class","pdsdk-concept-visualization-chart-group")},e.prototype.initSettings=function(t){return $.extend(!0,{},e.defaultSettings,t)},e.prototype.initTemplate=function(){var t=$(this.settings.selector);t.addClass("pdvis-namespace"),this.saveOriginClass(t);var e=(device_hub_1["default"](24),common_1.PdCommonUtils.createId());return t.append('\n    <div class="pdsdk-concept-visualization-header clearfix">\n        <div class="pdsdk-concept-visualization-header-left clearfix">\n            <div class="pdsdk-concept-visualization-title">模型可视化</div>\n             <label for="'+e+'" class="pdui-checkbox pdsdk-concept-visualization-checkbox">\n                <input type="checkbox" id="'+e+'" '+(this.settings.showRelation?"checked":"")+'>\n                <span>展示对象属性</span>\n            </label>\n        </div>\n        <div class="pdsdk-concept-visualization-header-right clearfix">\n            <button class="pdsdk-concept-visualization-btns pdsdk-concept-visualization-btn\n            pdui-btn-sm pdui-btn pdui-btn-primary">导出</button>\n        </div>\n    </div>\n    <div class="pdsdk-concept-visualization-content">\n        <div class="pdsdk-concept-visualization-chart" id="pdsdk-concept-visualization-d3-chart"></div>\n        <div class="pdsdk-concept-visualization-info"></div>\n    </div>'),t},e.prototype.mounted=function(){var t=this;this.zoomListener=d3.zoom().scaleExtent([.1,3]).on("zoom",function(){null!=d3.event.transform&&t.treeGroup.attr("transform",d3.event.transform)}),this.initChart(),this.load(),this.bindEvent()},e.prototype.update=function(t){var n=this,i=[1],a=function(t,e){e.children&&e.children.length>0&&(i.length<=t+1&&i.push(0),i[t+1]+=e.children.length,e.children.forEach(function(e){a(t+1,e)}))};a(0,this.rootData);var r=25*d3.max(i);this.treeIns=d3.tree().size([r,this.viewerWidth]);var o=this.treeIns(this.rootData),s=o.descendants(),c=o.descendants().slice(1);s.forEach(function(t){t.y=t.depth*(20*n.maxLabelLength)});var l=0,d=this.treeGroup.selectAll("g.node").data(s,function(t){return t.id||(t.id=(++l).toString())}),h=d.enter().append("g").attr("class","node").attr("transform",function(){return"translate("+t.y0+","+t.x0+")"}).style("cursor","pointer").on("click",function(t){d3.event.defaultPrevented||(t=e.toggleChildren(t),n.update(t),n.centerNode(t))}).on("mouseover",function(t){n.drawInfo(t)}).on("mouseleave",function(){n.select(".pdsdk-concept-visualization-info").css({display:"none"})});h.append("circle").attr("class","nodeCircle").attr("r",4.5).style("stroke-width","1.5px").style("fill","#fff").style("fill",function(t){return t._children?"#b0c4de":"#fff"}).style("stroke",function(t){return"1"===t.data.type.toString()?n.settings.attributeColor:n.settings.conceptColor}),h.append("text").attr("x",function(t){return t.children||t._children?-10:10}).style("font-size","10px").attr("dy",".35em").attr("class","nodeText").attr("text-anchor",function(t){return t.children||t._children?"end":"start"}).text(function(t){return t.data.name}).style("fill-opacity",0),d.select("text").attr("x",function(t){return t.children||t._children?-10:10}).attr("text-anchor",function(t){return t.children||t._children?"end":"start"}).text(function(t){return t.data.name}),d.select("circle.nodeCircle").attr("r",4.5).style("fill",function(t){return t._children?"#b0c4de":"#fff"}).style("stroke",function(t){return"1"===t.data.type.toString()?n.settings.attributeColor:n.settings.conceptColor});var u=h.merge(d);u.transition().duration(this.duration).attr("transform",function(t){return"translate("+t.y+","+t.x+")"}),u.select("text").style("fill-opacity",1);var p=d.exit().transition().duration(this.duration).attr("transform",function(){return"translate("+t.y+","+t.x+")"}).remove();p.select("circle").attr("r",0),p.select("text").style("fill-opacity",0);var f=this.treeGroup.selectAll("path.link").data(c,function(t){return t.id}),v=f.enter().insert("path","g").attr("class","link").attr("d",function(){var n={x:t.x0,y:t.y0};return e.diagonal(n,n)}).style("fill","none").style("stroke","#ccc").style("stroke-width","1.5px"),g=v.merge(f);g.transition().duration(this.duration).attr("d",function(t){return e.diagonal(t,t.parent)}),f.exit().transition().duration(this.duration).attr("d",function(){var n={x:t.x,y:t.y};return e.diagonal(n,n)}).remove(),s.forEach(function(t){t.x0=t.x,t.y0=t.y})},e.prototype.unbindEvent=function(){t.prototype.unbindEvent.call(this),this.chart&&$(window).off("resize"),this.$el.find(".pdsdk-concept-visualization-header").off("click",".pdsdk-concept-visualization-checkbox input").off("click",".pdsdk-concept-visualization-btn")},e.prototype.visit=function(t,e,n,i){if(t){e(t,i);var a=n(t,i);if(a)for(var r=a.length,o=0;o<r;o++)this.visit(a[o],e,n,i+1)}},e.defaultSettings={orient:"vertical",showRelation:!1,initialTreeDepth:2,attributeColor:"#eaad84",conceptColor:"#5677FC"},e}(component_1.PdComponent);exports.PdSDKConceptVisualizationD3=PdSDKConceptVisualizationD3;