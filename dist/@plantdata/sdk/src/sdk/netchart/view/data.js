"use strict";var __extends=this&&this.__extends||function(){var t=function(i,a){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var a in i)i.hasOwnProperty(a)&&(t[a]=i[a])})(i,a)};return function(i,a){function e(){this.constructor=i}t(i,a),i.prototype=null===a?Object.create(a):(e.prototype=a.prototype,new e)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery");require("echarts/lib/component/title");var lodash_1=require("lodash"),list_1=require("../../../icon/list"),view_1=require("../../../vis/netchart/view"),common_1=require("../../../common/common"),infobox_1=require("../../infobox/infobox"),netchart_1=require("../../../vis/netchart/netchart"),utils_1=require("../../utils"),line_bar_1=require("../../stats/impls/line-bar"),tab_1=require("../../../ui/components/tab/tab");exports.PdUITab=tab_1.PdUITab;var PdSDKViewData=function(t){function i(i){var a=t.call(this,i)||this;return a.infoboxCacheMap={},a}return __extends(i,t),i.prototype.getViewType=function(){return"dataView"},i.prototype.bindEvent=function(){var i=this;t.prototype.bindEvent.call(this),this.select(".pdvis-data-view-body").on("click",".pdvis-data-view-infobox",function(t){var a=$(t.currentTarget).closest("tr").attr("data-pdvis-id");i.showExtraInfoContainer(t),i.loadInfobox(a)}).on("click",".pdvis-data-view-graph",function(t){var a=$(t.currentTarget).closest("tr").attr("data-pdvis-id");i.settings.sdkNetChart.load({id:a})}).on("click",".pdvis-data-view-link",function(t){var a=$(t.currentTarget).closest("tr").attr("data-pdvis-id"),e=lodash_1.find(i.data.links,["id",a]);i.showExtraInfoContainer(t),i.$linkDetail.html(netchart_1.PdVisNetChart.createLinkRInfo(e))}),this.$mask.on("click",function(t){i.infobox.clear(),i.$linkDetail.empty(),i.$extraInfoContainer.hide(),i.$mask.hide()})},i.prototype.createChart=function(t,i,a){void 0===i&&(i={}),void 0===a&&(a="");var e=[],n=[];for(var s in i)i.hasOwnProperty(s)&&(e.push(s),n.push(i[s]));var o=$.extend(!0,{title:{text:a,left:"center",top:0,textStyle:{align:"center",lineHeight:64,fontSize:12,fontWeight:"normal",color:"#666"}}});return new line_bar_1.PdSDKStatLineBar({data:{xAxis:[{data:e,name:""}],series:[{data:n,name:"",barMaxWidth:30}]},type:"bar",chartSettings:o,selector:t})},i.prototype.createLinkList=function(){for(var t="",i=0,a=this.data.links;i<a.length;i++){var e=a[i],n=this.container.findNode(e.from),s=this.container.findNode(e.to);t+='<tr data-pdvis-id="'+e.id+'"><td>'+n.name+"</td><td>"+s.name+"</td><td>"+e.attName+'</td><td><span class="pdvis-data-view-link">查看</span></td></tr>'}this.select(".pdvis-data-view-links").find("tbody").html(t)},i.prototype.createMainContent=function(){var t='<table class="pdui-table" width="100%"><thead><tr><th>名称</th><th>唯一标识</th><th>类别</th><th>类型</th><th>知识卡片</th><th>操作</th></tr></thead><tbody></tbody></table>',i='<table class="pdui-table" width="100%"><thead><tr><th>起点</th><th>终点</th><th>关系</th><th>详细信息</th></tr></thead><tbody></tbody></table>',a=common_1.PdCommonUtils.createId("nodes-"),e=common_1.PdCommonUtils.createId("links-");return'<div class="pdui-tab pdui-card"><div class="pdui-tab-nav-container pdui-tab-nav-show-all pdui-card-head"><div class="pdui-tab-nav-wrap"><ul class="pdui-tab-nav pdui-tab-nav-primary"><li class="active"><a href="#'+a+'">实体</a></li><li><a href="#'+e+'">关系</a></li><li class="pdui-tab-nav-decoration" style="width: 80px; left: ;"></li></ul></div><div class="pdui-tab-nav-control pdui-tab-nav-control-prev disabled"></div><div class="pdui-tab-nav-control pdui-tab-nav-control-next"></div></div><div class="pdui-tab-page pdui-card-body"><div class="pdui-tab-page-item pdvis-data-view-nodes active" id="'+a+'">'+t+'</div><div class="pdui-tab-page-item pdvis-data-view-links" id="'+e+'">'+i+"</div></div></div>"},i.prototype.createNodeList=function(){for(var t="",i=0,a=this.data.nodes;i<a.length;i++){var e=a[i];t+='<tr data-pdvis-id="'+e.id+'"><td>'+e.name+"</td><td>"+(e.meaningTag||"-")+"</td><td>"+(0===e.type?"概念":"实例")+"</td><td>"+e.typeName+'</td><td><span class="pdvis-data-view-infobox">查看</span></td><td><button class="pdui-btn pdui-btn-primary pdui-btn-sm pdvis-data-view-graph">探索</button></td></tr>'}this.select(".pdvis-data-view-nodes").find("tbody").html(t)},i.prototype.dataChange=function(){if(this.data){var t=this.createMainContent();this.select(".pdvis-data-view-data-list").html(t),this.createNodeList(),this.createLinkList();var i=lodash_1.countBy(this.data.nodes,"typeName"),a=lodash_1.countBy(this.data.links,"attName");this.nodeStat=this.createChart(this.select(".pdvis-data-view-stats-nodes"),i,"实体类型统计"),this.linkStat=this.createChart(this.select(".pdvis-data-view-stats-links"),a,"关系类型统计")}else{var e=this.createNoData();this.select(".pdvis-data-view-data-list").html(e)}},i.prototype.enter=function(){var t=this;setTimeout(function(){t.nodeStat&&t.nodeStat.resize(),t.linkStat&&t.linkStat.resize()},300)},i.prototype.initSettings=function(a){return $.extend(!0,{infoboxSettings:{ajaxSettings:a.sdkNetChart.settings.ajaxSettings,kgName:a.sdkNetChart.settings.kgName}},t.prototype.initSettings.call(this,i.defaultSettings),a)},i.prototype.initInfobox=function(){var t=$.extend(!0,{container:this.$extraInfoContainer},this.settings.infoboxSettings);this.infobox=new infobox_1.PdSDKInfobox(t)},i.prototype.initLinkDetail=function(){this.$linkDetail=$('<div class="pdvis-data-view-link-detail"></div>'),this.$extraInfoContainer.append(this.$linkDetail)},i.prototype.initTemplate=function(){var t='<div class="pdvis-data-view-head">数据视图</div><div class="pdvis-data-view-body"><div class="pdvis-data-view-data-stats"><div class="pdui-card"><div class="pdui-card-head">统计</div><div class="pdui-card-body"><div class="pdvis-data-view-stats-item pdvis-data-view-stats-nodes"></div><div class="pdvis-data-view-stats-item pdvis-data-view-stats-links"></div></div></div></div><div class="pdvis-data-view-data-list"></div></div><div class="pdvis-data-view-extra-info"><div class="pdvis-data-view-infobox-arrow"></div>';return this.initViewTemplate(t,"数据列表",list_1["default"]()).addClass("pdvis-data-view-container")},i.prototype.loadInfobox=function(t){var i=this;if(this.infoboxCacheMap[t]){var a=this.infoboxCacheMap[t];return this.infobox.buildInfobox(a),Promise.resolve(a)}return this.infobox.load({id:t}).then(function(a){return i.infoboxCacheMap[t]=a,Promise.resolve(a)})},i.prototype.mounted=function(){t.prototype.mounted.call(this),this.$extraInfoContainer=this.select(".pdvis-data-view-extra-info"),this.initInfobox(),this.initLinkDetail(),this.bindEvent()},i.prototype.showExtraInfoContainer=function(t){var i=$(t.currentTarget);this.$extraInfoContainer.show();var a=this.$el.height(),e=this.$el[0].scrollHeight;this.$mask.show().height(e);var n="center";if(a>500){var s=i.offset(),o=this.$extraInfoContainer.offsetParent().offset(),d=this.$el.scrollTop(),r=s.top-o.top,l=s.left-o.left;a-r>320?(n="bottom",this.$extraInfoContainer.css({left:l,top:r+d})):r>320&&(n="top",this.$extraInfoContainer.css({left:l,bottom:a-r-d}))}this.$extraInfoContainer.attr("data-infobox-position",n)},i.prototype.unbindEvent=function(){t.prototype.unbindEvent.call(this),this.select(".pdvis-data-view-body").off("click",".pdvis-data-view-infobox").off("click",".pdvis-data-view-graph").off("click",".pdvis-data-view-link"),this.$mask.off("click")},i.defaultSettings={infoboxSettings:{imgBuilder:utils_1.PdSDKUtils.imgBuilder,ajaxSettings:{formData:{isRelationAtts:!0}}}},i}(view_1.PdVisView);exports.PdSDKViewData=PdSDKViewData;