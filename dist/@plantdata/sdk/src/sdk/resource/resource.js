"use strict";var __extends=this&&this.__extends||function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function s(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(s.prototype=r.prototype,new s)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),moment_es6_1=require("moment-es6"),utils_1=require("../utils/utils"),table_1=require("../table/table"),PdSDKResource=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.reload=function(){return this.load(this.pageNo)},e.prototype.updateData=function(t,e,r){this.pageNo=e,t.rsData.length&&(this.setPage(t.rsCount,e,r),this.setData(t.rsData))},e.prototype.getQuery=function(){var t=[],e=this.getFilterOptions();for(var r in e)if(e.hasOwnProperty(r)){var s=[],a=e[r],o=lodash_1.find(this.settings.filters,["key",r]);if("year"===o.type||"month"===o.type)for(var i=0,n=a;i<n.length;i++){var u=n[i],l="",p="";"year"===o.type?(l=moment_es6_1["default"](u+"-01-01").format(o.format||"YYYY-MM-DD"),p=moment_es6_1["default"](parseInt(u,10)+1+"-01-01").format(o.format||"YYYY-MM-DD")):(l=moment_es6_1["default"](u+"-01").format(o.format||"YYYY-MM"),p=moment_es6_1["default"](parseInt(u,10)+1+"-01").format(o.format||"YYYY-MM"));var d={};d[r]={from:l,to:p,include_lower:!0,include_upper:!1},s.push({range:d})}else{var d={};d[r]=a,s.push({terms:d})}t.push({bool:{should:s,minimum_should_match:1}})}var f=this.getFilterKeyword();if(f){var s=[],h=this.settings,_=h.kwFields||h.tableFields||h.fields,d={query:f,fields:_};s.push({query_string:d}),t.push({bool:{should:s,minimum_should_match:1}})}return{bool:{must:t}}},e.prototype.initSettings=function(e){var r=this;return $.extend(!0,{},t.prototype.initSettings.call(this,{loader:function(t){return r.loader(t)}}),e)},e.prototype.loader=function(t){var e=this,r=this.settings,s=this.settings.onLoaded,a=this.settings.ajaxSettings,o=a.queryData||{},i={databases:r.databases,tables:r.tables,fields:r.fields,query:this.getQuery(),pageNo:t,pageSize:15};$.extend(!0,i,a.formData);var n=this.getTableContainer().empty();this.setPage(0,t,i.pageSize);var u={url:a.baseUrl+"data/search",type:"POST",data:i,el:n[0]};return u=$.extend(!0,{},u,a),u.url=utils_1.PdSDKUtils.buildUrl(u.url,o),utils_1.PdSDKUtils.ajax(u).then(function(t){return u.success?t:(e.updateData(t,i.pageNo,i.pageSize),s&&s(t,e),t)})},e}(table_1.PdSDKTable);exports.PdSDKResource=PdSDKResource;