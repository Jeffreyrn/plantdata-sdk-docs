"use strict";var __extends=this&&this.__extends||function(){var t=function(e,s){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s])})(e,s)};return function(e,s){function i(){this.constructor=e}t(e,s),e.prototype=null===s?Object.create(s):(i.prototype=s.prototype,new i)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),autocomplete_1=require("../../ui/components/autocomplete/autocomplete"),schema_1=require("../schema/schema"),utils_1=require("../utils/utils"),component_1=require("../../core/component"),PdSDKPrompt=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.highlight=function(t,e){var s=utils_1.PdSDKUtils.str2reg(e);return t.replace(new RegExp("("+s+")","gi"),'<span class="highlight">$1</span>')},e.prototype.destroy=function(){this.autocomplete.destroy(),t.prototype.destroy.call(this)},e.prototype.drawPromptKnowledgeItem=function(){var t={0:"概念",1:"实例"};return function(s,i){"string"==typeof s&&(s={id:-1,name:s,className:"关键词"});var n=e.highlight(s.name,i),r=s.className||t[s.type]||"",p='<span class="pdsdk-prompt-tip-title">'+n+"</span>";return p='<span class="pdsdk-prompt-tip-type pdsdk-prompt-tip-'+s.type+'">'+r+"</span>"+p}},e.prototype.drawPromptItem=function(){var t=this;return function(s,i){for(var n={},r=0,p=t.settings.schema.types;r<p.length;r++){var o=p[r];n[o.k]=o.v}"string"==typeof s&&(s={id:-1,name:s,className:"关键词"});var a=e.highlight(s.name,i);s.meaningTag&&(a=a+' <span class="pdsdk-prompt-meaningtag"> '+e.highlight(s.meaningTag,i)+" </span>");var m='<span class="pdsdk-prompt-tip-title">'+a+"</span>";return m='<span class="pdsdk-prompt-tip-type pdsdk-prompt-tip-'+s.classId+'">'+(s.className||n[s.classId]||"")+"</span>"+m}},e.prototype.drawPromptItems=function(){var t=this;return function(e,s){for(var i=$("<div></div>"),n=0,r=e;n<r.length;n++){var p=r[n],o=t.autocomplete.settings.createPromptItem(p,s),a=t.autocomplete.settings.createItemTitle(p),m="pdsdk-prompt-item-"+p.classId,c=$('<li title="'+a+'" class="'+m+'">'+o+"</li>").data("data",p),l=i.find("."+m);l.length?($(l[l.length-1]).after(c),c.find(".pdsdk-prompt-tip-type").empty()):i.append(c)}return i.children()}},e.prototype.onPrompt=function(t){var e=this;return function(s){e.settings.isTrim&&(s=$.trim(s));var i=t.ajaxSettings&&t.ajaxSettings.queryData?t.ajaxSettings.queryData:{};i.kw=s,i.kgName=t.kgName,0===t.promptType?i.type="010":1===t.promptType?i.type="110":i.type=t.promptType;var n={url:t.ajaxSettings.baseUrl+"app/prompt",queryData:i};return $.extend(!0,n,t.ajaxSettings),e.settings.dynamicSettings&&(n=e.settings.dynamicSettings(n)),n.url=utils_1.PdSDKUtils.buildUrl(n.url,n.queryData),utils_1.PdSDKUtils.ajax(n)}},e.prototype.updateSchema=function(t){this.settings.schema=t},e.prototype.initAutocomplete=function(){var t={ajaxSettings:this.settings.ajaxSettings,kgName:this.settings.kgName,promptType:this.settings.promptType};$.extend(!0,t,this.settings.promptSettings),utils_1.PdSDKUtils.updateUrl(t,this.settings.promptSettings);var e={selector:this.settings.selector,promptContainerCls:"pdsdk-search-prompt",onPrompt:this.onPrompt(t)};0===this.settings.promptType?(e.createPromptItem=this.drawPromptItem(),this.settings.groupEnable&&(e.createPromptItems=this.drawPromptItems())):e.createPromptItem=this.drawPromptKnowledgeItem(),$.extend(!0,e,this.settings.autocompleteSettings),this.autocomplete=new autocomplete_1.PdUIAutocomplete(e)},e.prototype.initSettings=function(s){return $.extend(!0,{},t.prototype.initSettings.call(this,e.defaultSettings),s)},e.prototype.initTemplate=function(){var t=$(this.settings.selector);return this.saveOriginClass(t),t},e.prototype.mounted=function(){var e=this;if(t.prototype.mounted.call(this),0===this.settings.promptType)if(this.settings.schema)this.initAutocomplete();else{var s={ajaxSettings:this.settings.ajaxSettings,kgName:this.settings.kgName};s=$.extend(!0,s,this.settings.schemaSettings),utils_1.PdSDKUtils.updateUrl(s,this.settings.schemaSettings),new schema_1.PdSDKSchema(s).load().then(function(t){return s.ajaxSettings.success?t:(e.updateSchema(t),e.initAutocomplete(),t)})}else this.initAutocomplete()},e.defaultSettings={groupEnable:!1,promptType:0,isTrim:!1},e}(component_1.PdComponent);exports.PdSDKPrompt=PdSDKPrompt;