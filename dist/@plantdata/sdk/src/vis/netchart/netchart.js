"use strict";var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),chart_1=require("../chart"),common_1=require("../../common/common"),bubble_chart_1=require("../../icon/bubble-chart"),PdVisNetChart=function(t){function e(e){var i=t.call(this,e)||this;return i.fixedNodes=[],i.fixedLinks=[],i.snapshotList=[],i.linkLegends=[],i.linkLength=1,i.linkStatusMap={},i.nodeLegends=[],i.nodeStatusMap={},i}return __extends(e,t),e.createLinkRInfo=function(t){var e=lodash_1.concat(t.nRInfo||[],t.oRInfo||[]);if(e.length){var i="",n=lodash_1.groupBy(lodash_1.flatMap(e,function(t){return t.ks=lodash_1.map(t.kvs,"k"),t}),"ks");for(var o in n)if(n.hasOwnProperty(o)){for(var a="<tr>",s=0,r=n[o][0].ks;s<r.length;s++){var l=r[s];a+='<th><div class="pdvis-link-info-key">'+l+"</div></th>"}a+="</tr>";for(var d="",u=0,p=n[o];u<p.length;u++){var h=p[u],f=h.kvs;d+="<tr>";for(var c=0,g=f;c<g.length;c++){var l=g[c];d+='<td><div class="pdvis-link-info-value">'+l.v+"</div></td>"}d+="</tr>"}i+="<li><table><thead>"+a+"</thead><tbody>"+d+"</tbody></table></li>"}return'<ul class="pdvis-link-info">'+i+"</ul>"}return""},e.idEquals=function(t,e){return!t&&0!==t||!e&&0!==e?(common_1.PdCommonUtils.error("数据存在错误"),!1):t.toString()===e.toString()},e.linkContentsFunction=function(t){return e.createLinkRInfo(t)||(t.attName?"<b>"+t.attName+"</b>":"")},e.prototype.clearEmphasisLink=function(){if(this.linkStatusMap)for(var t in this.linkStatusMap)"emphasis"===this.linkStatusMap[t]&&delete this.linkStatusMap[t]},e.prototype.clearEmphasisNode=function(){if(this.nodeStatusMap)for(var t in this.nodeStatusMap)"emphasis"===this.nodeStatusMap[t]&&delete this.nodeStatusMap[t]},e.prototype.clearLinkStatus=function(){this.linkStatusMap&&(this.linkStatusMap={})},e.prototype.clearLockedLink=function(){if(this.linkStatusMap)for(var t in this.linkStatusMap)"normal"===this.linkStatusMap[t]&&delete this.linkStatusMap[t]},e.prototype.clearLockedNode=function(){if(this.nodeStatusMap)for(var t in this.nodeStatusMap)"normal"===this.nodeStatusMap[t]&&delete this.nodeStatusMap[t]},e.prototype.clearNodeStatus=function(){this.nodeStatusMap&&(this.nodeStatusMap={})},e.prototype.clearReducedLink=function(){if(this.linkStatusMap)for(var t in this.linkStatusMap)"reduce"===this.linkStatusMap[t]&&delete this.linkStatusMap[t]},e.prototype.clearReducedNode=function(){if(this.nodeStatusMap)for(var t in this.nodeStatusMap)"reduce"===this.nodeStatusMap[t]&&delete this.nodeStatusMap[t]},e.prototype.clearStatus=function(){this.clearLinkStatus(),this.clearNodeStatus()},e.prototype.deleteAvailableDataFilter=function(t){if(this.availableDataFilters||(this.availableDataFilters=[]),t)for(var e=0,i=t;e<i.length;e++){var n=i[e],o=lodash_1.findIndex(this.availableDataFilters,["type",n]);o>=0&&this.availableDataFilters.splice(o,1)}else this.availableDataFilters=[]},e.prototype.deleteFilter=function(t){if(this.filters||(this.filters=[]),t)for(var e=0,i=t;e<i.length;e++){var n=i[e],o=lodash_1.findIndex(this.filters,["type",n]);o>=0&&this.filters.splice(o,1)}else this.filters=[]},e.prototype.nodeLabelPositionUpdatable=function(){return!1},e.prototype.findNode=function(t,e){return void 0===e&&(e=this.getData().nodes),this.filterNodes([t],e)[0]},e.prototype.findNodeAdvance=function(t,i){void 0===i&&(i=this.getData().nodes);var n=lodash_1.filter(i,function(i){var n=!0;for(var o in t)t.hasOwnProperty(o)&&("id"===o?e.idEquals(i.id,t[o])||(n=!1):!i[o]===t[o]&&(n=!1));return n});return n.length?n[0]:null},e.prototype.findNodeByKey=function(t,i,n){void 0===i&&(i="id"),void 0===n&&(n=this.getData().nodes);var o=lodash_1.filter(n,function(n){return"id"===i?e.idEquals(n.id,t):n[i]===t});return o.length?o[0]:null},e.prototype.filterNodes=function(t,i){void 0===t&&(t=[]),void 0===i&&(i=this.getData().nodes);for(var n=[],o=function(t){var o=lodash_1.find(i,function(i){return e.idEquals(i.id,t)});o&&n.push(o)},a=0,s=t;a<s.length;a++){var r=s[a];o(r)}return n},e.prototype.filterAvailableData=function(t){return t},e.prototype.getAvailableData=function(){var t=this.data;if(this.settings.main.extend){var e=this.getHistoryData();if(e.length){var i=e[e.length-1].data;i.nodes=lodash_1.uniqBy(lodash_1.flatMap(e,"data.nodes"),"id"),i.links=lodash_1.uniqBy(lodash_1.flatMap(e,"data.links"),"id"),t=i}else t={nodes:[],links:[]}}if(this.availableDataFilters)for(var n=0,o=this.availableDataFilters;n<o.length;n++){var a=o[n];t=a.filter(t)}return t},e.prototype.getAvailableDataFilter=function(t){return this.availableDataFilters||(this.availableDataFilters=[]),t?lodash_1.filter(this.availableDataFilters,function(e){return lodash_1.indexOf(t,e.type)>=0}):this.availableDataFilters},e.prototype.getData=function(){for(var t=lodash_1.cloneDeep(this.getAvailableData()),e=0,i=this.filters;e<i.length;e++){var n=i[e];t=n.filter(t)}return t},e.prototype.getEmphasisLink=function(){var t={};for(var e in this.linkStatusMap)this.linkStatusMap.hasOwnProperty(e)&&"emphasis"===this.linkStatusMap[e]&&(t[e]=!0);return t},e.prototype.getEmphasisNode=function(){var t={};for(var e in this.nodeStatusMap)this.nodeStatusMap.hasOwnProperty(e)&&"emphasis"===this.nodeStatusMap[e]&&(t[e]=!0);return t},e.prototype.getFilter=function(t){return this.filters||(this.filters=[]),t?lodash_1.filter(this.filters,function(e){return lodash_1.indexOf(t,e.type)>=0}):this.filters},e.prototype.getLockedLink=function(){var t={};for(var e in this.linkStatusMap)this.linkStatusMap.hasOwnProperty(e)&&"normal"===this.linkStatusMap[e]&&(t[e]=!0);return t},e.prototype.getLockedNode=function(){var t={};for(var e in this.nodeStatusMap)this.nodeStatusMap.hasOwnProperty(e)&&"normal"===this.nodeStatusMap[e]&&(t[e]=!0);return t},e.prototype.getLinkLegend=function(t){return this.linkLegends&&this.linkLegends.length?lodash_1.find(this.linkLegends,function(e){return t.attId===e.key}):null},e.prototype.getLinkLegends=function(){return this.linkLegends},e.prototype.getNodeLegend=function(t){return this.nodeLegends&&this.nodeLegends.length?lodash_1.find(this.nodeLegends,function(i){return e.idEquals(t.classId,i.key)}):null},e.prototype.getNodeLegends=function(){return this.nodeLegends},e.prototype.getReducedLink=function(){var t={};for(var e in this.linkStatusMap)this.linkStatusMap.hasOwnProperty(e)&&"reduce"===this.linkStatusMap[e]&&(t[e]=!0);return t},e.prototype.getReducedNode=function(){var t={};for(var e in this.nodeStatusMap)this.nodeStatusMap.hasOwnProperty(e)&&"reduce"===this.nodeStatusMap[e]&&(t[e]=!0);return t},e.prototype.isFixedLink=function(t){return!!lodash_1.find(this.fixedLinks,function(e){return e.id===t})},e.prototype.isFixedNode=function(t){return!!lodash_1.find(this.fixedNodes,function(i){return e.idEquals(i.id,t)})},e.prototype.legendFilter=function(t){var e=this,i=lodash_1.map(lodash_1.filter(this.nodeLegends,function(t){return t.hidden}),function(t){return t.key}),n=lodash_1.map(lodash_1.filter(this.linkLegends,function(t){return t.hidden}),function(t){return t.key});if(i.length){t.nodes=lodash_1.filter(t.nodes,function(t){return e.isFixedNode(t.id)||common_1.PdCommonUtils.indexOfIgnoreType(i,t.classId)<0});var o=lodash_1.flatMap(t.nodes,"id");t.links=lodash_1.filter(t.links,function(t){return lodash_1.indexOf(o,t.from)>=0&&lodash_1.indexOf(o,t.to)>=0})}return n.length&&(t.links=lodash_1.filter(t.links,function(t){return e.isFixedLink(t.id)||lodash_1.indexOf(n,t.attId)<0})),t},e.prototype.linkDefaultColor=function(t){return t&&t.color||this.settings.main.color.link||e.linkColor},e.prototype.linkDefaultLength=function(t,e){return this.linkLength},e.prototype.linkDefaultRadius=function(t){var e=this.settings.main.linkSettings.radius;return e.normal||1},e.prototype.linkLabelColor=function(t,e){var i;if(t){var n=t.labelStyle;if(i=n&&n.color,!i){e=e||this.getLinkLegend(t);var o=e&&e.extra;i=o&&o.labelColor,i||(i=this.linkLabelDefaultColor(e))}}else i=this.linkLabelDefaultColor();return i},e.prototype.linkLabelDefaultColor=function(t){return"#666"},e.prototype.linkLabelShow=function(t,e){var i=!0;if(t){var n=t.labelStyle;if(i=n&&n.show,"boolean"!=typeof i){e=e||this.getLinkLegend(t);var o=e&&e.extra;i=o&&o.showLabel}}return i},e.prototype.linkRadius=function(t,e){e=e||this.getLinkLegend(t);var i=this.linkDefaultRadius();return e&&e.extra?e.extra.radius||i:i},e.prototype.linkStatus=function(t,e){var i=t.status||this.linkStatusMap[t.id]||(this.isFixedLink(t.id)?"emphasis":"");return i?i:(e=e||this.getLinkLegend(t),e&&e.status)},e.prototype.load=function(t,e){return e&&(t=$.extend(!0,t,{$source:e})),this.ajaxLoad(this.settings.loader,t).then(function(t){return t},function(t){return t})},e.prototype.nodeDefaultColor=function(t){return t&&t.color||this.settings.main.color.node||e.nodeColor},e.prototype.nodeDefaultRadius=function(t){var i=$.extend(!0,{},this.settings.main.radius,this.settings.main.nodeSettings.radius);return i.normal||e.normalRadius},e.prototype.nodeImageShow=function(t,e){var i=!0;if(t){var n=t.nodeStyle;if(i=n&&n.showImage,"boolean"!=typeof i){e=e||this.getNodeLegend(t);var o=e&&e.extra;i=o&&o.showImage}}return i},e.prototype.nodeImage=function(t,e){return t.img},e.prototype.nodeLabelColor=function(t,e){var i;if(t){var n=t.labelStyle;if(i=n&&n.color,!i){e=e||this.getNodeLegend(t);var o=e&&e.extra;i=o&&o.labelColor,i||(i=this.nodeLabelDefaultColor(e))}}else i=this.nodeLabelDefaultColor();return i},e.prototype.nodeLabelDefaultColor=function(t){return"#333"},e.prototype.nodeLabelShow=function(t,e){var i=!0;if(t){var n=t.labelStyle;if(i=n&&n.show,"boolean"!=typeof i){e=e||this.getNodeLegend(t);var o=e&&e.extra;i=o&&o.showLabel}}return i},e.prototype.nodeLabelPosition=function(t,e){return"outer"},e.prototype.nodeRadius=function(t,e){e=e||this.getNodeLegend(t);var i=this.nodeDefaultRadius(e);return e&&e.extra?e.extra.radius||i:i},e.prototype.nodeStatus=function(t,e){var i=t.status||this.nodeStatusMap[t.id]||(this.isFixedNode(t.id)?"emphasis":"");return i?i:(e=e||this.getNodeLegend(t),e&&e.status)},e.prototype.paint=function(t){this.updateStyle()},e.prototype.reload=function(){return this.load(this.loadParams,"reload")},e.prototype.setEmphasisLink=function(t){this.updateLinkStatus(t,"emphasis")},e.prototype.setEmphasisNode=function(t){this.updateNodeStatus(t,"emphasis")},e.prototype.setLockedLink=function(t){this.updateLinkStatus(t,"normal")},e.prototype.setLockedNode=function(t){this.updateNodeStatus(t,"normal")},e.prototype.setReducedLink=function(t){this.updateLinkStatus(t,"reduce")},e.prototype.setReducedNode=function(t){this.updateNodeStatus(t,"reduce")},e.prototype.setAvailableDataFilter=function(t){this.availableDataFilters||(this.availableDataFilters=[]);var e=lodash_1.findIndex(this.availableDataFilters,["type",t.type]);e?this.availableDataFilters.splice(e,1,t):this.availableDataFilters.push(t)},e.prototype.setFilter=function(t){this.filters||(this.filters=[]);var e=lodash_1.findIndex(this.filters,["type",t.type]);e>=0?this.filters.splice(e,1,t):this.filters.push(t)},e.prototype.restoreSnapshot=function(t){common_1.PdCommonUtils.error("Snapshot restore is not support yet.")},e.prototype.takeSnapshot=function(t,e){common_1.PdCommonUtils.error("Snapshot is not support yet.")},e.prototype.updateLinkLegend=function(t){lodash_1.isEqual(this.linkLegends,t)||(this.linkLegends=t,this.dispatch("linklegendupdate",{legends:this.linkLegends}))},e.prototype.updateLinkLength=function(t){this.linkLength=t,this.updateStyle()},e.prototype.updateLinkStatus=function(t,e){void 0===e&&(e=""),this.linkStatusMap||(this.linkStatusMap={});for(var i=0,n=t;i<n.length;i++){var o=n[i];e?this.linkStatusMap[o]=e:delete this.linkStatusMap[o]}},e.prototype.updateNodeLegend=function(t){lodash_1.isEqual(this.nodeLegends,t)||(this.nodeLegends=lodash_1.cloneDeep(t),this.dispatch("nodelegendupdate",{legends:lodash_1.cloneDeep(this.nodeLegends)}))},e.prototype.updateNodeLabelPosition=function(t){this.nodeLabelPositionUpdatable()&&console.error("Display update is not support")},e.prototype.updateNodeStatus=function(t,e){void 0===e&&(e=""),this.nodeStatusMap||(this.nodeStatusMap={});for(var i=0,n=t;i<n.length;i++){var o=n[i];e?this.nodeStatusMap[o]=e:delete this.nodeStatusMap[o]}},e.prototype.created=function(){var e=this;t.prototype.created.call(this),this.setFilter({type:"legend",filter:function(t){return e.legendFilter(t)}})},e.prototype.initMainPanel=function(){this.addViewPanel('<div class="pdvis-main-container"></div>',"netChartView",{active:!0,title:"图谱展示",icon:bubble_chart_1["default"](24)}),this.$mainContainer=this.select(".pdvis-main-container")},e.prototype.initSettings=function(i){return $.extend(!0,{},t.prototype.initSettings.call(this,e.defaultSettings),i)},e.prototype.linkColorFunction=function(t,i,n){i=i||this.getLinkLegend(t),n=n||this.linkStatus(t,i);var o=t.color||this.linkDefaultColor(i),a=this.settings.main.color.reduce||e.reduceColor,s=this.settings.main.color.emphasis||e.emphasisColor;return{normal:o,reduce:a,emphasis:s}[n||"normal"]},e.prototype.linkRadiusFunction=function(t,e,i){e=e||this.getLinkLegend(t),i=i||this.linkStatus(t,e);var n=this.settings.main.linkSettings.radius,o=this.linkRadius(t,e),a=n.reduce||o*(n.reduceRatio||1),s=n.emphasis||o*(n.emphasisRatio||1.5);return{normal:o,reduce:a,emphasis:s}[i||"normal"]},e.prototype.mounted=function(){var e=this;t.prototype.mounted.call(this),this.settings.payload&&setTimeout(function(){e.drawNewData(e.settings.payload.data,e.settings.payload.loadParams)},0)},e.prototype.nodeColorFunction=function(t,i,n){i=i||this.getNodeLegend(t),n=n||this.nodeStatus(t,i);var o=t.color||this.nodeDefaultColor(i),a=this.settings.main.color.reduce||e.reduceColor,s=this.settings.main.color.emphasis||e.emphasisColor;return{normal:o,reduce:a,emphasis:s}[n||"normal"]},e.prototype.nodeDblClick=function(t){this.eventData.node=t,this.dispatch("nodeDblClick",this.eventData)},e.prototype.nodeRadiusFunction=function(t,e,i){e=e||this.getNodeLegend(t),i=i||this.nodeStatus(t,e);var n=$.extend(!0,{},this.settings.main.radius,this.settings.main.nodeSettings.radius),o=this.nodeRadius(t,e),a=n.reduce||o*(n.reduceRatio||.8),s=n.emphasis||o*(n.emphasisRatio||1.5);return{normal:o,reduce:a,emphasis:s}[i||"normal"]},e.prototype.preprocessData=function(){for(var e=0,i=this.data.nodes;e<i.length;e++){var n=i[e];n.id=n.id.toString(),n.classId=n.classId.toString()}for(var o=0,a=this.data.links;o<a.length;o++){var n=a[o];n.id||(n.id=common_1.PdCommonUtils.createId("virtual-")),n.from=n.from.toString(),n.to=n.to.toString()}t.prototype.preprocessData.call(this)},e.emphasisColor="#faa01b",e.primaryColor="#00b38a",e.linkColor="#aaa",e.nodeColor=e.primaryColor,e.reduceColor="#ddd",e.normalRadius=20,e.emphasisRadius=1.5*e.normalRadius,e.defaultSettings={main:{radius:{emphasisRatio:1.5,normal:e.normalRadius,reduceRatio:.8},color:{node:e.nodeColor,link:e.linkColor,emphasis:e.emphasisColor,reduce:e.reduceColor},nodeSettings:{},linkSettings:{radius:{emphasisRatio:1.5,normal:1}},extend:!1}},e}(chart_1.PdVisChart);exports.PdVisNetChart=PdVisNetChart;