"use strict";var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery");require("daterangepicker");var lodash_1=require("lodash"),plugin_1=require("../plugin"),form_1=require("../../../../ui/components/form/form"),edit_item_1=require("../../../utils/edit-item/edit-item"),common_1=require("../../../../common/common"),dialog_1=require("../../../utils/modal/dialog/dialog"),confirm_1=require("../../../utils/modal/confirm/confirm"),add_1=require("../../../../icon/add"),PdVisPluginEdit=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.destroy=function(){this.editDialog&&this.editDialog.destroy(),this.deleteDialog&&this.deleteDialog.destroy(),t.prototype.destroy.call(this)},e.prototype.getData=function(){for(var t=this.getMainContainer(),e={},i=0,n=this.settings.editItemSettings;i<n.length;i++){var o=n[i],a=t.find('[data-path="'+o.key+'"]');if(o.getValue)e[o.key]=o.getValue(o,a);else{var r=form_1.PdUIForm.getFormData(a);for(var d in r)r.hasOwnProperty(d)&&(e[d]=r[d])}switch(o.type){case"dateRange":case"datetimeRange":var s=" - ";e[o.key].indexOf(s)>0&&(e[o.key]=e[o.key].split(s))}}return e},e.prototype.setData=function(t,e){void 0===t&&(t={}),void 0===e&&(e=!1);for(var i=this.getMainContainer(),n=0,o=this.settings.editItemSettings;n<o.length;n++){var a=o[n],r=i.find('[data-path="'+a.key+'"]');a.setValue?a.setValue(a,r,t[a.key]):form_1.PdUIForm.setFormData(r,t)}this.updateAllSelectAllStatus()},e.prototype.bindEvent=function(){var e=this;t.prototype.bindEvent.call(this);for(var i={},n=function(t){if("checkbox"===t.type){var e=t.options,n=lodash_1.filter(e,function(t){return t&&t.children&&t.children.length}).length>0;if(n){var o={};i[t.key]=o;var a=function(t,e){for(var i=function(i){o[i._path.toString()]={brother:lodash_1.filter(t,function(t){return t!==i}),self:i,children:i.children,parent:e},i.children&&a(i.children,i)},n=0,r=t;n<r.length;n++){var d=r[n];i(d)}};a(e)}}},o=0,a=this.settings.editItemSettings;o<a.length;o++){var r=a[o];n(r)}this.getMainContainer().on("click",'.pdvis-cr-child input[type="checkbox"]',function(t){var n=$(t.currentTarget),o=n.closest(".pdvis-edit-item").attr("data-path"),a=lodash_1.find(e.settings.editItemSettings,["key",o]);if(i[o]&&!a.treeNodeAutoUpdateDisabled){var r=n.closest(".pdvis-cr-child").attr("data-option-path"),d=e.getData(),s=n.prop("checked"),l=i[o][r],c=function(t){if(t&&t.length)for(var e=function(t){s?lodash_1.indexOf(d[o],t.value)<0&&d[o].push(t.value):lodash_1.remove(d[o],function(e){return e===t.value}),c(t.children)},i=0,n=t;i<n.length;i++){var a=n[i];e(a)}};c(l.children);var p=function(t){if(t.parent){var e=lodash_1.filter(lodash_1.concat(t.brother,[t.self]),function(t){return lodash_1.indexOf(d[o],t.value)<0}).length;e?lodash_1.remove(d[o],function(e){return e===t.parent.value}):lodash_1.indexOf(d[o],t.parent.value)<0&&d[o].push(t.parent.value),p(i[o][t.parent._path.toString()])}};p(l),e.setData(d,!0)}}).on("click",'.pdvis-edit-item-selected-all [type="checkbox"]',function(t){var e=$(t.target).closest(".pdvis-edit-item");e.find('[type="checkbox"][name]').prop("checked",t.target.checked)}).on("click",'.pdui-checkbox [type="checkbox"][name]',function(t){var i=$(t.currentTarget).attr("name");e.updateSelectAllStatus(i)}).on("click",".pdvis-edit-item-remove",function(t){var i=$(t.currentTarget),n=i.closest(".pdvis-edit-item").attr("data-path"),o=e.getEditSettings(e.settings.editItemSettings,n);e.deleteDialog&&e.deleteDialog.destroy(),e.showDeleteDialog(t,o)}).on("click",".pdvis-edit-item-config",function(t){var i=$(t.currentTarget),n=i.closest(".pdvis-edit-item").attr("data-path"),o=e.getEditSettings(e.settings.editItemSettings,n);e.editDialog&&e.editDialog.destroy(),e.showEditDialog(t,o)}).on("click",".pdvis-edit-item-add button",function(t){e.editDialog&&e.editDialog.destroy(),e.showAddDialog(t)}).on("click","ul.pdvis-cr-box .pdvis-cr-item",function(t){0===$(t.target).closest("label").length&&$(t.currentTarget).parent("li").toggleClass("open")})},e.prototype.buildEdit=function(){for(var t=$("<div></div>"),e=0,i=this.settings.editItemSettings;e<i.length;e++){var n=i[e];n.type||(n.type=n.selected instanceof Array?"checkbox":"radio"),"checkbox"===n.type&&(n.options=common_1.PdCommonUtils.transferOption(n.options,n.selected)),n.disabled||t.append(this.gentEditItem(n))}if(this.settings.add&&this.settings.add.enable){var o=add_1["default"](24),a=common_1.PdCommonUtils.createId("pd-edit-");t.append('<div class="pdvis-edit-item-add"><button class="pdui-btn pdui-btn-primary-outline" data-id="'+a+'">'+o+this.settings.add.title+"</button></div>")}return t.children()},e.prototype.gentEditItem=function(t){return t.mode=t.mode||this.settings.mode,edit_item_1.PdVisEditItem.gentEditItem(t)},e.prototype.getEditSettings=function(t,e){var i=e.split("."),n=i[0],o=lodash_1.find(t,["key",n]);return i.length>1?o.children?this.getEditSettings(o.children,e.substring(e.indexOf(".")+1)):null:o},e.prototype.initSettings=function(i){return $.extend(!0,{},t.prototype.initSettings.call(this,e.defaultSettings),i)},e.prototype.mounted=function(){t.prototype.mounted.call(this),this.updateEdit(this.settings.editItemSettings),this.updateAllSelectAllStatus(),this.bindEvent()},e.prototype.showAddDialog=function(t){var e=$.extend(!0,{body:edit_item_1.PdVisEditItem.createEditor()},this.settings.add);this.editDialog=new dialog_1.PdVisDialog(e),this.editDialog.open({event:t})},e.prototype.showDeleteDialog=function(t,e){this.deleteDialog=new confirm_1.PdVisConfirm($.extend(!0,{title:"删除确认",body:"确认删除吗？",positiveClick:function(){return $(t.currentTarget).closest(".pdvis-edit-item").remove(),Promise.resolve()}},e["delete"])),this.deleteDialog.open({event:t})},e.prototype.showEditDialog=function(t,e){var i=["label","key","children","type","value","required"];this.editDialog=new dialog_1.PdVisDialog($.extend(!0,{body:edit_item_1.PdVisEditItem.createEditor(e,i)},e.edit)),this.editDialog.open({event:t})},e.prototype.unbindEvent=function(){t.prototype.unbindEvent.call(this),this.getMainContainer().off("click",'.pdvis-edit-item-selected-all [type="checkbox"]')},e.prototype.updateAllSelectAllStatus=function(){var t={};this.getMainContainer().find('.pdui-checkbox [type="checkbox"][name]').each(function(e,i){t[$(i).attr("name")]=!0});for(var e in t)t.hasOwnProperty(e)&&this.updateSelectAllStatus(e)},e.prototype.updateEdit=function(t){void 0===t&&(t=[]);for(var e=0,i=t;e<i.length;e++){var n=i[e],o={locale:{applyLabel:"确定",cancelLabel:"取消"},buttonClasses:"pdui-btn pdui-btn-sm",applyButtonClasses:"pdui-btn-primary",cancelClass:"pdui-btn-primary-outline"},a=this.select('input[name="'+n.key+'"]');switch(n.type){case"date":$.extend(!0,o,{locale:{format:"YYYY-MM-DD"},autoApply:!0,singleDatePicker:!0}),a.daterangepicker(o);break;case"datetime":$.extend(!0,o,{locale:{format:"YYYY-MM-DD HH:mm:ss"},timePicker:!0,timePickerSeconds:!0,autoApply:!0,singleDatePicker:!0}),a.daterangepicker(o);break;case"dateRange":$.extend(!0,o,{locale:{format:"YYYY-MM-DD"}}),a.daterangepicker(o);break;case"datetimeRange":$.extend(!0,o,{locale:{format:"YYYY-MM-DD HH:mm:ss"},timePicker:!0,timePickerSeconds:!0}),a.daterangepicker(o);break;case"group":this.updateEdit(n.children)}}},e.prototype.updateSelectAllStatus=function(t){var e=this.getMainContainer().find(".pdvis-edit-item-content").find("input[name="+t+"]"),i=e.filter('[type="checkbox"]:checked'),n=e.closest(".pdvis-edit-item").find(".pdvis-edit-item-selected-all").find("input");e.length===i.length?n.prop("checked",!0):n.prop("checked",!1)},e.defaultSettings={side:"right",editItemSettings:[],mode:"label",add:{title:"添加"}},e}(plugin_1.PdVisPlugin);exports.PdVisPluginEdit=PdVisPluginEdit;