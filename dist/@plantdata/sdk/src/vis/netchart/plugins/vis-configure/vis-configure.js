"use strict";var __extends=this&&this.__extends||function(){var e=function(i,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,i){e.__proto__=i}||function(e,i){for(var n in i)i.hasOwnProperty(n)&&(e[n]=i[n])})(i,n)};return function(i,n){function t(){this.constructor=i}e(i,n),i.prototype=null===n?Object.create(n):(t.prototype=n.prototype,new t)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),settings_1=require("../../../../icon/settings"),plugin_1=require("../plugin"),slider_1=require("../../../utils/slider/slider"),common_1=require("../../../../common/common"),checkbox_1=require("../../../../ui/components/checkbox/checkbox"),color_picker_1=require("../../../utils/color-picker/color-picker"),radio_1=require("../../../../ui/components/radio/radio"),PdVisPluginVisConfigure=function(e){function i(i){var n=e.call(this,i)||this;return n.allLinkShow=!1,n.allNodeShow=!1,n.nodeShowType="shape",n.linkShowType="shape",n.linkSettings=[],n.nodeSettings=[],n}return __extends(i,e),i.prototype.addConfig=function(e,i,n){var t=$('<div class="pdvis-vis-configure-item" data-type="'+n+'"><div class="pdvis-vis-configure-title"></div><div class="pdvis-vis-configure-content"></div></div>');t.find(".pdvis-vis-configure-title").append(e),t.find(".pdvis-vis-configure-content").append(i),this.select(".pdvis-vis-configure-body").append(t)},i.prototype.getPluginType=function(){return"visConfigure"},i.prototype.updateConfig=function(e,i){void 0===i&&(i={});var n=this.select('.pdvis-vis-configure-item[data-type="'+e+'"]');n.find(".pdvis-vis-configure-title").html(i.title),n.find(".pdvis-vis-configure-content").html(i.content)},i.prototype.addLinkLengthPanel=function(){var e=this,i=$('<div class="pdvis-vis-configure-link-length"></div>');this.addConfig("排斥间距:",i,"link-length");var n=$.extend(!0,{selector:i,change:function(i){for(var n=0,t=e.linkSettings;n<t.length;n++){var o=t[n];lodash_1.set(o,"extra.length",i)}e.linkSettingsChange(null),e.updateLinkConfigPanel()}},this.settings.lengthSettings);this.lengthSlider=new slider_1.PdVisSlider(n)},i.prototype.addNodeDisplayPanel=function(){var e=this.container.nodeLabelPosition(),i=radio_1.PdUIRadio.create({html:"文字置底",input:{atts:{value:"outer",checked:"outer"===e,name:this.insId+"-display"}}}),n=radio_1.PdUIRadio.create({html:"文字内嵌",input:{atts:{value:"inner",checked:"inner"===e,name:this.insId+"-display"}}}),t=$('<div class="pdvis-vis-configure-node-display">'+i+n+"</div>");this.addConfig("节点标签:",t,"node-display")},i.prototype.createLinkNodeSettingsPanel=function(e){void 0===e&&(e="node");var i,n="node"===e,t=n?this.nodeShowType:this.linkShowType;i=n?{shape:"节点",label:"标签"}:{shape:"边",label:"标签"};var o="";for(var s in i)if(i.hasOwnProperty(s)){var a=t===s?"selected":"";o+='<option value="'+s+'" '+a+">"+i[s]+"</option>"}for(var r='<select class="pdvis-vis-configure-type pdvis-vis-configure-type-'+e+'">'+o+"</select>",d="",l=n?this.nodeSettings:this.linkSettings,c=n?this.allNodeShow:this.allLinkShow,p=!0,u=!0,v=!0,h=!0,g=!0,f=!0,k=0,b=l;k<b.length;k++){var S=b[k];if(c||S.disabled!==!0){var y=[];if("shape"===t){var w=checkbox_1.PdUICheckbox.create({html:S.value,cls:"pdvis-vis-configure-visible",input:{atts:{name:"visible",checked:!S.hidden,disabled:S.disabled===!0}}});w='<div class="line-hidden">'+w+"</div>",S.hidden&&(p=!1);var m='<span class="pdvis-vis-configure-color" style="background: '+S.color+'" name="color"></span>',P=checkbox_1.PdUICheckbox.create({html:"",cls:"pdvis-vis-configure-vague",input:{atts:{name:"status",checked:"reduce"===S.status}}});if("reduce"!==S.status&&(v=!1),n){var C='<span class="pdvis-vis-configure-radius" name="radius">'+S.extra.radius+"</span>",x=checkbox_1.PdUICheckbox.create({html:"",cls:"pdvis-vis-configure-show-image",input:{atts:{name:"showImage",checked:S.extra.showImage===!0}}});S.extra.showImage!==!0&&(h=!1),y=[w,m,C,P,x]}else{var _=checkbox_1.PdUICheckbox.create({html:"",cls:"pdvis-vis-configure-show-arrow",input:{atts:{name:"showArrow",checked:S.extra.showArrow===!0}}});S.extra.showArrow!==!0&&(g=!1);var C='<span class="pdvis-vis-configure-radius" name="radius">'+S.extra.radius+"/"+S.extra.length+"</span>";y=[w,m,C,P,_]}}else if("label"===t){var L=checkbox_1.PdUICheckbox.create({html:S.value,cls:"pdvis-vis-configure-show-label",input:{atts:{name:"showLabel",checked:S.extra.showLabel===!0}}});L='<div class="line-hidden">'+L+"</div>",S.extra.showLabel!==!0&&(u=!1);var T=S.extra.labelColor,N=n?S.color:"#fff",m='<span class="pdvis-vis-configure-color pdvis-vis-configure-color-text" style="color: '+T+"; background: "+N+'" name="color">T</span>';if(n){if(y=[L,m],this.container.nodeLabelPositionUpdatable()){var $=checkbox_1.PdUICheckbox.create({html:"",cls:"pdvis-vis-configure-inner-label",input:{atts:{name:"innerLabel",checked:S.extra.innerLabel===!0}}});S.extra.innerLabel!==!0&&(f=!1),y.push($)}}else{var I=S,U="-",V=I.displayAtts;if(V&&V.length){for(var q='<option value="">边类型</option>',A=0,D=V;A<D.length;A++){var E=D[A],a=I.displayAtt===E.value?"selected":"";q+='<option value="'+E.value+'" '+a+">"+E.label+"</option>"}U='<select class="pdui-select pdvis-vis-configure-display-att">'+q+"</select>"}y=[L,U,m]}}d+='<tr data-id="'+S.key+'"><td>'+y.join("</td><td>")+"</td></tr>"}}var O=[],j=[];if("shape"===t){var w=checkbox_1.PdUICheckbox.create({html:"全部",cls:"pdvis-vis-configure-visible",input:{atts:{name:"visible",checked:p}}});w='<div class="line-hidden">'+w+"</div>";var P=checkbox_1.PdUICheckbox.create({html:"",cls:"pdvis-vis-configure-vague",input:{atts:{name:"status",checked:v}}}),m='<span class="pdvis-vis-configure-color" name="color">C</span>';if(n){var C='<span class="pdvis-vis-configure-radius" name="radius">R</span>',x=checkbox_1.PdUICheckbox.create({html:"",cls:"pdvis-vis-configure-show-image",input:{atts:{name:"showImage",checked:h}}});O=[w,m,C,P,x],j=[r,"颜色","半径","虚化","图片"]}else{var C='<span class="pdvis-vis-configure-radius" name="radius">W/L</span>',_=checkbox_1.PdUICheckbox.create({html:"",cls:"pdvis-vis-configure-show-arrow",input:{atts:{name:"showArrow",checked:g}}});O=[w,m,C,P,_],j=[r,"颜色","宽/长","虚化","箭头"]}}else if("label"===t){var L=checkbox_1.PdUICheckbox.create({html:"全部",cls:"pdvis-vis-configure-show-label",input:{atts:{name:"showLabel",checked:u}}});L='<div class="line-hidden">'+L+"</div>";var m='<span class="pdvis-vis-configure-color pdvis-vis-configure-color-text" name="color">C</span>';if(n){if(O=[L,m],j=[r,"颜色"],this.container.nodeLabelPositionUpdatable()){var $=checkbox_1.PdUICheckbox.create({html:"",cls:"pdvis-vis-configure-inner-label",input:{atts:{name:"innerLabel",checked:f}}});O.push($),j.push("内嵌")}}else O=[L,"-",m],j=[r,"显示值","颜色"]}var R='<tr class="pdvis-vis-configure-all"><td>'+O.join("</td><td>")+"</td></tr>";return'<table class="pdui-table pdvis-vis-configure-'+e+'"><thead><tr><th>'+j.join("</th><th>")+"</tr></thead><tbody>"+R+d+"</tbody></table>"},i.prototype.createLinkSettingsPanel=function(){return this.updateLinkSetting(),this.createLinkNodeSettingsPanel("link")},i.prototype.createNodeSettingsPanel=function(){return this.updateNodeSetting(),this.createLinkNodeSettingsPanel("node")},i.prototype.bindEvent=function(){var i=this;e.prototype.bindEvent.call(this);var n=function(e,n,t){var o=e.closest("tr"),s=o.attr("data-id"),a=e.closest("table").hasClass("pdvis-vis-configure-node");if(s)if(a){var r=lodash_1.find(i.nodeSettings,function(e){return e.key.toString()===s});lodash_1.set(r,n,t),i.nodeSettingsChange(r),i.updateNodeConfigPanel()}else{var r=lodash_1.find(i.linkSettings,function(e){return e.key.toString()===s});lodash_1.set(r,n,t),i.linkSettingsChange(r),i.updateLinkConfigPanel()}else if(a){for(var d=0,l=i.nodeSettings;d<l.length;d++){var r=l[d];lodash_1.set(r,n,t)}i.nodeSettingsChange(null),i.updateNodeConfigPanel()}else{for(var c=0,p=i.linkSettings;c<p.length;c++){var r=p[c];lodash_1.set(r,n,t)}i.linkSettingsChange(null),i.updateLinkConfigPanel()}};this.$el.on("click",".pdvis-vis-configure-node-all input",function(e){var n=$(e.currentTarget);i.allNodeShow=n.prop("checked"),i.updateNodeConfigPanel()}).on("click",".pdvis-vis-configure-link-all input",function(e){var n=$(e.currentTarget);i.allLinkShow=n.prop("checked"),i.updateLinkConfigPanel()}).on("click",".pdvis-vis-configure-radius",function(e){var t=$(e.currentTarget),o=t.closest("table").hasClass("pdvis-vis-configure-node"),s=t.offset(),a=$('<div class="pdvis-namespace pdvis-vis-configure-mask"></div>');a.appendTo("body"),a.one("click",function(e){i.radiusSlider&&i.radiusSlider.destroy(),i.lSlider&&i.lSlider.destroy(),$(e.currentTarget).remove()});var r=$('<div class="pdvis-vis-configure-radius-slider"></div>'),d=$('<div class="pdvis-vis-configure-slider-radius"><div class="pdvis-vis-configure-slider-label">'+(o?"R":"W")+'</div><div class="pdvis-vis-configure-slider-bar"></div></div>').appendTo(r);i.radiusSlider&&i.radiusSlider.destroy(),i.radiusSlider=new slider_1.PdVisSlider({selector:d.find(".pdvis-vis-configure-slider-bar"),min:o?5:1,max:o?50:8,value:parseInt($(e.currentTarget).text(),10)||(o?20:1),vertical:!0,height:100,change:function(e){n(t,"extra.radius",e)}});var l=s.left-12;if(!o){i.lSlider&&i.lSlider.destroy();var c=$('<div class="pdvis-vis-configure-slider-length"><div class="pdvis-vis-configure-slider-label">L</div><div class="pdvis-vis-configure-slider-bar"></div></div>').appendTo(r);i.lSlider=new slider_1.PdVisSlider({selector:c.find(".pdvis-vis-configure-slider-bar"),min:0,max:5,value:parseInt($(e.currentTarget).text(),10)||1,vertical:!0,height:100,change:function(e){n(t,"extra.length",e)}}),l=s.left-24}var p=s.top+24,u=common_1.PdCommonUtils.getViewport();l+100>u.left+u.width&&(l-=100),p+150>u.top+u.height&&(p-=150),r.css({left:l,top:p}).on("click",function(e){e.stopPropagation()}).appendTo(a)}).on("click",".pdvis-vis-configure-switch-node input",function(e){var n=$(e.currentTarget),t=n.prop("checked");i.nodeShowType=t?"shape":"label",i.updateNodeConfigPanel()}).on("click",".pdvis-vis-configure-switch-link input",function(e){var n=$(e.currentTarget),t=n.prop("checked");i.linkShowType=t?"shape":"label",i.updateLinkConfigPanel()}).on("change",".pdvis-vis-configure-type-node",function(e){var n=$(e.currentTarget);i.nodeShowType=n.val(),i.updateNodeConfigPanel()}).on("change",".pdvis-vis-configure-type-link",function(e){var n=$(e.currentTarget);i.linkShowType=n.val(),i.updateLinkConfigPanel()}).on("click",".pdvis-vis-configure-vague input",function(e){var i=$(e.currentTarget),t=i.prop("checked");n(i,"status",t?"reduce":"")}).on("change",".pdvis-vis-configure-display-att",function(e){var i=$(e.currentTarget),t=i.val();n(i,"displayAtt",t)}).on("click",".pdvis-vis-configure-show-label input",function(e){var i=$(e.currentTarget),t=i.prop("checked");n(i,"extra.showLabel",t)}).on("click",".pdvis-vis-configure-visible input",function(e){var i=$(e.currentTarget),t=i.prop("checked");n(i,"hidden",!t)}).on("click",".pdvis-vis-configure-show-image input",function(e){var i=$(e.currentTarget),t=i.prop("checked");n(i,"extra.showImage",t)}).on("click",".pdvis-vis-configure-show-arrow input",function(e){var i=$(e.currentTarget),t=i.prop("checked");n(i,"extra.showArrow",t)}).on("click",".pdvis-vis-configure-inner-label input",function(e){var i=$(e.currentTarget),t=i.prop("checked");n(i,"extra.innerLabel",t)}).on("click",".pdvis-vis-configure-node-display input",function(e){for(var n=$(e.currentTarget),t=n.val(),o=0,s=i.nodeSettings;o<s.length;o++){var a=s[o];lodash_1.set(a,"extra.innerLabel","inner"===t)}i.nodeSettingsChange(null),i.updateNodeConfigPanel()}).on("click",".pdvis-vis-configure-color",function(e){var i=$(e.currentTarget),t=i.hasClass("pdvis-vis-configure-color-text"),o=i.css(t?"color":"background-color");i.closest("tr").hasClass("pdvis-vis-configure-all")&&(o="#00b38a");var s=t?"extra.labelColor":"color",a=new color_picker_1.PdVisColorPicker({color:o,selector:e.currentTarget,onSubmit:function(e,t,o,r){n(i,s,t),a.destroy()}})}),this.addEvent("beforedraw",function(e){i.updateNodeConfigPanel(),i.updateLinkConfigPanel()}),this.addEvent("nodelegendupdate",function(e){i.updateNodeConfigPanel()}),this.addEvent("linklegendupdate",function(e){i.updateLinkConfigPanel()}),this.addEvent("takeSnapshot",function(e){e.snapshot.visConfigure={length:i.lengthSlider.getValue(),allLinkShow:i.allLinkShow,allNodeShow:i.allNodeShow,linkShowType:i.linkShowType,nodeShowType:i.nodeShowType,nodeDisplay:i.select(".pdvis-vis-configure-node-display input:checked").val()}}),this.addEvent("restoreSnapshot",function(e){var n=e.snapshot.visConfigure,t=n.nodeShowType,o=n.linkShowType,s=n.allLinkShow,a=n.allNodeShow,r=n.length,d=n.nodeDisplay;i.select('.pdvis-vis-configure-node-display input[value="'+d+'"]').prop("checked",!0),i.nodeShowType!==t&&(i.nodeShowType=t),i.linkShowType!==o&&(i.linkShowType=o),i.allLinkShow!==s&&(i.allLinkShow=s),i.allNodeShow!==a&&(i.allNodeShow=a),i.updateLinkConfigPanel(),i.updateNodeConfigPanel(),i.lengthSlider.setValue(r)})},i.prototype.createConfigPanel=function(){this.addLinkLengthPanel(),this.container.nodeLabelPositionUpdatable()&&this.addNodeDisplayPanel();var e=checkbox_1.PdUICheckbox.create({html:"全部选项",cls:"pdvis-vis-configure-node-all",input:{atts:{checked:this.allNodeShow}}});this.addConfig("节点样式:"+e,this.createNodeSettingsPanel(),"node");var i=checkbox_1.PdUICheckbox.create({html:"全部选项",cls:"pdvis-vis-configure-link-all",input:{atts:{checked:this.allLinkShow}}});this.addConfig("边样式:"+i,this.createLinkSettingsPanel(),"link")},i.prototype.getMainContainer=function(){return this.select(".pdvis-vis-configure-panel")},i.prototype.initSettings=function(n){return $.extend(!0,{},e.prototype.initSettings.call(this,i.defaultSettings),n)},i.prototype.initTemplate=function(){var e="可视化配置",i=settings_1["default"](20),n='<div class="pdvis-vis-configure-panel"><div class="pdvis-vis-configure-body"></div></div>';return this.buildPluginTemplate(n,i,e)},i.prototype.linkSettingsChange=function(e){this.container.updateLinkLegend(this.linkSettings),this.container.updateChart()},i.prototype.mounted=function(){e.prototype.mounted.call(this),this.createConfigPanel(),this.bindEvent()},i.prototype.nodeSettingsChange=function(e){this.container.updateNodeLegend(this.nodeSettings),this.container.updateChart()},i.prototype.updateLinkConfigPanel=function(){this.updateConfig("link",{content:this.createLinkSettingsPanel()})},i.prototype.updateNodeConfigPanel=function(){this.updateConfig("node",{content:this.createNodeSettingsPanel()})},i.prototype.updateLinkSetting=function(){var e=lodash_1.cloneDeep(this.container.getLinkLegends()),i=this.container.getData();if(i)for(var n=lodash_1.uniq(lodash_1.map(i.links,"attId")),t=0,o=e;t<o.length;t++){var s=o[t];s.disabled=void 0===s.disabled?lodash_1.indexOf(n,s.key)<0:s.disabled}this.linkSettings=e},i.prototype.updateNodeSetting=function(){var e=lodash_1.cloneDeep(this.container.getNodeLegends()),i=this.container.getData();if(i)for(var n=lodash_1.uniq(lodash_1.map(i.nodes,"classId")),t=0,o=e;t<o.length;t++){var s=o[t];s.disabled=void 0===s.disabled?lodash_1.indexOf(n,s.key)<0:s.disabled}this.nodeSettings=e},i.defaultSettings={side:"right",lengthSettings:{value:1,step:.5,max:5,min:0}},i}(plugin_1.PdVisPlugin);exports.PdVisPluginVisConfigure=PdVisPluginVisConfigure;