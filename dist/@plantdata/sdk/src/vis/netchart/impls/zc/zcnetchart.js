"use strict";var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function o(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(o.prototype=i.prototype,new o)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),zcnetchart_1=require("../../zcnetchart"),netchart_1=require("../../netchart"),validators_1=require("../../../../common/validators"),common_1=require("../../../../common/common"),tooltip_1=require("../../../../ui/components/tooltip/tooltip"),PdVisZcNetChart=function(t){function e(e){var i=t.call(this,e)||this;return i.toolbarEnable=!0,i}return __extends(e,t),e.prototype.back=function(){t.prototype.back.call(this)},e.prototype.nodeLabelPositionUpdatable=function(){return!0},e.prototype.enableBack=function(){this.updateBackStatus()},e.prototype.goHistory=function(e){t.prototype.goHistory.call(this,e),this.updateBackStatus()},e.prototype.highlightPath=function(t,e,i){if(void 0===i&&(i=!1),this.highlightPathData={nodesId:[],linksId:[]},t&&t.length||e&&0!==e){if(i)this.getShortHighlightPathData(t,e.toString());else{var o=lodash_1.groupBy(this.getData().links,"from");this.getAllHighlightPathData(t,e.toString(),o)}this.setEmphasisLink(this.highlightPathData.linksId),this.setEmphasisNode(this.highlightPathData.nodesId),this.updateStyle()}else this.clearEmphasisLink(),this.clearEmphasisNode(),this.updateStyle()},e.prototype.linkDefaultLength=function(t,e){var i=this.settings.main.settings.style;return i.link&&i.link.length&&(this.linkLength=i.link.length),this.linkLength},e.prototype.linkStyleFunction=function(t){var e=t.data,i=this.getLinkLegend(t.data),o=this.linkStatus(e,i);if(t.length=this.linkLength,t.radius=this.linkRadiusFunction(e,i,o),t.lineDash=null,i&&i.dashed&&(t.radius=2,t.lineDash=[10,10]),this.linkLabelShow(e,i)===!1||"reduce"===o)t.label="";else if(t.label=e.displayName||e.attName,i&&i.displayAtt&&e.nRInfo&&e.nRInfo.length)for(var a=0,n=e.nRInfo;a<n.length;a++){var s=n[a],l=lodash_1.find(s.kvs,["k",i.displayAtt]);l&&(t.label=l.v)}var r=i&&i.extra;r&&r.length&&(t.length=i.extra.length),r&&i.extra.showArrow===!1||(t.toDecoration="arrow"),t.fillColor=this.linkColorFunction(e,i,o),t.labelStyle.textStyle.fillColor=this.linkLabelColor(e,i)},e.prototype.nodeImage=function(t,e){if(this.nodeImageShow(t,e)){var i=this.settings.main.nodeSettings;if(i.icon){var o=i.icon[t.classId];if(o)return"string"==typeof o?o:o.normal}else if(t.img)return 0!==t.img.indexOf("http")&&i.imgBuilder?i.imgBuilder(t.img):t.img}return""},e.prototype.nodeLabelDefaultColor=function(e){var i=this.settings.main.nodeSettings;if(i&&e&&i.textColors){var o=i.textColors[e.key];if(o)return"string"==typeof o?o:o.normal}return t.prototype.nodeLabelDefaultColor.call(this,e)},e.prototype.nodeLabelPosition=function(t,e){var i=this.settings.main.settings.style.node.display,o="roundtext"===i?"inner":"outer";if(t){var a=t.labelStyle;if(a&&a.position)o=a.position;else{e=e||this.getNodeLegend(t);var n=e&&e.extra;n&&"boolean"==typeof n.innerLabel&&(o=n.innerLabel?"inner":"outer")}}return o},e.prototype.nodeStyleFunction=function(t){var e=t.data,i=this.settings.main.nodeSettings||{},o=this.getNodeLegend(t.data),a=this.nodeStatus(e,o),n="emphasis"===a,s=this.nodeLabelPosition(e,o);if(this.lastDisplay="roundtext"===this.lastDisplay?"circle":this.lastDisplay,t.display="inner"===s?"roundtext":this.lastDisplay,t.radius=this.nodeRadiusFunction(e,o,a),t.lineDash=null,o&&o.dashed&&(t.lineDash=[8,2,8,2]),this.nodeLabelShow(e,o)===!1||"reduce"===a?t.label="":(t.label=e.name,"roundtext"===t.display&&i.autoSplit&&(t.label=this.splitText(t.label))),t.labelStyle.textStyle.font="18px Microsoft Yahei",t.labelStyle.textStyle.fillColor=this.nodeLabelColor(e,o),i.textColors){var l=i.textColors[e.classId];l&&"string"!=typeof l&&(n||t.hovered)&&(t.labelStyle.textStyle.fillColor=l.emphasis)}if(t.fillColor=this.nodeColorFunction(e,o,a),t.lineWidth=2,t.lineColor=t.fillColor,o&&o.outline&&(t.fillColor="#fff"),t.imageCropping="fit",this.nodeImageShow(e,o)){if(t.image=this.nodeImage(e,o),t.image&&(t.fillColor=i.imgFillColor||"#fff"),i.icon){var l=i.icon[e.classId];l&&"string"!=typeof l&&(n||t.hovered)&&(t.image=l.emphasis,t.fillColor=t.lineColor)}}else t.image=""},e.prototype.paint=function(t){this.chart.paintNow(t)},e.prototype.resetLayout=function(){this.chart.resetLayout()},e.prototype.resize=function(){this.chart.updateSize()},e.prototype.scrollIntoView=function(t){t&&t.id&&this.chart.scrollIntoView([t.id])},e.prototype.restoreSnapshot=function(t){var e=this.snapshotList[t];if(e){this.dispatch("restoreSnapshot",{snapshot:e}),this.updateLinkLegend(lodash_1.cloneDeep(e.linkLegends)),this.updateNodeLegend(lodash_1.cloneDeep(e.nodeLegends)),this.linkStatusMap=lodash_1.cloneDeep(e.linkStatusMap),this.nodeStatusMap=lodash_1.cloneDeep(e.nodeStatusMap),this.addData(e.data,e.lp),this.updateData();for(var i=0,o=e.nodes;i<o.length;i++){var a=o[i],n=this.chart.getNode(a.id.toString());n||a.invisible!==!1||(this.chart.showNode(a.id),n=this.chart.getNode(a.id.toString())),n&&$.extend(!0,n,a)}for(var s=0,l=e.links;s<l.length;s++){var a=l[s],r=this.chart.getLink(a.id.toString());$.extend(!0,r,a)}this.updateStyle()}},e.prototype.takeSnapshot=function(t,e){for(var i=this.getData(),o=lodash_1.map(this.chart.nodes(),function(t){return lodash_1.pick(t,["expanded","id","invisible","userLock","x","y"])}),a=lodash_1.map(this.chart.links(),function(t){return lodash_1.pick(t,["id","invisible","length "])}),n=0,s=i.nodes;n<s.length;n++){var l=s[n],r=lodash_1.find(o,["id",l.id]);r&&$.extend(!0,l,r)}for(var h=0,d=i.links;h<d.length;h++){var l=d[h],c=lodash_1.find(a,["id",l.id]);c&&$.extend(!0,l,c)}var p=(new Date).getTime(),u={id:common_1.PdCommonUtils.createId("snapshot-"),name:t,desc:e,createTime:p,lp:this.loadParams,data:i,linkLegends:lodash_1.cloneDeep(this.linkLegends),nodeLegends:lodash_1.cloneDeep(this.nodeLegends),linkStatusMap:lodash_1.cloneDeep(this.linkStatusMap),nodeStatusMap:lodash_1.cloneDeep(this.nodeStatusMap),links:a,nodes:o};this.snapshotList.push(u),this.dispatch("takeSnapshot",{snapshot:u})},e.prototype.updateBackStatus=function(){this.select(".pdvis-chart-his").toggleClass("disabled "+zcnetchart_1.ZNCPrefix+"bar-disabled",this.historyCursor<1)},e.prototype.updateData=function(){this.chart.replaceData(this.getData()||{nodes:[],links:[]}),this.dispatch("dataupdate",this.eventData)},e.prototype.updateNodeLabelPosition=function(t){var e="outer"===t?this.lastDisplay:"roundtext";this.chart.updateSettings({style:{node:{display:e}}})},e.prototype.updateStyle=function(){this.chart.updateStyle(),this.chart.updateSize(),this.dispatch("styleupdate",this.eventData)},e.prototype.buildToolbarCss=function(t,e){var i=this.settings.main.toolbarSettings,o=lodash_1.indexOf(i.expand,t)>=0?"active":"";return zcnetchart_1.ZNCPrefix+"bar-btn-"+(e||t)+" "+o},e.prototype.created=function(){var i=this,o={main:{settings:{advanced:{crossOriginHeader:"anonymous"},style:{multilinkSpacing:20,nodeDetailMinSize:10,selection:{lineWidth:10,lineColor:"rgba(250, 160, 27, 0.3)",shadowOffsetX:0,shadowOffsetY:0,shadowColor:netchart_1.PdVisNetChart.emphasisColor},nodeSelected:{radius:this.settings.main.radius.emphasis},node:{fillColor:netchart_1.PdVisNetChart.nodeColor,imageCropping:"crop",display:"circle"},nodeHovered:{shadowBlur:0,shadowColor:"rgba(0, 0, 0, 0)"},link:{fillColor:netchart_1.PdVisNetChart.linkColor},linkLabel:{backgroundStyle:{lineWidth:0},textStyle:{fillColor:"#666"},rotateWithLink:!0},nodeStyleFunction:function(t){i.nodeStyleFunction(t)},linkStyleFunction:function(t){i.linkStyleFunction(t)}},auras:{cellSize:4,overlap:!0,enabled:!0,defaultStyle:{shadowColor:"#fff",showInLegend:!0},style:{}},linkMenu:{contentsFunction:function(t){return netchart_1.PdVisNetChart.createLinkRInfo(t)||t.attName||""}},nodeMenu:{},navigation:{focusNodeExpansionRadius:0,numberOfFocusNodes:1},info:{enabled:!0,linkContentsFunction:netchart_1.PdVisNetChart.linkContentsFunction},toolbar:{enabled:!0,"export":!0,cssClass:"",align:"bottom",side:"right"},events:{onDoubleClick:function(t,e){i.onDoubleClick(t,e)}},localization:e.localization,interaction:{resizing:{enabled:!1}}},toolbarSettings:{size:"xs",expand:[]}}};this.settings=$.extend(!0,{},o,this.settings),this.lastDisplay=this.settings.main.settings.style.node.display,this.resetToolbarSettings(),t.prototype.created.call(this)},e.prototype.draw=function(){t.prototype.draw.call(this),this.updateBackStatus(),this.settings.main.autoRelayout&&this.resetLayout()},e.prototype.getAllHighlightPathData=function(t,e,i){this.highlightPathData.nodesId.push(e);for(var o=[];t.length>0;){var a=t.shift();if(a!==e&&o.indexOf(a)===-1){o.push(a);var n=i[a];for(var s in n)if(n.hasOwnProperty(s)){var l=n[s];this.highlightPathData.linksId.push(l.id),this.highlightPathData.nodesId.push(l.from.toString()),this.highlightPathData.nodesId.push(l.to.toString()),t.push(l.to.toString())}}}},e.prototype.getShortHighlightPathData=function(t,e){var i=this,o=function(t){for(var o,a,n,s=i.chart.getNode(t.toString()),l=i.chart.getNode(e.toString()),r={},h=[s];h.length>0&&(n=h.shift(),n!==l);)for(var d=0;d<n.links.length;d++)o=n.links[d],a=o.otherEnd(n),r[a.id]||(r[a.id]=o,h.push(a));for(;n!==s;)o=r[n.id],n=o.otherEnd(n),i.highlightPathData.nodesId.push(n.id.toString()),i.highlightPathData.linksId.push(o.id.toString());i.highlightPathData.nodesId.push(e.toString())};lodash_1.map(t,function(t){o(t.toString())})},e.prototype.initSettings=function(i){return $.extend(!0,{},t.prototype.initSettings.call(this,e.defaultSettings),i)},e.prototype.initChart=function(){var t=this.settings.main.settings;t.container=t.container||this.$mainContainer[0],this.chart=new zcnetchart_1.ZcNetChart.NetChart(t);var e=this.select(".pdvis-float-toolbar");e.find("."+zcnetchart_1.ZNCPrefix+"bar-btn").attr(tooltip_1.PdUITooltip.attrName,"hover").attr(tooltip_1.PdUITooltip.attrPosition,"left").on("click",function(t){tooltip_1.PdUITooltip.updateTooltip($(t.currentTarget))})},e.prototype.isVisibleTool=function(t){var e=this.settings.main.settings.toolbar.items||[];return 0===e.length||lodash_1.indexOf(e,t)>=0},e.prototype.onDoubleClick=function(t,e){e.clickNode&&!netchart_1.PdVisNetChart.idEquals(e.clickNode.data.id,this.loadParams.id)&&this.nodeDblClick(e.clickNode.data)},e.prototype.resetToolbarSettings=function(){var t=this,e=this.settings.main.settings,i=this.settings.main.toolbarSettings;if(e.toolbar.enabled){if(e.toolbar.cssClass="pdvis-float-toolbar "+(e.toolbar.cssClass||""),e.toolbar.extraItems=e.toolbar.extraItems||[],this.isVisibleTool("fit")&&e.toolbar.extraItems.push({item:"fit",cssClass:this.buildToolbarCss("fit")}),this.isVisibleTool("rearrange")&&e.toolbar.extraItems.push({item:"rearrange",cssClass:this.buildToolbarCss("rearrange")}),this.isVisibleTool("freeze")&&e.toolbar.extraItems.push({item:"freeze",cssClass:this.buildToolbarCss("freeze","lock-all")}),e.toolbar["export"]!==!1){e.toolbar["export"]=!1;var o=e.localization.toolbar.exportButton;e.toolbar.extraItems.push({label:o,cssClass:this.buildToolbarCss("export"),onClick:function(){try{var e=t.select("canvas")[0],i=e.toDataURL("image/png"),o=(new Date).getTime()+".png",a=document.createElement("a");a.download=o,a.target="_blank",a.href=i;var n=common_1.PdCommonUtils.getBrowserEnv();if("function"!=typeof MouseEvent||n.ie||n.edge)if(window.navigator.msSaveOrOpenBlob){for(var s=atob(i.split(",")[1]),l=s.length,r=new Uint8Array(l);l--;)r[l]=s.charCodeAt(l);window.navigator.msSaveOrOpenBlob(new Blob([r]),o)}else{var h='<body style="margin:0;"><img src="'+i+'" style="max-width:100%;" title="" /></body>',d=window.open();d.document.write(h)}else{var c=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});a.dispatchEvent(c)}}catch(p){p.message&&p.message.indexOf("toDataURL")>=0?common_1.PdCommonUtils.error("导出失败: 图中包含不支持跨域导出的图片",{delay:5e3}):common_1.PdCommonUtils.error(p.message),console.error(p)}}})}if(e.toolbar.back!==!1){e.toolbar.back=!1;var o=e.localization.toolbar.backButton;e.toolbar.extraItems.push({label:o,cssClass:zcnetchart_1.ZNCPrefix+"bar-disabled pdvis-chart-his disabled "+this.buildToolbarCss("back"),onClick:function(){t.back()}})}if(e.toolbar.fullscreen!==!1){e.toolbar.fullscreen=!1;var o=e.localization.toolbar.fullscreenTitle,a=zcnetchart_1.ZNCPrefix+"bar-btn-fullscreen "+zcnetchart_1.ZNCPrefix+"bar-btn-fullscreen-active";e.toolbar.extraItems.push({label:o,cssClass:this.buildToolbarCss("fullscreen"),onClick:function(e){var i=$(e.target).closest("."+zcnetchart_1.ZNCPrefix+"bar-btn");i.toggleClass(a),t.$el.toggleClass("fullscreen");var o=t.settings.main.callback;o&&o.onFullscreen&&o.onFullscreen(t.$el.hasClass("fullscreen"))}})}e.toolbar.extraItems.length>i.expand.length&&e.toolbar.extraItems.push({label:"展开工具栏",cssClass:zcnetchart_1.ZNCPrefix+"bar-btn-control active",onClick:function(t){var e=$(t.target).closest(".pdvis-float-toolbar");e.toggleClass("active");var i=e.find("."+zcnetchart_1.ZNCPrefix+"bar-btn-control,."+zcnetchart_1.ZNCPrefix+"bar-btn-control-active");i.toggleClass(zcnetchart_1.ZNCPrefix+"bar-btn-control "+zcnetchart_1.ZNCPrefix+"bar-btn-control-active"),i.hasClass(zcnetchart_1.ZNCPrefix+"bar-btn-control-active")?i.attr({title:"收起工具栏"}):i.attr({title:"展开工具栏"})}}),e.toolbar.zoomControl!==!1&&e.toolbar.extraItems.push("zoomControl"),i.size&&(e.toolbar.cssClass="pdvis-toolbar-"+i.size+" "+e.toolbar.cssClass),e.toolbar.items=[]}},e.prototype.splitText=function(t){for(var e=t.length,i=1;i<t.length-1;i++){var o=t.charAt(i),a=t.charAt(i+1);(validators_1.PdValidatorUtils.isChinese(o)&&validators_1.PdValidatorUtils.isEnglish(a)||validators_1.PdValidatorUtils.isEnglish(o)&&validators_1.PdValidatorUtils.isChinese(a))&&(t=t.substring(0,i+1)+" "+t.substring(i+1),i++)}if(t.indexOf(" ")<0&&e>5)if(e>9){var n=Math.floor(t.length/3),s=e-n;t=t.substring(0,n)+" "+t.substring(n,s)+" "+t.substring(s)}else e>5&&(t=t.substring(0,4)+" "+t.substring(4));return t},e.localization={closeButton:"关闭",dataRequestFailed:"请求数据失败",loadingLabel:"加载中...",menu:{collapse:"折叠",close:"关闭",dynamic:"动态",expand:"展开",fixed:"固定",focus:"焦点",hide:"隐藏",unfocus:"取消焦点"},toolbar:{backButton:"返回上一步",backTitle:"回退一步",exportButton:"导出",exportCSV:"导出为CSV文件",exportJpeg:"导出为PdVisPEG文件",exportPDF:"导出为PDF文件",exportPNG:"导出为PNG文件",exportTitle:"导出数据",exportXLS:"导出为XLS文件",fitButton:"适合按钮",fitTitle:"适合屏幕",freezeButton:"锁定按钮",freezeTitle:"全部锁定",fullscreenButton:"全屏",fullscreenTitle:"切换全屏模式",rearrangeButton:"重新排列",rearrangeTitle:"重新排列元素",unfreezeTitle:"解锁全部",zoomoutButton:"缩放按钮",zoomoutTitle:"缩放"}},e.defaultSettings={main:{autoRelayout:!1}},e}(netchart_1.PdVisNetChart);exports.PdVisZcNetChart=PdVisZcNetChart;