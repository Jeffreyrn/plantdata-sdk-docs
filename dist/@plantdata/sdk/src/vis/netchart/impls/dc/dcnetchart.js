"use strict";var __extends=this&&this.__extends||function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};return function(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),d3=require("d3"),common_1=require("../../../../common/common"),netchart_1=require("../../netchart"),PdVisDcNetChart=function(t){function e(e){var n=t.call(this,e)||this;return n.lastClickT=null,n.links=[],n.zoomTransition=d3.transition().duration(750).ease(d3.easeLinear),n}return __extends(e,t),e.getCoC=function(t,n,i){var r=t.x,a=t.y,o=n.x,s=n.y;if(a===s){var l=e.getPosCenter(r,o),c=s-Math.sqrt(i*i-(o-l)*(o-l)),d=s+Math.sqrt(i*i-(o-l)*(o-l));return[{x:l,y:c},{x:l,y:d}]}var h=(r*r-o*o+(a*a-s*s))/(2*(a-s)),u=1+(r-o)/(a-s)*((r-o)/(a-s)),f=-(2*r-2*(a-h)*((r-o)/(a-s))),p=r*r+(a-h)*(a-h)-i*i,l=(-f+Math.sqrt(f*f-4*u*p))/(2*u),m=(-f-Math.sqrt(f*f-4*u*p))/(2*u),c=h-(r-o)/(a-s)*l,d=h-(r-o)/(a-s)*m;return[{x:l,y:c},{x:m,y:d}]},e.getIoC=function(t,e,n,i){var r=t.x,a=t.y,o=e.x,s=e.y,l=(i*i-n*n+(r*r-o*o)+(a*a-s*s))/(2*(a-s)),c=1+(r-o)/(a-s)*((r-o)/(a-s)),d=-(2*r-2*(a-l)*((r-o)/(a-s))),h=r*r+(a-l)*(a-l)-n*n,u=(-d+Math.sqrt(d*d-4*c*h))/(2*c),f=(-d-Math.sqrt(d*d-4*c*h))/(2*c),p=l-(r-o)/(a-s)*u,m=l-(r-o)/(a-s)*f;return[{x:u,y:p},{x:f,y:m}]},e.getIoCaL=function(t,e,n,i,r){var a,o,s=t.x,l=t.y,c=e.x,d=e.y;if(l===d)a=0,o=l+r;else{a=(d-l)/(c-s);var h=d-a*c;o=h+r/Math.cos(Math.atan(a))}var u=1+a*a,f=-(2*s-2*(o-l)*a),p=s*s+(o-l)*(o-l)-n*n,m=-(2*c-2*(o-d)*a),g=c*c+(o-d)*(o-d)-i*i,v=(-f+Math.sqrt(f*f-4*u*p))/(2*u);(s<c?v<s||v>c:v<c||v>s)&&(v=(-f-Math.sqrt(f*f-4*u*p))/(2*u));var k=a*v+o,y=(-m+Math.sqrt(m*m-4*u*g))/(2*u);(s<c?y<s||y>c:y<c||y>s)&&(y=(-m-Math.sqrt(m*m-4*u*g))/(2*u));var S=a*y+o;return[{x:v,y:k},{x:y,y:S}]},e.getPosCenter=function(t,e){var n=0;return n=t>=0&&e>=0?Math.abs(e-t)/2+Math.min(e,t):t<0&&e<0?-Math.abs(e-t)/2+Math.max(e,t):(e+t)/2},e.setLinkNumber=function(t,e){if(0!==t.length){for(var n=[],i=[],r=0;r<t.length;r++){var a=t[r];a.source<a.target?n.push(a):i.push(a)}var o=0;if(o=e?t.length:t.length%2===0?t.length/2:(t.length+1)/2,n.length===i.length){for(var s=1,r=0;r<n.length;r++)n[r].linknum=s++;s=1;for(var r=0;r<i.length;r++)i[r].linknum=s++}else{var l=void 0,c=void 0;n.length>i.length?(l=n,c=i):(l=i,c=n);for(var s=o,r=0;r<c.length;r++)c[r].linknum=s--;var d=s;s=1;for(var h=0;s<=o;)l[h++].linknum=s++;s=0-d;for(var r=h;r<l.length;r++)l[r].linknum=s++}}},e.updateLinks=function(t){return lodash_1.flatMap(t,function(t){return t.source=t.from,t.target=t.to,t})},e.updateNodes=function(t){return t},e.prototype.resetLayout=function(){this.$chartSvg.attr("transform","")},e.prototype.resize=function(){var t=this.chart.nodes(),e=t[0],n=lodash_1.minBy(t,function(t){return t.x}),i=lodash_1.maxBy(t,function(t){return t.x}),r=lodash_1.minBy(t,function(t){return t.y}),a=lodash_1.maxBy(t,function(t){return t.y}),o=this.canvasSize[0]/(i.x-n.x),s=this.canvasSize[1]/(a.y-r.y),l=lodash_1.min([o,s])/1.2;this.transform=d3.zoomTransform(e),this.transform=this.transform.scale(l),this.transform=this.transform.translate(this.canvasSize[0]/2/l-e.x,this.canvasSize[1]/2/l-e.y),this.zoom.transform(this.nodeSelection.transition(this.zoomTransition),this.transform)},e.prototype.scrollIntoView=function(t){if(t&&t.id){var e=this.chart.nodes(),n=this.findNode(t.id,e),i=3;this.transform=d3.zoomTransform(t),this.transform=this.transform.scale(i),this.transform=this.transform.translate(this.canvasSize[0]/2/i-n.x,this.canvasSize[1]/2/i-n.y),this.zoom.transform(this.nodeSelection.transition(this.zoomTransition),this.transform)}},e.prototype.updateData=function(){var t=this,n=this.getData();n.links=this.groupLink();var i=e.updateNodes(n.nodes),r=e.updateLinks(n.links);this.createNodes(i),this.createLinks(r),this.chart.nodes(i);var a=this.chart.force("link");a.links(r),this.chart.alphaTarget(.1).restart(),setTimeout(function(){t.chart.alphaTarget(0)},300);var o=this.settings.main.events;o.nodeRightClick&&(document.oncontextmenu=function(){return"node"===t.rightClickType?(t.rightClickType=null,!1):void(t.rightClickType=null)},this.$chartSvg.selectAll(".pdvis-node").on("contextmenu",function(e,n,i){t.rightClickType="node",o.nodeRightClick(e,i[n])})),this.links=r,this.$chartSvg.selectAll(".pdvis-node").on("dblclick",function(e,n,i){o.nodeDblClick?o.nodeDblClick(e,i[n]):(t.nodeDblClick(e),d3.event.stopPropagation()),t.lastClickT&&clearTimeout(t.lastClickT)}),o.nodeClick&&this.$chartSvg.selectAll(".pdvis-node").on("click",function(e,n,i){t.lastClickT&&clearTimeout(t.lastClickT),t.lastClickT=setTimeout(function(){o.nodeClick(e,i[n])},300)}),this.$chartSvg.selectAll(".pdvis-link").on("mouseover",function(e){var n=netchart_1.PdVisNetChart.linkContentsFunction(e);t.$linkInfoContainer.html(n),t.$linkInfoContainer.css({left:d3.event.offsetX,top:d3.event.offsetY})}),this.$mainContainer.on("click",function(){t.$linkInfoContainer.empty()}).on("mousemove",function(e){var n=t.$linkInfoContainer.position(),i=5;(Math.abs(e.offsetX-n.left)>i||Math.abs(e.offsetY-n.top)>i)&&t.$linkInfoContainer.empty()}),this.dispatch("dataupdate",this.eventData)},e.prototype.updateStyle=function(){this.updateNodeStyle(),this.updateLinkStyle(),this.dispatch("styleupdate",this.eventData)},e.prototype.centerPosition=function(){this.chart.force("center",d3.forceCenter(this.canvasSize[0]/2,this.canvasSize[1]/2))},e.prototype.createLinks=function(t){this.linkSelection=this.linkSelection.data(t,function(t){return t.id}),this.linkSelection.exit().remove(),this.linkSelection=this.linkSelection.enter().append("path").attr("class","pdvis-link").attr("id",function(t){return"pdvis-link-"+t.id}).merge(this.linkSelection),this.createMarker(),this.createLinksLabel(t)},e.prototype.createLinksLabel=function(t){this.linkLabelSelection=this.linkLabelSelection.data(t,function(t){return t.id}),this.linkLabelSelection.exit().remove(),this.linkLabelSelection=this.linkLabelSelection.enter().append("text").attr("class","pdvis-link-label").attr("font-size","10").attr("dy","-2").attr("text-anchor","middle").attr("fill",function(){return"#888"}).text(function(t){return t.attName}).merge(this.linkLabelSelection)},e.prototype.createMarker=function(){var t=this,e=lodash_1.concat([{color:netchart_1.PdVisNetChart.emphasisColor},{color:netchart_1.PdVisNetChart.reduceColor},{color:netchart_1.PdVisNetChart.linkColor}],this.linkLegends),n=lodash_1.concat(lodash_1.flatMap(lodash_1.cloneDeep(e),function(t){return t.distance="",t}),lodash_1.flatMap(lodash_1.cloneDeep(e),function(t){return t.distance="-"+netchart_1.PdVisNetChart.normalRadius,t}),lodash_1.flatMap(lodash_1.cloneDeep(e),function(t){return t.distance="-"+netchart_1.PdVisNetChart.emphasisRadius,t})),i=lodash_1.cloneDeep(this.markerSelection.data()),r=lodash_1.filter(n,function(e){return!lodash_1.find(i,function(n){return t.markerId+"-"+e.color+e.distance==t.markerId+"-"+n.color+n.distance})}),a=lodash_1.concat(i,r);this.markerSelection=this.markerSelection.data(a),this.markerSelection.exit().remove(),this.markerSelection=this.markerSelection.enter().append("marker").attr("id",function(e){return t.markerId+"-"+e.color+e.distance}).attr("class","pdvis-graph-marker").attr("viewBox","0 0 10 8").attr("refX",function(t){return t.distance?parseInt(t.distance.substring(1),10)+10:5}).attr("refY",4).attr("markerWidth",10).attr("markerHeight",8).attr("markerUnits","userSpaceOnUse").attr("orient","auto").append("path").attr("d","M0,0L10,4L0,8L4,4Z").merge(this.markerSelection)},e.prototype.createNodes=function(t){var e=this;this.nodeSelection=this.nodeSelection.data(t,function(t){return t.id}),this.nodeSelection.exit().remove(),this.nodeSelection=this.nodeSelection.enter().append("circle").attr("class","pdvis-node").attr("id",function(t){return"pdvis-node-"+t.id}).call(d3.drag().on("start",function(t){e.dragStarted(t)}).on("drag",function(t){e.dragged(t)}).on("end",function(t){e.dragEnded(t)})).merge(this.nodeSelection),this.createNodesLabel(t),this.createNodesImage(t)},e.prototype.createNodesImage=function(t){var e=this.settings.main.nodeSettings,n=lodash_1.filter(t,function(t){return t.img&&0!==t.img.indexOf("http")&&e&&e.imgBuilder&&(t.img=e.imgBuilder(t.img)),t.img});this.nodeImageSelection=this.nodeImageSelection.data(n,function(t){return t.id}),this.nodeImageSelection.exit().remove();var i=this.nodeImageSelection.enter().append("pattern").attr("class","pdvis-node-image").attr("patternContentUnits","objectBoundingBox").attr("width","100%").attr("height","100%").attr("id",function(t){return"pdvis-node-image-"+t.id});this.nodeImageSelection=i.merge(this.nodeImageSelection),i.append("circle").attr("rx","10").attr("ry","10").attr("r","10").attr("fill","white"),i.append("image").attr("width","1").attr("height","1").attr("xlink:href",function(t){return t.img})},e.prototype.createNodesLabel=function(t){var e=this;this.nodeLabelSelection=this.nodeLabelSelection.data(t,function(t){return t.id}),this.nodeLabelSelection.exit().remove(),this.nodeLabelSelection=this.nodeLabelSelection.enter().append("text").attr("class","pdvis-node-label").attr("dy",function(t){return(t._radius||e.settings.main.radius.normal)+18}).attr("font-size","12").attr("text-anchor","middle").attr("fill",function(){return"#333"}).text(function(t){return t.name}).merge(this.nodeLabelSelection)},e.prototype.dragEnded=function(t){d3.event.active||this.chart.alphaTarget(0),t.fx=null,t.fy=null},e.prototype.dragged=function(t){t.fx=d3.event.x,t.fy=d3.event.y},e.prototype.dragStarted=function(t){d3.event.active||this.chart.alphaTarget(.3).restart(),t.fx=t.x,t.fy=t.y},e.prototype.getArcRadius=function(t){var e=t.source,n=t.target,i=this.settings.main.linkSettings.curve||2.5,r=1,a=n.x-e.x,o=n.y-e.y;return Math.sqrt(a*a+o*o)*(Math.abs(t.linknum)+r)/(i*r)},e.prototype.getGap=function(t){var e=t.source,n=t.target,i=this.nodeRadiusFunction(e)-2,r=this.nodeRadiusFunction(n)-2,a=2*Math.min(i,r),o=Math.min(a/(t.size-1),14),s=t.linknum>0?t.linknum-1:t.linknum+1;return s*o+(t.size%2===0?(t.linknum>0?o:-o)/2:0)},e.prototype.groupLink=function(){for(var t=this.getData().links,n={},i={},r=0;r<t.length;r++){var a=t[r].from<t[r].to?t[r].from+":"+t[r].to:t[r].to+":"+t[r].from;i.hasOwnProperty(a)||(i[a]=0),i[a]+=1,n.hasOwnProperty(a)||(n[a]=[]),n[a].push(t[r])}for(var r=0;r<t.length;r++){var a=t[r].from<t[r].to?t[r].from+":"+t[r].to:t[r].to+":"+t[r].from;t[r].size=i[a];var o=n[a],s=a.split(":"),l=!1;s[0]===s[1]&&(l=!0),e.setLinkNumber(o,l)}return t},e.prototype.handlerLegendUpdate=function(){if(this.chart){var t=this.getData();this.chart.nodes().length!==t.nodes.length||this.links.length!==t.links.length?this.updateChart():this.links.length!==t.links.length?this.updateLinkStyle():this.updateNodeStyle()}},e.prototype.initChart=function(){var t=this,e=$('<svg width="100%" height="100%" class="pdvis-svg-canvas"></svg>');this.$mainContainer.append(e),this.$linkInfoContainer=$('<div class="pdvis-link-info-container"></div>'),this.$mainContainer.append(this.$linkInfoContainer);var n=d3.select("svg.pdvis-svg-canvas");this.canvasSize=[parseInt(n.style("width"),10),parseInt(n.style("height"),10)],n.selectAll(".pdvis-graph-svg").remove();var i=n.append("g").classed("pdvis-graph-svg",!0);i.append("rect").attr("width","100%").attr("height","100%").style("fill","transparent"),this.$chartSvg=i.append("g"),this.zoom=d3.zoom().on("zoom",function(){var e=d3.event.transform;if(d3.event.sourceEvent&&t.transform){e=e.scale(t.transform.k);var n=t.transform.x/t.transform.k,i=t.transform.y/t.transform.k;e=e.translate(n,i)}t.nowTransform=e,t.$chartSvg.attr("transform",e)}),i.call(this.zoom);var r=this.settings.main.radius,a=2*(r.emphasis||r.normal*r.emphasisRatio),o=d3.forceLink().id(function(t){return t.id}).distance(4*a),s=d3.forceManyBody();this.chart=d3.forceSimulation().force("link",o).force("collide",d3.forceCollide(a)).force("charge",s).force("center",d3.forceCenter(this.canvasSize[0]/2,this.canvasSize[1]/2)).on("tick",function(){t.updatePosition()}),this.markerId=common_1.PdCommonUtils.createId("marker");var l=this.$chartSvg.append("defs");this.markerSelection=l.selectAll("marker"),this.nodeImageSelection=l.selectAll("image"),this.linkSelection=this.$chartSvg.append("g").attr("class","pdvis-links").selectAll(".pdvis-link"),this.nodeSelection=this.$chartSvg.append("g").attr("class","pdvis-nodes").selectAll(".pdvis-node"),this.nodeLabelSelection=this.$chartSvg.append("g").attr("class","pdvis-node-labels").selectAll(".pdvis-node-label"),this.linkLabelSelection=this.$chartSvg.append("g").attr("class","pdvis-link-labels").selectAll(".pdvis-link-label"),this.on("fullscreen",function(){t.canvasSize=[parseInt(n.style("width"),10),parseInt(n.style("height"),10)],t.resize()})},e.prototype.initSettings=function(n){return $.extend(!0,{},t.prototype.initSettings.call(this,e.defaultSettings),n)},e.prototype.nodeRadiusFunction=function(e){return e._radius=t.prototype.nodeRadiusFunction.call(this,e),e._radius},e.prototype.setLinkMarker=function(){var t=this;if(this.linkSelection){var e=this.settings.main.linkSettings.isLine;this.linkSelection.attr("marker-mid",function(n){if(!e&&(n.size%2===0||n.size%2===1&&1!==n.linknum)){var i=t.linkColorFunction(n);return"url(#"+t.markerId+"-"+i+")"}return""}).attr("marker-end",function(n){if(e||1===n.size||n.size%2===1&&1===n.linknum){var i=n.target;n.target instanceof Object||(i=t.findNode(n.target));var r=t.linkColorFunction(n);if(e)return"url(#"+t.markerId+"-"+r+")";var a=t.nodeRadiusFunction(i);return"url(#"+t.markerId+"-"+r+"-"+a+")"}return""})}},e.prototype.updateLinkLabelPos=function(){var t=this;if(this.linkLabelSelection){var n=this.settings.main.linkSettings.isLine;this.linkLabelSelection.attr("x",function(t){var n=t.source,i=t.target;return e.getPosCenter(n.x,i.x)}).attr("y",function(t){var n=t.source,i=t.target;return e.getPosCenter(n.y,i.y)}).attr("dy",function(i){var r=-2;if(i.size>1&&(i.size%2===0||i.size%2===1&&1!==i.linknum)){if(n)return t.getGap(i)+r;var a=i.source,o=i.target,s=t.getArcRadius(i),l=e.getPosCenter(a.x,o.x),c=e.getPosCenter(a.y,o.y),d=Math.sqrt((l-a.x)*(l-a.x)+(c-a.y)*(c-a.y)),h=s-Math.sqrt(s*s-d*d),u=i.linknum<0?-1:1;return u*h+r}return r}).attr("transform",function(t){var n=t.source,i=t.target,r=e.getPosCenter(n.x,i.x),a=e.getPosCenter(n.y,i.y),o=0;return i.x!==n.x&&(o=180*Math.atan((i.y-n.y)/(i.x-n.x))/Math.PI),"rotate("+o+", "+r+" "+a+")"})}},e.prototype.updateLinkPos=function(){var t=this;if(this.linkSelection){var n=this.settings.main.linkSettings.isLine;this.linkSelection.attr("d",function(i){var r=i.source,a=i.target;if(a===r){var o=30/i.linknum;return"M"+r.x+","+r.y+"A"+o+","+o+" 0 1,1 "+a.x+","+(a.y+1)}if(n){var s=t.nodeRadiusFunction(r),l=t.nodeRadiusFunction(a)+5,c=0;i.size%2!==0&&1===i.linknum||(c=t.getGap(i));var d=e.getIoCaL(r,a,s,l,c);return"M"+d[0].x+","+d[0].y+" L"+d[1].x+" "+d[1].y}if(i.size%2!==0&&1===i.linknum)return"M"+r.x+" "+r.y+" L"+a.x+" "+a.y;var o=t.getArcRadius(i),h=r.x,u=r.y,f=a.x,p=a.y,m=r.id>a.id?1:0;return i.linknum<0&&(m=0===m?1:0),"M"+h+","+u+"A"+o+","+o+" 0 0,"+m+" "+f+","+p})}},e.prototype.updateLinkStyle=function(){var t=this;this.updateMarkerStyle(),this.linkSelection&&this.linkSelection.attr("stroke-width",function(e){return t.linkRadiusFunction(e)}).attr("stroke",function(e){return"reduce"===t.linkStatus(e)?"rgba(0, 0, 0, .1)":t.linkColorFunction(e)}),this.setLinkMarker()},e.prototype.updateMarkerStyle=function(){this.markerSelection&&this.markerSelection.attr("fill",function(t){return t.color})},e.prototype.updateNodeLabelPos=function(){this.nodeLabelSelection&&this.nodeLabelSelection.attr("x",function(t){return t.x}).attr("y",function(t){return t.y})},e.prototype.updateNodeLabelStyle=function(){var t=this;this.nodeLabelSelection&&this.nodeLabelSelection.attr("fill",function(e){return"reduce"===t.nodeStatus(e)?"rgba(0, 0, 0, .1)":"#000"})},e.prototype.updateNodePos=function(){this.nodeSelection&&this.nodeSelection.attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y})},e.prototype.updateNodeStyle=function(){var t=this;this.updateNodeLabelStyle(),this.nodeSelection&&this.nodeSelection.attr("r",function(e){return t.nodeRadiusFunction(e)}).attr("fill",function(e){return e.img?"url(#pdvis-node-image-"+e.id+")":"reduce"===t.nodeStatus(e)?"rgba(0, 0, 0, .1)":t.nodeColorFunction(e)}).attr("stroke",function(e){return"reduce"===t.nodeStatus(e)?"rgba(0, 0, 0, .1)":t.nodeColorFunction(e)}).attr("stroke-width",function(){return 2})},e.prototype.updatePosition=function(){this.updateLinkPos(),this.updateLinkLabelPos(),this.updateNodePos(),this.updateNodeLabelPos()},e.defaultSettings={main:{settings:{},linkSettings:{isLine:!0},events:{}}},e}(netchart_1.PdVisNetChart);exports.PdVisDcNetChart=PdVisDcNetChart;