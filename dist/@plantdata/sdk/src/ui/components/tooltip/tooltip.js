"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),prefix_1=require("../prefix"),common_1=require("../../../common/common"),elecreator_1=require("../../../core/elecreator"),spin_1=require("../spin/spin"),PdUITooltip=function(){function t(){}return t.getTargetByItem=function(e){return $("#"+e.attr(t.attrId))},t.init=function(){t.bindEvent()},t.updateTooltip=function(e){var r=t.getTargetByItem(e),o=t.getTooltipContent(e);r.find(t.clsInner).html(o)},t.bindEvent=function(){$(window).on("resize",function(){$(t.cls).remove()});var e,r="."+t.clsTriggerName+",["+t.attrName+'="hover"],['+t.attrName+'=""]',o="["+t.attrName+'="click"]';$("body").on("mouseenter",r,function(e){var r=$(e.currentTarget),o=parseInt(r.attr(t.attrShowDelay)||"500",10);setTimeout(function(){var e=r.data("in");e&&t.showTooltip(r)},o),r.data("in",!0)}).on("click",o,function(e){var r=$(e.currentTarget);t.showTooltip(r)}).on("click",function(e){$(e.target).closest(t.cls).length||$(t.cls+":visible").each(function(e,r){var o=$(r).attr("id");t.hideTooltip($("["+t.attrId+'="'+o+'"]'))})}).on("mouseleave",r,function(r){var o=$(r.currentTarget);o.data("in",!1);var a=parseInt(o.attr(t.attrHideDelay)||"100",10);if(a>=0){var n=null;n=setTimeout(function(){t.hideTooltip(o)},a);var i,l=t.getTargetByItem(o);l.one("mouseenter",function(){clearTimeout(n)}).one("mouseleave",function(r){r.target===r.currentTarget?t.hideTooltip(o):i||(i=setInterval(function(){$(e.target).closest(t.cls).length||(t.hideTooltip(o),clearInterval(i))},80))})}}).on("mousemove",function(t){e=t})},t.calcPosition=function(e){var r=e.offset(),o="",a=t.getTargetByItem(e),n=parseInt(e.attr(t.attrGutter)||"0",10),i=0,l=0,c=e.outerHeight(),s=a.find(t.clsInner).outerHeight(),d=e.outerWidth(),m=a.find(t.clsInner).outerWidth(),f=t.getTargetContainer(e),u=$(f).outerHeight(),p=$(f).outerWidth();o=r.top>s?"top":u-c-r.top>s?"bottom":r.left>m?"left":p-d-r.left>m?"right":u-c-s>=p-d-m?r.top>=u-c-r.top?"top":"bottom":r.left>=p-d-r.left?"left":"right";var g=8+n;switch(0===o.indexOf("bottom")||0===o.indexOf("top")?s+=g:m+=g,o){case"top":case"bottom":i=r.left+d/2-m/2,i<0&&(o+="Left");break;case"left":case"right":l=r.top+c/2-s/2,l<0&&(o+="Top")}return o},t.createTooltip=function(e){var r,o=elecreator_1.PdEleCreator.createEle("div",{cls:t.clsArrowName}),a=elecreator_1.PdEleCreator.createEle("div",{cls:t.clsInnerName}),n=elecreator_1.PdEleCreator.createEle("div",{cls:t.clsContentName,html:o+a}),i={atts:(r={},r[t.attrPosition]=e.position,r.id=e.id,r),cls:t.clsName+" "+e.cls,html:n},l=$(elecreator_1.PdEleCreator.createEle("div",i));return l.find(t.clsInner).append(e.content),l},t.getTargetContainer=function(e){var r=e.attr(t.attrContainer)||"body",o=e.attr(t.attrContainerFun);return o&&(r=common_1.PdCommonUtils.eval("("+o+")")(e)),r},t.getTooltipContent=function(e){var r=e.attr("title");r&&(e.attr(t.attrTitle,r),e.removeAttr("title"));var o=e.attr(t.attrContentSelector)?$(e.attr(t.attrContentSelector)):"";return e.attr(t.attrTitle)||o},t.hideTooltip=function(e){var r=t.getTargetByItem(e);r.removeClass(t.clsShowName);var o=e.attr("onVisibleChange");o&&common_1.PdCommonUtils.eval("("+o+")")(!1,e)},t.loadAsyncData=function(e){var r=e.attr(t.attrContentAsync);if(r){var o=t.getTargetByItem(e),a=e.attr(t.attrContentCache)||"true";if("true"!==a||!o.data("data")){var n=spin_1.PdUISpin.create({cls:t.clsLoadingName,size:"xs"})+" 数据加载中 ...";o.find(t.clsInner).html(n);var i=function(r){o.data("data",r),o.find(t.clsInner).html(r),t.updatePosition(e)};common_1.PdCommonUtils.eval("("+r+")")(e,i)}}},t.matchPosition=function(e,r){var o=e.offset(),a=t.getTargetByItem(e),n=e.outerHeight(),i=a.find(t.clsInner).outerHeight(),l=e.outerWidth(),c=a.find(t.clsInner).outerWidth(),s=t.getTargetContainer(e),d=$(s).outerHeight(),m=$(s).outerWidth();return 0===r.indexOf("top")?o.top>i:0===r.indexOf("bottom")?d-n-o.top>i:0===r.indexOf("left")?o.left>c:0===r.indexOf("right")&&m-l-o.left>c},t.showTooltip=function(e){$("["+t.attrId+"]["+t.attrName+"]:not(["+t.attrPersist+"])").each(function(r,o){o!==e[0]&&t.hideTooltip($(o))});var r=e.attr(t.attrId),o=t.getTargetByItem(e);r||(r=common_1.PdCommonUtils.createId("tooltip"),e.attr(t.attrId,r));var a=e.attr("title");if(a||!o.length){var n=t.getTooltipContent(e);if(o.length)t.updateTooltip(e);else{var i=e.attr(t.attrPosition),l=e.attr(t.attrClass);o=t.createTooltip({id:r,content:n,position:i||"",cls:l||""});var c=t.getTargetContainer(e);o.appendTo(c)}}t.loadAsyncData(e),t.updatePosition(e),setTimeout(function(){o.addClass(t.clsShowName);var r=e.attr("onVisibleChange");r&&common_1.PdCommonUtils.eval("("+r+")")(!0,e)},180)},t.updatePosition=function(e){var r=e.offset(),o=e.attr(t.attrPosition),a=parseInt(e.attr(t.attrGutter)||"0",10),n=e.attr(t.attrAdjust)||"true",i=t.getTargetByItem(e),l=0,c=0,s=e.outerHeight(),d=i.find(t.clsInner).outerHeight(),m=e.outerWidth(),f=i.find(t.clsInner).outerWidth(),u=8+a;o||(o=t.calcPosition(e),n="false"),"true"!==n||t.matchPosition(e,o)||(o=t.calcPosition(e)),i.attr(t.attrPosition,o),0===o.indexOf("bottom")||0===o.indexOf("top")?(d+=u,s+=a):(f+=u,m+=a),0===o.indexOf("top")?(c=r.top-d,l=r.left+m/2-f/2):0===o.indexOf("bottom")?(c=r.top+s,l=r.left+m/2-f/2):0===o.indexOf("left")?(l=r.left-f,c=r.top+s/2-d/2):0===o.indexOf("right")&&(l=r.left+m,c=r.top+s/2-d/2),o.indexOf("Left")>0?l=r.left:o.indexOf("Right")>0?l=r.left+m-f:o.indexOf("Top")>0?c=r.top:o.indexOf("Bottom")>0&&(c=r.top+s-d);var p=i.offsetParent().offset();l-=p.left,c-=p.top,i.css({left:l,top:c})},t.attrName=prefix_1["default"].attr+"tooltip",t.attrAdjust=t.attrName+"-adjust",t.attrClass=t.attrName+"-class",t.attrContainer=t.attrName+"-container",t.attrContainerFun=t.attrName+"-container-fun",t.attrContentAsync=t.attrName+"-content-async",t.attrContentCache=t.attrName+"-content-cache",t.attrContentSelector=t.attrName+"-content-selector",t.attrGutter=t.attrName+"-gutter",t.attrHideDelay=t.attrName+"-hide-delay",t.attrId=t.attrName+"-id",t.attrPersist=t.attrName+"-persist",t.attrPosition=t.attrName+"-position",t.attrShowDelay=t.attrName+"-show-delay",t.attrTitle=t.attrName+"-title",t.clsName=prefix_1["default"].cls+"tooltip",t.cls="."+t.clsName,t.clsArrowName=t.clsName+"-arrow",t.clsContentName=t.clsName+"-content",t.clsInner=t.cls+"-inner",t.clsInnerName=t.clsName+"-inner",t.clsLoadingName=t.clsName+"-loading",t.clsShowName=t.clsName+"-show",t.clsTriggerName=t.clsName+"-trigger",t}();exports.PdUITooltip=PdUITooltip,$(function(){PdUITooltip.init()});