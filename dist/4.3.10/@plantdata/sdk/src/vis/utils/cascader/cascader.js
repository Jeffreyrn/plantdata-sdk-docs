"use strict";var __extends=this&&this.__extends||function(){var e=function(t,s){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s])})(t,s)};return function(t,s){function n(){this.constructor=t}e(t,s),t.prototype=null===s?Object.create(s):(n.prototype=s.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),component_1=require("../../../core/component"),keyboard_arrow_right_1=require("../../../icon/keyboard-arrow-right"),expand_more_1=require("../../../icon/expand-more"),PdVisCascader=function(e){function t(t){return e.call(this,t)||this}return __extends(t,e),t.prototype.close=function(){this.$el.removeClass("active"),this.$menu.detach()},t.prototype.getValueObj=function(e,t){var s=this;void 0===t&&(t=this.data);var n=null,i=function(t){for(var a=0;a<t.length;a++)t[a][s.valueKey]===e?n=t[a]:t[a].children&&i(t[a].children)};return i(t),n},t.prototype.getValue=function(e){var t=this;void 0===e&&(e=this.settings.isPath);var s=this.select(".pdvis-cascader-menu-item.checked",this.$menu);if(e){var n=[];return s.each(function(e,s){n.push($(s).data("_data")[t.valueKey])}),n}return s.length?s.eq(-1).data("_data")[this.valueKey]:null},t.prototype.isOpen=function(){return this.$el.hasClass("active")},t.prototype.open=function(){var e=this.$el.offset(),t=e.left,s=e.top;s+=this.$el.height()+8,this.$el.addClass("active"),this.$menu.css({left:t,top:s}).appendTo("body")},t.prototype.setValue=function(e,t){var s=this;void 0===t&&(t=this.settings.isPath),this.select("ul.pdvis-cascader-menu",this.$menu).remove();var n=this.data,i="";if(!t&&e){var a=this.endValues;this.settings.changeOnSelect&&(a=this.values),e=lodash_1.find(a,function(t){return t[t.length-1]===e})}e&&e.length&&e.forEach(function(e,t){s.createMenuItem(n,e);var a=s.getValueObj(e,n);if(a){var r=a[s.labelKey];s.settings.showPath?i+=""+(0===t?"":" / ")+r:i=r,n=a.children}}),this.select("input").val(i)},t.prototype.bindEvent=function(){var t=this;e.prototype.bindEvent.call(this),this.maskListener=function(e){var s=$(e.target).closest(t.$menu).length,n=$(e.target).closest(t.$el).length;!t.isOpen()||s||n||t.close()},$("body").on("click",this.maskListener),this.$el.on("click",".pdvis-cascader-input-wrapper",function(e){t.isOpen()?t.close():(t.open(),t.data.length&&!t.select(".pdvis-cascader-menu",t.$menu).length&&t.createMenuItem(t.data))}),this.$menu.on("click",".pdvis-cascader-menu-item",function(e){var s=$(e.currentTarget);if(!s.hasClass("checked")&&!s.hasClass("disabled")){s.parent().nextAll().remove(),s.addClass("checked").siblings().removeClass("checked");var n=s.data("_data")[t.valueKey],i=t.getValueObj(n);if(t.settings.change&&t.settings.change(n,e),i.children&&i.children.length?t.createMenuItem(i.children):t.close(),t.settings.changeOnSelect||!i.children||!i.children.length){var a="";t.select(".pdvis-cascader-menu-item.checked",t.$menu).each(function(e,s){var n=$(s).data("_data")[t.labelKey];t.settings.showPath?a+=""+(0===e?"":" / ")+n:a=n}),t.select("input").val(a)}}}),this.select("input").on("focus",function(e){t.settings.focus&&t.settings.focus(e)}).on("blur",function(e){t.settings.blur&&t.settings.blur(e)})},t.prototype.created=function(){e.prototype.created.call(this),this.data=this.settings.data,this.valueKey=this.settings.valueKey,this.labelKey=this.settings.labelKey,this.endValues=[],this.values=[],this.updateValues()},t.prototype.createMenuItem=function(e,t){var s=this,n=keyboard_arrow_right_1["default"](18),i=$('<ul class="pdvis-cascader-menu"></ul>');e.forEach(function(e){var a=["pdvis-cascader-menu-item"];e.children&&e.children.length&&a.push("pdvis-cascader-menu-item-extensible"),t&&t===e[s.valueKey]&&a.push("checked"),e.disabled&&a.push("disabled");var r=e.children&&e.children.length?n:"",c=$('<li class="'+a.join(" ")+'">'+e[s.labelKey]+r+"</li>");c.data("_data",e),i.append(c)}),this.$menu.append(i)},t.prototype.initSettings=function(s){return $.extend(!0,{},e.prototype.initSettings.call(this,t.defaultSettings),s)},t.prototype.initTemplate=function(){var e=$(this.settings.selector);e.addClass("pdvis-cascader"),this.settings.cls&&e.addClass(this.settings.cls.join(" ")),this.settings.size&&e.addClass("pdvis-cascader-"+this.settings.size),this.$menu=$('<div class="pdvis-cascader-menus popper"><div class="pdvis-cascader-popper-arrow"></div></div>');var t=expand_more_1["default"](20);return e.append('<div class="pdvis-cascader-input-wrapper">\n                        <input type="text" readonly="readonly" autocomplete="off" placeholder="请选择" class="pdvis-cascader-input-inner">\n                        <span class="pdvis-cascader-input-suffix">\n                            '+t+"\n                        </span>\n                        </div>"),e},t.prototype.mounted=function(){e.prototype.mounted.call(this),this.bindEvent()},t.prototype.unbindEvent=function(){e.prototype.unbindEvent.call(this),this.$el.off("click"),this.$menu.off("click",".pdvis-cascader-menu-item"),this.select("input").off("focus blur"),$("body").off("click",this.maskListener)},t.prototype.updateValues=function(e,t){void 0===e&&(e=this.data),void 0===t&&(t=[]);for(var s=0,n=e;s<n.length;s++){var i=n[s],a=lodash_1.cloneDeep(t);a.push(i[this.valueKey]),this.values.push(a),i.children&&i.children.length?this.updateValues(i.children,a):this.endValues.push(a)}},t.defaultSettings={isPath:!1,valueKey:"value",labelKey:"label",changeOnSelect:!0},t}(component_1.PdComponent);exports.PdVisCascader=PdVisCascader;