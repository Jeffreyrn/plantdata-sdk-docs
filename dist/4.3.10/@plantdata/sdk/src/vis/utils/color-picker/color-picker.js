"use strict";var __extends=this&&this.__extends||function(){var e=function(o,t){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,o){e.__proto__=o}||function(e,o){for(var t in o)o.hasOwnProperty(t)&&(e[t]=o[t])})(o,t)};return function(o,t){function r(){this.constructor=o}e(o,t),o.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),component_1=require("../../../core/component"),common_1=require("../../../common/common"),color_1=require("../../../common/color"),PdVisColorPicker=function(e){function o(o){return e.call(this,o)||this}return __extends(o,e),o.colorToHSB=function(e){if("string"==typeof e)if(0===e.toLocaleLowerCase().indexOf("rgb")){var o=e.split("(")[1].split(")")[0].split(",");e=color_1.PdColorUtils.rgbToHsb({r:parseInt(o[0].trim(),10),g:parseInt(o[1].trim(),10),b:parseInt(o[2].trim(),10),a:void 0!==o[3]?parseFloat(o[3]):1})}else if(0===e.toLocaleLowerCase().indexOf("hsb")){var o=e.split("(")[1].split(")")[0].split(",");e=color_1.PdColorUtils.fixHSB({h:parseInt(o[0].trim(),10),s:parseInt(o[1].trim(),10),b:parseInt(o[2].trim(),10),a:void 0!==o[3]?parseFloat(o[3]):1})}else if(0===e.toLocaleLowerCase().indexOf("hsl")){var o=e.split("(")[1].split(")")[0].split(",");e=color_1.PdColorUtils.fixHSL({h:parseInt(o[0].trim(),10),s:parseInt(o[1].trim(),10),l:parseInt(o[2].trim(),10),a:void 0!==o[3]?parseFloat(o[3]):1})}else e=color_1.PdColorUtils.hexToHsb(e);else void 0!==e.r&&void 0!==e.g&&void 0!==e.b?e=color_1.PdColorUtils.rgbToHsb(e):void 0!==e.h&&void 0!==e.s&&void 0!==e.b?e=color_1.PdColorUtils.fixHSB(e):void 0!==e.h&&void 0!==e.s&&void 0!==e.l&&(e=color_1.PdColorUtils.rgbToHsb(color_1.PdColorUtils.hslToRgb(e)));return e},o.createGradient=function(e){var o="linear - gradient(top, "+e+")",t="";return t+="background:-webkit-"+o,t+=";background:-o-"+o,t+=";background:-ms-"+o,t+=";background:-moz-"+o,t+=";background:linear-gradient(to bottom, "+e+");"},o.roundAlpha=function(e){return e=Math.min(1,Math.max(0,void 0===e?1:e)),e=Math.floor(100*e)/100},o.prototype.destroy=function(){this.unbindEvent(),this.removeDOM()},o.prototype.setColor=function(e,t){if(void 0===t&&(t=!0),void 0!==e&&(e=o.colorToHSB(e),this.color=this.origColor=e,this.updateColor(e,t),this.settings.onChange)){var r=color_1.PdColorUtils.hsbRound(e),i=color_1.PdColorUtils.hsbToHex(e),s=color_1.PdColorUtils.hsbToRgb(e);this.settings.onChange(r,i,s,this,!1)}},o.prototype.bindEvent=function(){var t=this;e.prototype.bindEvent.call(this),this.select("div.pd-colorpicker-submit").on("click",function(){var e=t.color;if(t.origColor=e,t.setCurrentColor(e),t.settings.onSubmit){var o=color_1.PdColorUtils.hsbRound(e),r=color_1.PdColorUtils.hsbToHex(e),i=color_1.PdColorUtils.hsbToRgb(e);t.settings.onSubmit(o,r,i,t)}}),this.destroyEvent=function(){t.destroy()},$(document).on("mousedown",this.destroyEvent),this.$el.on("mousedown",function(e){e.stopPropagation()}),this.$fields.on("input change",function(e){t.change(e.currentTarget)}).on("blur",function(){t.$fields.parent().removeClass("pd-colorpicker-focus")}).on("focus",function(e){t.$fields.parent().removeClass("pd-colorpicker-focus"),$(e.currentTarget).parent().addClass("pd-colorpicker-focus")}),this.upIncrementEvent=function(e){var o=e.data;return t.change(o.input.get(0)),o.el.removeClass("pd-colorpicker-slider").find("input").focus(),$(document).off("mouseup",t.upIncrementEvent),$(document).off("mousemove",t.moveIncrementEvent),!1},this.moveIncrementEvent=function(e){var r=e.data,i=e.pageY-r.y,s=Math.floor(r.val-i);1===r.max&&(s=o.roundAlpha(r.val-i/100));var l=Math.max(0,Math.min(r.max,s));return r.input.val(l),r.preview&&t.change(r.input.get(0)),!1},this.select("div.pd-colorpicker-field-arrs").on("mousedown",function(e){e.preventDefault?e.preventDefault():e.returnValue=!1;var o=$(e.currentTarget).parent(),r=o.attr("class"),i=o.find("input").trigger("focus"),s={el:o.addClass("pd-colorpicker-slider"),max:r.indexOf("_alpha")>0?1:r.indexOf("_hsb_h")>0?360:r.indexOf("_hsb")>0?100:255,y:e.pageY,input:i,val:r.indexOf("_alpha")>0?parseFloat(i.val()):parseInt(i.val(),10),preview:t.settings.livePreview};$(document).on("mouseup",s,t.upIncrementEvent),$(document).on("mousemove",s,t.moveIncrementEvent)}),this.select("div.pd-colorpicker-current-color").on("click",function(){t.restoreOriginal()}),this.upSelectorEvent=function(){return t.fillRGBFields(t.color),t.fillHexFields(t.color),$(document).off("mouseup touchend",t.upSelectorEvent),$(document).off("mousemove touchmove",t.moveSelectorEvent),!1},this.moveSelectorEvent=function(e){var o,r,i=e.data;if("touchmove"===e.type){var s=e.originalEvent.changedTouches;o=s[0].pageX,r=s[0].pageY}else o=e.pageX,r=e.pageY;var l=t.height,n=Math.floor(100*(l-Math.max(0,Math.min(l,r-i.pos.top)))/l),a=Math.floor(100*Math.max(0,Math.min(l,o-i.pos.left))/l),c=t.$fields.eq(6).val(n).end().eq(5).val(a).get(0);return t.change(c),!1},this.$selector.on("mousedown touchstart",function(e){e.preventDefault?e.preventDefault():e.returnValue=!1;var o={cal:$(e.currentTarget).parent(),pos:$(e.currentTarget).offset(),preview:t.settings.livePreview};$(document).on("mouseup touchend",o,t.upSelectorEvent),$(document).on("mousemove touchmove",o,t.moveSelectorEvent);var r,i;if("touchstart"===e.type){var s=e.originalEvent.changedTouches;r=s[0].pageX,i=s[0].pageY}else r=e.pageX,i=e.pageY;var l=t.height,n=Math.floor(100*(l-(i-o.pos.top))/l),a=Math.floor(100*(r-o.pos.left)/l),c=t.$fields.eq(6).val(n).end().eq(5).val(a).get(0);return t.change(c),!1}),this.upHueEvent=function(){return t.fillRGBFields(t.color),t.fillHexFields(t.color),$(document).off("mouseup touchend",t.upHueEvent),$(document).off("mousemove touchmove",t.moveHueEvent),!1},this.moveHueEvent=function(e){var o=e.data,r=e.originalEvent.changedTouches,i="touchmove"===e.type?r[0].pageY:e.pageY,s=t.height,l=Math.floor(360*(s-Math.max(0,Math.min(s,i-o.y)))/s),n=t.$fields.eq(4).val(l).get(0);return t.change(n),!1},this.$hue.parent().on("mousedown touchstart",function(e){e.preventDefault?e.preventDefault():e.returnValue=!1;var o={cal:$(e.currentTarget).parent(),y:$(e.currentTarget).offset().top};$(document).on("mouseup touchend",o,t.upHueEvent),$(document).on("mousemove touchmove",o,t.moveHueEvent);var r=e.originalEvent.changedTouches,i="touchstart"===e.type?r[0].pageY:e.pageY,s=t.height,l=Math.floor(360*(s-(i-o.y))/s),n=t.$fields.eq(4).val(l).get(0);return t.change(n),!1}),this.upAlphaEvent=function(){return t.fillAlphaFields(t.color),$(document).off("mouseup touchend",t.upAlphaEvent),$(document).off("mousemove touchmove",t.moveAlphaEvent),!1},this.moveAlphaEvent=function(e){var r=e.data,i=e.originalEvent.changedTouches,s="touchmove"===e.type?i[0].pageY:e.pageY,l=t.height,n=Math.max(0,Math.min(l,s-r.y))/l,a=t.$fields.eq(7).val(o.roundAlpha(n)).get(0);return t.change(a),!1},this.$alpha.parent().on("mousedown touchstart",function(e){e.preventDefault?e.preventDefault():e.returnValue=!1;var r={cal:$(e.currentTarget).parent(),y:$(e.currentTarget).offset().top};$(document).on("mouseup touchend",r,t.upAlphaEvent),$(document).on("mousemove touchmove",r,t.moveAlphaEvent);var i=e.originalEvent.changedTouches,s="touchstart"===e.type?i[0].pageY:e.pageY,l=t.height,n=(s-r.y)/l,a=t.$fields.eq(7).val(o.roundAlpha(n)).get(0);return t.change(a),!1})},o.prototype.change=function(e){var o,t=$(e).parent(),r=parseFloat(this.$fields.eq(7).val()||"1");if(r=Math.min(1,Math.max(0,void 0===r?1:r)),t.attr("class").indexOf("_hex")>0){var i=(255*r).toString(16);i=i.length<1?"0"+i:i;var s=e.value.toString()+i;this.color=o=color_1.PdColorUtils.hexToHsb(color_1.PdColorUtils.fixHex(s)),this.fillRGBFields(o),this.fillHSBFields(o)}else t.attr("class").indexOf("_hsb")>0?(this.color=o=color_1.PdColorUtils.fixHSB({h:parseInt(this.$fields.eq(4).val(),10),s:parseInt(this.$fields.eq(5).val(),10),b:parseInt(this.$fields.eq(6).val(),10),a:r}),this.fillRGBFields(o),this.fillHexFields(o)):t.attr("class").indexOf("_rgb")>0?(this.color=o=color_1.PdColorUtils.rgbToHsb(color_1.PdColorUtils.fixRGB({r:parseInt(this.$fields.eq(1).val(),10),g:parseInt(this.$fields.eq(2).val(),10),b:parseInt(this.$fields.eq(3).val(),10),a:r})),this.fillHexFields(o),this.fillHSBFields(o)):this.color=o=color_1.PdColorUtils.fixHSB({h:parseInt(this.$fields.eq(4).val(),10),s:parseInt(this.$fields.eq(5).val(),10),b:parseInt(this.$fields.eq(6).val(),10),a:r});if(this.setAlphaSelector(o),this.setSelector(o),this.setHue(o),this.setAlpha(o),this.setNewColor(o),this.settings.onChange){var l=color_1.PdColorUtils.hsbRound(o),s=color_1.PdColorUtils.hsbToHex(o),n=color_1.PdColorUtils.hsbToRgb(o);this.settings.onChange(l,s,n,this,!0)}},o.prototype.fillAlphaFields=function(e){this.$fields.eq(7).val(o.roundAlpha(e.a))},o.prototype.fillHexFields=function(e){var o=color_1.PdColorUtils.hsbToHex(e).replace("#","");o=o.substring(0,6),this.$fields.eq(0).val(o)},o.prototype.fillHSBFields=function(e){this.$fields.eq(4).val(Math.round(e.h)).end().eq(5).val(Math.round(e.s)).end().eq(6).val(Math.round(e.b)).end()},o.prototype.fillRGBFields=function(e){var o=color_1.PdColorUtils.hsbToRgb(e);this.$fields.eq(1).val(o.r).end().eq(2).val(o.g).end().eq(3).val(o.b).end()},o.prototype.initSettings=function(t){return $.extend(!0,{},e.prototype.initSettings.call(this,o.defaultSettings),t)},o.prototype.initTemplate=function(){function e(e,o,t){return void 0===e&&(e="rgb"),void 0===o&&(o="r"),void 0===t&&(t=3),'<div class="pd-colorpicker-'+e+"-"+o.toLocaleLowerCase()+' pd-colorpicker-field"><div class="pd-colorpicker-field-letter">'+o.toLocaleUpperCase()+'</div><input type="text" maxlength="'+t+'" size="'+t+'" /><div class="pd-colorpicker-field-arrs"><div class="pd-colorpicker-field-uarr"></div><div class="pd-colorpicker-field-darr"></div></div></div>'}var t=this.settings.color;t=o.colorToHSB(t),this.origColor=this.color=t;var r=common_1.PdCommonUtils.createId("colorpicker_"),i='<div class="pd-colorpicker" id="'+r+'"><div class="pd-colorpicker-color"><div class="pd-colorpicker-color-overlay1"><div class="pd-colorpicker-color-overlay2"><div class="pd-colorpicker-selector-outer"><div class="pd-colorpicker-selector-inner"></div></div></div></div></div><div class="pd-colorpicker-hue"><div class="pd-colorpicker-hue-arrs"><div class="pd-colorpicker-hue-larr"></div></div></div><div class="pd-colorpicker-alpha"><div class="pd-colorpicker-alpha-arrs"><div class="pd-colorpicker-alpha-larr"></div></div></div><div class="pd-colorpicker-new-color"></div><div class="pd-colorpicker-current-color"></div><div class="pd-colorpicker-hex-field"><div class="pd-colorpicker-field-letter">#</div><input type="text" maxlength="6" size="6" /></div>'+e("rgb","r")+e("rgb","g")+e("rgb","b")+e("hsb","h")+e("hsb","s")+e("hsb","b")+e("alpha","a",4)+'<div class="pd-colorpicker-submit"></div></div>',s=$(i).attr("id",r).appendTo(this.settings.parent);this.settings.theme&&s.addClass("pd-colorpicker-"+this.settings.theme);var l=this.settings.submit?"":" pd-colorpicker-"+this.settings.layout+"-ns";s.addClass("pd-colorpicker-"+this.settings.layout+l),s.find("div.pd-colorpicker-submit").html(this.settings.submitText),this.$fields=s.find("input"),this.$selector=s.find("div.pd-colorpicker-color"),this.$selectorIndic=this.$selector.find("div.pd-colorpicker-selector-outer"),this.$hue=s.find("div.pd-colorpicker-hue-arrs");var n=this.$hue.parent();this.$alpha=s.find("div.pd-colorpicker-alpha-arrs");var a=navigator.userAgent.toLowerCase(),c="Microsoft Internet Explorer"===navigator.appName,d=c?parseFloat(a.match(/msie ([0-9]{1,}[.0-9]{0,})/)[1]):0;this.ngIE=c&&d<10;var p=["#ff0000","#ff0080","#ff00ff","#8000ff","#0000ff","#0080ff","#00ffff","#00ff80","#00ff00","#80ff00","#ffff00","#ff8000","#ff0000"];if(this.ngIE){var h=void 0,u=void 0;for(h=0;h<=11;h++){var v="height:8.333333%; ",f="filter:progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr="+p[h]+", endColorstr="+p[h+1]+");";v+=f,v+="-ms-"+f,u=$("<div></div>").attr("style",v),n.append(u)}}else{var g=p.join(",");n.attr("style",o.createGradient(g))}if(this.$newColor=s.find("div.pd-colorpicker-new-color"),this.$currentColor=s.find("div.pd-colorpicker-current-color"),this.height=s.find(".pd-colorpicker-color-overlay2").height(),this.updateColor(t),this.settings.selector){var m=$(this.settings.selector),b=m.offset(),C=b.top+m[0].offsetHeight,y=b.left,x=common_1.PdCommonUtils.getViewport(),_=s.width(),k=s.height();y+_>x.left+x.width&&(y-=_),C+k>x.top+x.height&&(C-=k+m.height()),s.css({left:y+"px",top:C+"px"})}return s},o.prototype.mounted=function(){e.prototype.mounted.call(this),this.bindEvent()},o.prototype.restoreOriginal=function(){var e=this.origColor;this.color=e,this.updateColor(e)},o.prototype.setCurrentColor=function(e){this.$currentColor.css("backgroundColor",color_1.PdColorUtils.hsbToHex(e))},o.prototype.setHue=function(e){var o=this.height;this.$hue.css("top",Math.floor(o-o*e.h/360))},o.prototype.setAlpha=function(e){var o=this.height;this.$alpha.css("top",Math.floor(o*e.a))},o.prototype.setAlphaSelector=function(e){var t=this.$alpha.parent(),r=color_1.PdColorUtils.hsbToRgb(this.color);if(this.ngIE){var i="height:100%; ",s="filter:progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr=rgba("+r.r+","+r.g+","+r.b+",0), endColorstr=rgba("+r.r+","+r.g+","+r.b+",1));";i+=s,i+="-ms-"+s,t.attr("style",i)}else{var l="rgba("+r.r+","+r.g+","+r.b+",0), rgba("+r.r+","+r.g+","+r.b+",1)";t.attr("style",o.createGradient(l))}},o.prototype.setNewColor=function(e){this.$newColor.css("backgroundColor",color_1.PdColorUtils.hsbToHex(e))},o.prototype.setSelector=function(e){var o=this.height,t=color_1.PdColorUtils.hsbToHex({h:e.h,s:100,b:100});this.$selector.css("backgroundColor",t),this.$selectorIndic.css({left:Math.floor(o*e.s/100),top:Math.floor(o*(100-e.b)/100)})},o.prototype.unbindEvent=function(){e.prototype.unbindEvent.call(this),$(document).off("mousedown",this.destroyEvent)},o.prototype.updateColor=function(e,t){void 0===t&&(t=!0),e=o.colorToHSB(e),this.fillRGBFields(e),this.fillHSBFields(e),this.fillHexFields(e),this.fillAlphaFields(e),this.setHue(e),this.setAlpha(e),this.setAlphaSelector(e),this.setSelector(e),t&&this.setCurrentColor(e),this.setNewColor(e)},o.defaultSettings={parent:"body",color:"#00b38a",livePreview:!0,layout:"full",submit:!0,submitText:"OK",theme:""},o}(component_1.PdComponent);exports.PdVisColorPicker=PdVisColorPicker;