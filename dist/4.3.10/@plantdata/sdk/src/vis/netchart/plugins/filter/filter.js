"use strict";var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),filter_list_1=require("../../../../icon/filter-list"),edit_item_1=require("../../../utils/edit-item/edit-item"),edit_1=require("../edit/edit"),slider_1=require("../../../utils/slider/slider"),autocomplete_1=require("../../../../ui/components/autocomplete/autocomplete"),radio_1=require("../../../../ui/components/radio/radio"),input_1=require("../../../../ui/components/input/input"),common_1=require("../../../../common/common"),PdVisPluginFilter=function(t){function e(e){var i=t.call(this,e)||this;return i.getFilterOptions=i.getData,i.setFilterOptions=i.setData,i}return __extends(e,t),e.prototype.getData=function(){for(var e=t.prototype.getData.call(this),i=0,s=this.settings.editItemSettings;i<s.length;i++){var a=s[i];a.customEnable&&"radio"===a.type&&"custom"===e[a.key]&&(e[a.key]=e["custom-"+a.key],delete e["custom-"+a.key])}for(var n in this.sliderMap)this.sliderMap.hasOwnProperty(n)&&(e[n]=this.sliderMap[n].getValue());return e},e.prototype.getPluginType=function(){return"filter"},e.prototype.setData=function(e,i){void 0===e&&(e={}),void 0===i&&(i=!1);for(var s=0,a=this.settings.editItemSettings;s<a.length;s++){var n=a[s];if(n.customEnable&&"radio"===n.type&&e[n.key]){var r=n.options||[];r instanceof Array?r.length&&r[0]instanceof Object&&(r=lodash_1.map(r,"value")):r=lodash_1.keys(r),common_1.PdCommonUtils.indexOfIgnoreType(r,e[n.key])<0&&(e["custom-"+n.key]=e[n.key],e[n.key]="custom")}}t.prototype.setData.call(this,e);for(var o in this.sliderMap)this.sliderMap.hasOwnProperty(o)&&this.sliderMap[o].setValue(e[o]);if(!i)for(var o in e)if(e.hasOwnProperty(o)){var n=lodash_1.find(this.settings.editItemSettings,["key",o]);n&&n.onchange&&n.onchange(e[o])}},e.prototype.updateFilter=function(t){var e=this.gentEditItem(t);this.select('[data-path="'+t.key+'"]').replaceWith(e),t.filterable&&this.addOptionFilter(t),this.updateAllSelectAllStatus()},e.prototype.addOptionFilter=function(t){var e=this.select('.pdvis-edit-item[data-path="'+t.key+'"]'),i=$('<div class="pdvis-edit-item-search"></div>');e.find(".pdvis-edit-item-content").prepend(i);var s=function(i){var s=e.find("[data-label]");if(i)if(t.isTree){s.addClass("hide");var a=s.filter('[data-label*="'+i+'"]');a.each(function(t,i){var s=$(i);s.removeClass("hide").addClass("open"),s.find(".hide[data-label]").removeClass("hide").addClass("open"),s.parentsUntil(e,".hide[data-label]").removeClass("hide").addClass("open")})}else{s.removeClass("hide");var n=s.filter(':not([data-label*="'+i+'"])');n.addClass("hide")}else s.removeClass("hide")};new autocomplete_1.PdUIAutocomplete({selector:i,size:"sm",name:null,prompt:!1,theme:"normal",onSearch:s,icon:{close:{onclick:function(t){t.clear(),s("")}}}})},e.prototype.bindEvent=function(){var e=this;t.prototype.bindEvent.call(this),this.getMainContainer().on("click",'.pdvis-edit-item input[type="checkbox"]',function(t){var i=$(t.currentTarget),s=i.closest(".pdvis-edit-item").attr("data-path"),a=e.getData(),n=lodash_1.find(e.settings.editItemSettings,["key",s]);n.onchange&&n.onchange(a[s])}),this.addEvent("takeSnapshot",function(t){t.snapshot.filter=e.filterData}),this.addEvent("restoreSnapshot",function(t){e.filterData=t.snapshot.filter,e.setData(e.filterData)})},e.prototype.gentEditItem=function(e){if(e.buildItem)return e.buildItem(e);if("custom"===e.type){switch(e.customType){case"slider":var i='<div class="pdvis-slider-container"><div class="pdvis-slider"></div></div>';return edit_item_1.PdVisEditItem.buildEditItem(e.label,i,"",e.key)}return console.error("Not support type: "+e.customType),""}return t.prototype.gentEditItem.call(this,e)},e.prototype.getMainContainer=function(){return this.select(".pdvis-chart-filter-panel")},e.prototype.initSettings=function(i){var s=this;return $.extend(!0,{positiveBtn:{enable:!0,html:"分析",onclick:function(){s.filterData=s.getData(),s.hidePanel(),s.container.reload()}},negativeBtn:{enable:!0}},t.prototype.initSettings.call(this,e.defaultSettings),i)},e.prototype.initTemplate=function(){var t="筛选过滤",e=filter_list_1["default"](20);this.settings.editItemSettings=lodash_1.orderBy(lodash_1.map(this.settings.editItemSettings,function(t){return t.index=t.index||0===t.index?t.index:1,t}),["index"],["asc"]);var i=this.buildEdit(),s='<div class="pdvis-chart-filter-panel"><div class="pdvis-chart-filter-body"></div></div>',a=this.buildPluginTemplate(s,e,t);return a.find(".pdvis-chart-filter-body").append(i),this.sliderMap={},a},e.prototype.mounted=function(){t.prototype.mounted.call(this);for(var e={},i=0,s=this.settings.editItemSettings;i<s.length;i++){var a=s[i];if(!a.disabled){if(void 0!==a.selected&&(e[a.key]=a.selected),"custom"===a.type)switch(a.customType){case"slider":var n=$.extend(!0,{selector:this.select('[data-path="'+a.key+'"] .pdvis-slider'),value:a.selected},a.settings);this.sliderMap[a.key]=new slider_1.PdVisSlider(n)}else a.filterable&&this.addOptionFilter(a);if(a.customEnable&&"radio"===a.type){var r={html:"自定义",atts:{"data-label":"自定义"},input:{atts:{id:a.key+"-0",value:"custom",name:a.key}}},o=radio_1.PdUIRadio.create(r)+input_1.PdUIInput.create({size:"sm",atts:{name:"custom-"+a.key}}),d=this.select('.pdvis-edit-item[data-path="'+a.key+'"]');d.find(".pdvis-edit-item-content").append('<div class="pdvis-cr-custom">'+o+"</div>")}}}this.filterData=this.getData()||{};for(var l in e)if(e.hasOwnProperty(l)){var p=this.filterData[l];(!p||p instanceof Array&&!p.length&&e[l].length)&&(this.filterData[l]=e[l])}this.setData(this.filterData,!0)},e.defaultSettings={side:"right",editItemSettings:[]},e}(edit_1.PdVisPluginEdit);exports.PdVisPluginFilter=PdVisPluginFilter;