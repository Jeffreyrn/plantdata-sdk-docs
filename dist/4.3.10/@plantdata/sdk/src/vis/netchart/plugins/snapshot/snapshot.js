"use strict";var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),moment_es6_1=require("moment-es6"),camera_enhance_1=require("../../../../icon/camera-enhance"),plugin_1=require("../plugin"),dialog_1=require("../../../utils/modal/dialog/dialog"),edit_item_1=require("../../../utils/edit-item/edit-item"),form_1=require("../../../../ui/components/form/form"),message_1=require("../../../../ui/components/message/message"),PdVisPluginSnapshot=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.getPluginType=function(){return"snapshot"},e.prototype.bindEvent=function(){var e=this;t.prototype.bindEvent.call(this),this.drawItems(),this.select(".pdvis-float-item-head").on("click",function(t){var e=$(t.target).closest(".pdvis-panels-float-item").toggleClass("active");e.siblings(".pdvis-panels-float-item").removeClass("active")}),this.select(".pdvis-float-item-detail").on("click",".pdvis-snapshot-item",function(t){e.container.restoreSnapshot($(t.currentTarget).index()),$(t.target).closest(".pdvis-panels-float-item").toggleClass("active")}),this.select(".pdvis-snapshot-take").on("click",function(t){form_1.PdUIForm.setFormData(e.editDialog.$el,{}),e.editDialog.open({event:t})})},e.prototype.createEditDialogSettings=function(){for(var t=this,e="",i=[{type:"input",key:"name",label:"名称",mode:"label",required:!0},{type:"textarea",key:"desc",label:"描述",mode:"label",placeholder:"可选"}],s=0,a=i;s<a.length;s++){var n=a[s];e+=edit_item_1.PdVisEditItem.gentEditItem(n)}return{cls:"pdvis-snapshot-edit-dialog",title:"保存快照",body:e,positiveClick:function(){if(t.validate(i)){var e=form_1.PdUIForm.getFormData(t.editDialog.$el);return t.container.takeSnapshot(e.name,e.desc),t.drawItems(),Promise.resolve(e)}return Promise.reject(new Error("请将表单填写完整"))}}},e.prototype.drawItem=function(t){if(!this.settings.drawItem){var e=moment_es6_1["default"](t.createTime).format("YYYY-MM-DD HH:mm:ss"),i=t.desc?'<div class="pdvis-snapshot-item-desc" title="'+t.desc+'">'+t.desc+"</div>":"";return'<div class="pdvis-snapshot-item"><div class="pdvis-snapshot-item-title" title="'+t.name+'">'+t.name+'<span class="pdvis-snapshot-item-date">'+e+"</span></div>"+i+"</div>"}this.settings.drawItem(t)},e.prototype.drawItems=function(){var t=this.container.snapshotList;this.select(".pdvis-snapshot").empty(),t.length||this.select(".pdvis-snapshot").append('<div class="pdvis-snapshot-no-data">没有快照数据</div>');for(var e in t)if(t.hasOwnProperty(e)){var i=t[e],s=$(this.drawItem(i)).data("data",i);this.select(".pdvis-snapshot").append(s)}},e.prototype.initSettings=function(i){return $.extend(!0,{},t.prototype.initSettings.call(this,e.defaultSettings),i)},e.prototype.initTemplate=function(){var t="快照",e=$('<div class="pdvis-snapshot-container"></div>'),i=camera_enhance_1["default"](20);return e.append('<div class="pdvis-float-item-head"><div class="pdvis-panels-icon" data-pdui-tooltip="hover" data-pdui-tooltip-position="bottom" title="'+t+'">'+i+'</div><div class="pdvis-panels-tooltip">'+t+'</div></div><div class="pdvis-float-item-detail"><div class="pdvis-snapshot-take">'+i+'拍摄快照</div><div class="pdvis-snapshot"></div></div>'),this.buildPluginTemplate(e,i,t)},e.prototype.mounted=function(){t.prototype.mounted.call(this);var e=this.createEditDialogSettings();e&&(this.editDialog=new dialog_1.PdVisDialog(e)),this.bindEvent()},e.prototype.unbindEvent=function(){t.prototype.unbindEvent.call(this),this.select(".pdvis-float-item-head").off("click"),this.select(".pdvis-float-item-detail").off("click",".pdvis-snapshot-item")},e.prototype.validate=function(t){var e=!0;if(this.editDialog)for(var i=0,s=t;i<s.length;i++){var a=s[i];if(a.required&&"input"===a.type){var n=this.editDialog.$el.find('.pdvis-edit-item[data-path="'+a.key+'"]');edit_item_1.PdVisEditItem.checkValueItemRequired(n)||(message_1.PdUIMessage.error(a.label+"不能为空"),e=!1)}}return e},e.defaultSettings={side:"top",isFloat:!0},e}(plugin_1.PdVisPlugin);exports.PdVisPluginSnapshot=PdVisPluginSnapshot;