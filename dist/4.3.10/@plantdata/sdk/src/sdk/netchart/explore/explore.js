"use strict";var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),page_1=require("../../../vis/netchart/plugins/page/page"),netchart_1=require("../netchart"),rule_1=require("../plugins/rule/rule"),stats_chart_1=require("../plugins/stats/stats-chart/stats-chart"),explore_1=require("../plugins/model/explore"),filter_1=require("../plugins/filter/filter"),PdSDKExplore=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.defaultType="explore",e}return __extends(e,t),e.prototype.loadParamsUpdate=function(e){t.prototype.loadParamsUpdate.call(this,e);var i=this.netChart.fixedNodes;i&&i.length&&this.infobox.load(i[0]),this.rule&&this.updateLinkLegend()},e.prototype.buildFilter=function(e){var i=t.prototype.buildFilter.call(this,[{key:"distance",label:"设定显示层数",selected:1,options:[1,2,3,4,5,6],index:0}]);return filter_1.PdSDKPluginFilter.mergeFilterSettings(i,e)},e.prototype.buildLoaderParams=function(e){var i=t.prototype.buildLoaderParams.call(this,e);e.$type="explore";var s=[];e.nodes?s=lodash_1.map(e.nodes,"id"):e.id&&(s=[e.id],e.nodes=[{id:e.id}]);var a=this.settings.loaderSettings.ajaxSettings,n=$.extend({kgName:this.settings.loaderSettings.kgName},a.queryData),r=$.extend({isRelationMerge:!1,isInherit:!this.settings.showAllSchemaOptions,hyponymyDistance:6},a.formData);if(this.filter){var o=this.filter.getFilterOptions();$.extend(r,o),"merge"===e.$source&&(r.distance=1)}if(this.rule){var l=this.rule.getSelectedData();Object.keys(l).length&&(r.reasoningRuleConfigs=l)}var p={};return 1===e.nodes.length?(r.id=s[0],r.isTop=!this.settings.showAllSchemaOptions,this.page&&(n.pageNo=this.page.pageNo,n.pageSize=this.page.pageSize),p={queryData:n,formData:r,url:a.url||a.baseUrl+"rule/graph"}):(r.ids=s,p={queryData:n,formData:r,url:a.url||a.baseUrl+"rule/relation"}),$.extend(!0,i,p)},e.prototype.dealGraphData=function(e){if(e=t.prototype.dealGraphData.call(this,e),this.settings.rule&&this.settings.rule.enable)for(var i=this.getRuleMap(),s=0,a=e.links;s<a.length;s++){var n=a[s];n.attId<=-1e4&&(n.attName=i[-n.attId].label)}return e},e.prototype.destroyPlugins=function(){t.prototype.destroyPlugins.call(this),this.prompt&&this.prompt.destroy(),this.page&&this.page.destroy(),this.rule&&this.rule.destroy(),this.statsChart&&this.statsChart.destroy()},e.prototype.getRuleMap=function(){for(var t=this.rule.settings.editItemSettings,e={},i=0,s=t;i<s.length;i++){var a=s[i];e[a.key]=a}return e},e.prototype.graphInitSuccess=function(e){t.prototype.graphInitSuccess.call(this,e),e=e.entities,e&&e.length&&this.load(this.transferNode2Param(e[0]),"init-explore")},e.prototype.initNetChart=function(){t.prototype.initNetChart.call(this),this.netChart.$el.addClass("pdsdk-explore")},e.prototype.initPlugins=function(){var e=this,i=this.settings;if(i.prompt&&i.prompt.enable){var s={promptSettings:{schema:this.schema,promptSettings:this.settings.promptSettings}},a=this.createSDKPluginSettings(i.prompt,s);this.prompt=new explore_1.PdSDKPluginExplore(a)}if(i.page&&i.page.enable){var a=this.createPluginSettings(i.page);this.page=new page_1.PdVisPluginPage(a)}if(i.contextmenu&&i.contextmenu.enable){var n=this.createSDKPluginSettings({settings:{max:10,positiveBtn:{onclick:function(t){var i=t.getTagData();e.load({id:"",nodes:i},"merge"),t.closeDialog()}}}});i.contextmenu.settings=$.extend(!0,{menu:{"sub-graph":{settings:{advancedPromptDialogSettings:n}}}},i.contextmenu.settings)}if(t.prototype.initPlugins.call(this),i.statsChart&&i.statsChart.enable){var s={schema:this.schema,kgName:i.kgName,ajaxSettings:i.ajaxSettings},a=this.createSDKPluginSettings(i.statsChart,s);this.statsChart=new stats_chart_1.PdSDKPluginStatsChart(a)}if(i.rule&&i.rule.enable){var s={ajaxSettings:i.ajaxSettings,kgName:i.kgName},a=this.createSDKPluginSettings(i.rule,s);this.rule=new rule_1.PdSDKPluginRule(a),a.editItemSettings&&a.editItemSettings.length||(this.initPrepareList.rule=!0,this.rule.list(1).then(function(){e.initPrepareList.rule=!1,e.updateInitStatus()}))}},e.prototype.initSettings=function(i){return i=$.extend(!0,{},e.defaultSettings,i),t.prototype.initSettings.call(this,i)},e.prototype.updateFixedNodes=function(){var t=this.netChart,e=t.loadParams,i=t.data;if(e&&i.nodes&&i.nodes.length){var s=void 0;if(this.isExtend(e)){if(e.nodes)for(var a=0,n=0,r=e.nodes;n<r.length;n++){var o=r[n];s=o.id?"id":"name",e.nodes[a]=lodash_1.find(i.nodes,[s,o[s].toString()])||i.nodes[a],"merge"===e.$source&&t.fixedNodes.push(e.nodes[a]),a++}}else{if(t.fixedNodes=[],e.nodes)for(var a=0,l=0,p=e.nodes;l<p.length;l++){var o=p[l];s=o.id?"id":"name",e.nodes[a]=lodash_1.find(i.nodes,[s,o[s].toString()])||i.nodes[a],t.fixedNodes.push(e.nodes[a]),a++}t.fixedNodes=lodash_1.compact(t.fixedNodes)}}},e.prototype.updateLinkLegend=function(){var t=this.netChart.getAvailableData();if(t&&t.links&&this.linkLegend){for(var e=lodash_1.keys(lodash_1.keyBy(t.links,"attId")),i=this.linkLegend.getData(),s=this.getRuleMap(),a=0,n=e;a<n.length;a++){var r=n[a],o=parseInt(r,10);if(o<=-1e4){var l=s[-o],p=l.label,d=lodash_1.find(i,["key",o]);if(d)d.value=p;else{var h={key:o,value:p,dashed:!0};l.color&&(h.color=l.color),i.push(h)}}}this.linkLegend.updateData(i)}},e.defaultSettings={prompt:{enable:!0,settings:{cls:"pdvis-prompt-static"}},page:{enable:!0,settings:{pageSize:20,side:"top"}},infoboxSettings:{mode:"mixins",mixinsId:"right",settings:{ajaxSettings:{formData:{isRelationAtts:!1}}}},history:{enable:!1},find:{enable:!1},filter:{settings:{side:"left",isFloat:!0,widthBox:!0,positiveBtn:{enable:!1},negativeBtn:{enable:!1}}},resetLayout:{enable:!0},rule:{enable:!0,settings:{editItemSettings:[],side:"left",isFloat:!0,widthBox:!0,isBoxOpen:!0}},statsChart:{enable:!0,mixinsId:"right"},mixinsSettings:{right:{active:!0}},netChartSettings:{rightPanel:{mode:"fixed",active:!0}}},e}(netchart_1.PdSDKNetChart);exports.PdSDKExplore=PdSDKExplore;