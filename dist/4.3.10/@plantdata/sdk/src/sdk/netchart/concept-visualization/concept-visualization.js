"use strict";var __extends=this&&this.__extends||function(){var t=function(i,e){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e])})(i,e)};return function(i,e){function n(){this.constructor=i}t(i,e),i.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),echarts=require("echarts"),common_1=require("../../../common/common"),utils_1=require("../../utils/utils"),component_1=require("../../../core/component"),device_hub_1=require("../../../icon/device-hub"),PdSDKConceptVisualization=function(t){function i(i){return t.call(this,i)||this}return __extends(i,t),i.prototype.destroy=function(){this.chart.dispose(),t.prototype.destroy.call(this)},i.prototype.load=function(){var t=this,i=this.settings.ajaxSettings,e=i.queryData||{},n=i.formData||{};n.kgName=this.settings.kgName,n.conceptId="0";var a=this.$el.find(".pdsdk-concept-visualization-chart").empty(),o={url:i.baseUrl+"app/model/stat",type:"POST",data:n,el:a[0]};return o=$.extend(!0,{},o,i,{data:{isDisplay:this.settings.showRelation}}),o.url=utils_1.PdSDKUtils.buildUrl(o.url,e),utils_1.PdSDKUtils.ajax(o).then(function(i){return o.success?i:(t.handleData(i),void t.drawChart())})},i.prototype.bindEvent=function(){var i=this;t.prototype.bindEvent.call(this),this.chartResize=function(){i.chart&&i.chart.resize()},$(window).on("resize",this.chartResize),this.$el.find(".pdsdk-concept-visualization-header").on("click",".pdsdk-concept-visualization-btn",function(t){$(t.currentTarget).hasClass("pdsdk-concept-visualization-btn-active")||($(t.currentTarget).addClass("pdsdk-concept-visualization-btn-active").siblings().removeClass("pdsdk-concept-visualization-btn-active"),i.settings.orient=$(t.currentTarget).attr("value"),i.chart.dispose(),i.drawChart())}).on("click",".pdsdk-concept-visualization-checkbox input",function(t){i.settings.showRelation=$(t.currentTarget).prop("checked"),i.chart.dispose(),i.settings.showRelation?i.allData?i.drawChart():i.load():i.conceptData?i.drawChart():i.load()})},i.prototype.drawChart=function(){var t;t=this.settings.showRelation?this.allData:this.conceptData;var i=this.$el.find(".pdsdk-concept-visualization-chart")[0];this.chart=echarts.init(i);var e={};if("horizontal"===this.settings.orient){var n=this.getMinHeight(t);$(i).css("height",n),e=this.settings.chartHorizontalSettings}else $(i).css("height","100%"),e=this.settings.chartVerticalSettings;e.series[0].data=[t],this.chart.setOption(e),this.chartResize()},i.prototype.handleData=function(t){var i=this,e=function(t){if(delete t.id,t.hasOwnProperty("parentId")?(t.itemStyle={borderColor:i.settings.conceptColor},t.parentId===-1&&(t.label={rotate:0})):(t.name&&t.name.indexOf("对象属性")<0&&(t.name="对象属性："+t.name),t.symbol="emptyCircle",t.symbolSize=12,t.label={fontSize:14},t.itemStyle={borderColor:i.settings.attributeColor}),t.children&&t.children.length)for(var n=0;n<t.children.length;n++)e(t.children[n])};e(t),this.settings.showRelation?this.allData=t:this.conceptData=t},i.prototype.initSettings=function(t){var e={1:"整数值",2:"浮点值",4:"日期时间",41:"日期",42:"时间",5:"字符串",6:"计算属性",8:"Map型",10:"文本型"},n={tooltip:{trigger:"item",triggerOn:"mousemove",formatter:function(t){var i=t.marker+t.name;if(t.data.numAtts&&t.data.numAtts.length)for(var n=0,a=t.data.numAtts;n<a.length;n++){var o=a[n];i+='<br><span style="width: 15px;display: inline-block"></span>'+o.name+": "+e[o.dataType]}return i}},toolbox:{show:!0,feature:{saveAsImage:{name:"概念可视化"}}},series:[{type:"tree",top:"40",left:"10%",bottom:"40",right:"10%",initialTreeDepth:3,itemStyle:{borderWidth:3},expandAndCollapse:!0,animationDuration:550,animationDurationUpdate:750,symbolSize:16}]};return i.defaultSettings.chartHorizontalSettings=$.extend(!0,{},n,{series:[{orient:"horizontal",label:{normal:{position:"left",verticalAlign:"middle",align:"right",fontSize:14}},leaves:{label:{normal:{position:"right",verticalAlign:"middle",align:"left"}}}}]}),i.defaultSettings.chartVerticalSettings=$.extend(!0,{},n,{series:[{orient:"vertical",label:{normal:{position:"top",verticalAlign:"left",rotate:45,align:"left",fontSize:12,distance:10}}}]}),$.extend(!0,{},i.defaultSettings,t)},i.prototype.initTemplate=function(){var t=$(this.settings.selector);t.addClass("pdvis-namespace"),this.saveOriginClass(t);var i=device_hub_1["default"](24),e=common_1.PdCommonUtils.createId();return t.append('\n<div class="pdsdk-concept-visualization-header clearfix">\n    <div class="pdsdk-concept-visualization-header-left clearfix">\n        <div class="pdsdk-concept-visualization-title">模型可视化</div>\n         <label for="'+e+'" class="pdui-checkbox pdsdk-concept-visualization-checkbox">\n            <input type="checkbox" id="'+e+'" '+(this.settings.showRelation?"checked":"")+'>\n            <span>展示对象属性</span>\n        </label>\n    </div>\n    <div class="pdsdk-concept-visualization-header-right clearfix">\n        <div class="pdsdk-concept-visualization-btns">\n            <div class="pdsdk-concept-visualization-btn pdsdk-concept-visualization-btn-vertical pdsdk-concept-visualization-btn-active"\n             data-pdui-tooltip="" data-pdui-tooltip-position="bottom" title="纵向视图" value="vertical">'+i+'</div>\n            <div class="pdsdk-concept-visualization-btn pdsdk-concept-visualization-btn-horizontal"\n             data-pdui-tooltip="" data-pdui-tooltip-position="bottom" title="横向视图" value="horizontal">'+i+'</div>\n        </div>\n        <!--<div class=" pdsdk-concept-visualization-export">-->\n            <!--<button class="pdui-btn pdui-btn-primary pdui-btn-sm" disabled>导出</button>-->\n        <!--</div>-->\n    </div>\n</div>\n<div class="pdsdk-concept-visualization-content">\n    <div class="pdsdk-concept-visualization-chart"></div>\n</div>'),t},i.prototype.getMinHeight=function(t){function i(t,n){e[t]||(e[t]=0),e[t]=e[t]+n.length;for(var a=0;a<n.length;a++)n[a].children&&n[a].children.length&&i(t+1,n[a].children)}var e={};i(1,[t]);var n=0;for(var a in e)n<e[a]&&(n=e[a]);return 35*n+"px"},i.prototype.mounted=function(){t.prototype.mounted.call(this),this.settings.conceptData&&(this.conceptData=this.settings.conceptData,this.settings.showRelation||this.drawChart()),this.settings.allData&&(this.allData=this.settings.allData,this.settings.showRelation&&this.drawChart()),this.bindEvent(),this.load()},i.prototype.unbindEvent=function(){t.prototype.unbindEvent.call(this),$(window).off("resize"),this.$el.find(".pdsdk-concept-visualization-header").off("click",".pdsdk-concept-visualization-btn").off("click",".pdsdk-concept-visualization-checkbox input")},i.defaultSettings={orient:"vertical",showRelation:!1,attributeColor:"#eaad84",conceptColor:"#5677FC"},i}(component_1.PdComponent);exports.PdSDKConceptVisualization=PdSDKConceptVisualization;