"use strict";var __extends=this&&this.__extends||function(){var t=function(e,a){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])})(e,a)};return function(e,a){function d(){this.constructor=e}t(e,a),e.prototype=null===a?Object.create(a):(d.prototype=a.prototype,new d)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),editor_tool_1=require("./editor-tool"),form_1=require("../../../../ui/components/form/form"),prompt_1=require("../../../prompt/prompt"),utils_1=require("../../../utils/utils"),common_1=require("../../../../common/common"),edit_item_1=require("../../../../vis/utils/edit-item/edit-item"),alert_1=require("../../../../vis/utils/alert"),tag_prompt_1=require("../../../utils/tag-prompt"),add_circle_1=require("../../../../icon/add-circle"),swap_vert_1=require("../../../../icon/swap-vert"),arrow_back_1=require("../../../../icon/arrow-back"),PdSDKEditorAddRelation=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.destroy=function(){this.endPrompt.destroy(),this.selfEndPrompt.destroy(),this.selfStartPrompt.destroy(),this.startPrompt.destroy(),t.prototype.destroy.call(this)},e.prototype.updateStatusBySelection=function(t,e,a){1===t.length&&0===e.length&&1===t[0].type?(this.startData=t[0],this.endData=null,this.updateStatus(!0),this.updateVisibility(!0)):2===t.length&&0===e.length&&1===t[0].type&&1===t[1].type?(this.startData=t[0],this.endData=t[1],this.updateStatus(!0),this.updateVisibility(!0)):0===t.length&&0===e.length?(this.startData=null,this.endData=null,this.updateVisibility(!0),this.updateStatus(!0)):(this.updateStatus(!1),this.updateVisibility(!1))},e.prototype.addAttr=function(t,e){var a=this.settings.ajaxSettings,d=a.queryData||{},i=a.formData||{};d.kgName=this.settings.kgName,i.instanceId=this.startData.id,i.objValId=this.endData.id,t&&(i.attDefId=t),e&&(i.attName=e),i.attType="1";var n={url:a.baseUrl+"attribute/add/attribute",type:"POST",data:i};return n=$.extend(!0,{},n,a,this.settings.addAttrValSettings),n.url=utils_1.PdSDKUtils.buildUrl(n.url,d),utils_1.PdSDKUtils.ajax(n)},e.prototype.addAttribute=function(t){var e=this.settings.ajaxSettings,a=e.queryData||{},d=e.formData||{};a.kgName=this.settings.kgName,d.attDefJson=JSON.stringify(t);var i={url:e.baseUrl+"attribute/addOrUpdate/definition",type:"POST",data:d};return i=$.extend(!0,{},i,e,this.settings.addAttributeSettings),i.url=utils_1.PdSDKUtils.buildUrl(i.url,a),utils_1.PdSDKUtils.ajax(i)},e.prototype.bindDialogEvent=function(){var t=this;this.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-switch").on("click",function(){var e=t.startData;t.startData=t.endData,t.endData=e,t.startData&&t.startData.classId?t.getAttributeList().then(function(e){t.attsData=e||[],t.setSelectOptions(e),e[0]&&(t.endRange=e[0].range.split(" "))}):t.setSelectOptions([]),(!t.endData||!t.attsData.length||t.attsData[0].range.indexOf(t.endData.classId.toString())<0)&&(t.endData=null),t.setInputValue()}),this.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-select").on("change","select",function(e){var a=lodash_1.find(t.attsData,function(t){return t.id.toString()===$(e.currentTarget).val()});a?t.endRange=a.range.split(" "):t.endRange=[];for(var d=!0,i=0,n=t.endRange;i<n.length;i++){var o=n[i];t.endData&&o.toString()===t.endData.classId.toString()&&(d=!1)}d&&(t.endData=null,t.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-end input").val(""))}),this.editDialog.$el.find(".pdsdk-editor-add-relation-add-define-public").on("click",function(){t.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-content-add-relation").removeClass("hide").siblings().addClass("hide"),t.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-go-back").removeClass("hide");var e={isFunctional:"0",name:""};form_1.PdUIForm.setFormData(t.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-content-add-relation"),e);var a=[];if(t.endData){var d=lodash_1.find(t.settings.schema.types,function(e){return e.k.toString()===t.endData.classId.toString()});if(d){var i={id:d.k,name:d.v};a.push(i)}}t.addRelationRangePromptTag.setData(a)}),this.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-go-back").on("click",function(e){$(e.currentTarget).addClass("hide"),t.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-content-normal").removeClass("hide").siblings().addClass("hide")}),this.editDialog.$el.find(".pdsdk-editor-add-relation-add-define-self").on("click",function(){if(!t.startData||!t.startData.id)return common_1.PdCommonUtils.error("请选择起点"),Promise.reject("请选择起点");t.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-go-back").removeClass("hide"),t.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-content-add-self-attr").removeClass("hide").siblings().addClass("hide");var e={start:t.startData&&t.startData.name?t.startData.name:"",end:t.endData&&t.endData.name?t.endData.name:"",attName:""};form_1.PdUIForm.setFormData(t.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-content-add-self-attr"),e)})},e.prototype.createEditDialogSettings=function(){var t=this,e='<div class="pdsdk-editor-add-relation-dialog-content"></div>';return{cls:"pdsdk-editor-add-relation-dialog",title:this.settings.title,body:e,positiveClick:function(){if(!t.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-content-normal").hasClass("hide")){var e=form_1.PdUIForm.getFormData(t.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-content-normal"));return t.startData&&t.endData&&e.attDefId?t.addAttr(e.attDefId,"").then(function(a){var d=t.settings.netChart.getData(),i=lodash_1.find(d.nodes,function(e){return e.id.toString()===t.startData.id.toString()}),n=lodash_1.find(d.nodes,function(e){return e.id.toString()===t.endData.id.toString()}),o=lodash_1.find(t.settings.schema.atts,function(t){return t.k.toString()===e.attDefId.toString()});i||t.addNode(t.settings.netChart,t.startData),n||t.addNode(t.settings.netChart,t.endData);var r={attId:parseInt(e.attDefId,10),attName:o&&o.v?o.v:"",from:t.startData.id,id:a,to:t.endData.id};t.addLink(t.settings.netChart,r),t.endData=null}):(common_1.PdCommonUtils.error("请填写完整表单"),Promise.reject("请填写完整表单"))}if(!t.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-content-add-self-attr").hasClass("hide")){var a=form_1.PdUIForm.getFormData(t.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-content-add-self-attr"));return t.startData&&t.endData&&a.attName?t.addAttr("",a.attName).then(function(e){var d=t.settings.netChart.getData(),i=lodash_1.find(d.nodes,function(e){return e.id.toString()===t.startData.id.toString()}),n=lodash_1.find(d.nodes,function(e){return e.id.toString()===t.endData.id.toString()});i||t.addNode(t.settings.netChart,t.startData),n||t.addNode(t.settings.netChart,t.endData);var o={attId:0,attName:a.attName,from:t.startData.id,id:e,to:t.endData.id};t.addLink(t.settings.netChart,o),t.endData=null}):(common_1.PdCommonUtils.error("请填写完整表单"),Promise.reject("请填写完整表单"))}if(!t.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-content-add-relation").hasClass("hide")){var d=form_1.PdUIForm.getFormData(t.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-content-add-relation")),i=t.addRelationRangePromptTag.getData();if(!(d.name&&i&&i.length))return common_1.PdCommonUtils.error("请填写完整表单"),Promise.reject("请填写完整表单");var n={name:d.name,isFunctional:d.isFunctional,range:lodash_1.map(i,"id").join(" "),domain:t.startData.classId.toString(),type:"1"};t.addAttribute(n).then(function(e){var a=t.settings.schema,n={k:parseInt(e,10),v:d.name,dataType:0,domain:t.startData.classId.toString(),range:lodash_1.map(i,"id"),type:1};a.atts.push(n),t.endRange=lodash_1.map(i,"id"),t.settings.sdkNetChart.updateSchema(a);var o=t.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-select");return o.find("select").append('<option value="'+e+'">'+d.name+"</option>"),form_1.PdUIForm.setFormData(o,{attDefId:e}),t.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-content-add-relation").addClass("hide").siblings(".pdsdk-editor-add-relation-dialog-content-normal").removeClass("hide"),Promise.reject("")})}}}},e.prototype.getAttributeList=function(){var t=this.settings.ajaxSettings,e=t.queryData||{};e.kgName=this.settings.kgName,e.id=this.startData.classId,e.type="0";var a={url:t.baseUrl+"attribute/get/definition",type:"GET"};return a=$.extend(!0,{},a,t,this.settings.attributeListSettings),a.url=utils_1.PdSDKUtils.buildUrl(a.url,e),utils_1.PdSDKUtils.ajax(a).then(function(t){var e=lodash_1.filter(t.rsData,function(t){return"1"===t.type});return Promise.resolve(e)})},e.prototype.initSettings=function(a){var d=$.extend(!0,{},e.defaultSettings);return $.extend(!0,{},t.prototype.initSettings.call(this,d),a)},e.prototype.mounted=function(){var e=this;t.prototype.mounted.call(this);for(var a=swap_vert_1["default"](30),d=arrow_back_1["default"](24,{"class":"pdsdk-editor-add-relation-dialog-go-back hide"}),i=[{type:"custom",key:"start",label:"起点",mode:"label",html:'<div class="pdsdk-editor-add-relation-dialog-content-add-self-attr-start"></div>',required:!0},{type:"input",key:"attName",label:"私有关系名称",mode:"label",required:!0},{type:"custom",key:"end",label:"终点",mode:"label",html:'<div class="pdsdk-editor-add-relation-dialog-content-add-self-attr-end"></div>',required:!0}],n="",o=0,r=i;o<r.length;o++){var s=r[o];n+=edit_item_1.PdVisEditItem.gentEditItem(s)}for(var l=[{type:"input",key:"name",label:"名称",mode:"label",required:!0},{type:"custom",key:"range",label:"值域",mode:"label",html:'<div class="pdsdk-editor-add-relation-define-range-prompt"></div>',required:!0},{type:"custom",key:"isFunctional",label:"类型",mode:"label",html:'<div class="pdsdk-editor-define-attribute-modify-select">\n                        <select class="pdsdk-editor-define-attribute-table-select" name="isFunctional">\n                            <option value="0">非单值型</option>\n                            <option value="1">单值型</option>\n                        </select>\n                    </div>'}],g="",p=0,c=l;p<c.length;p++){var s=c[p];g+=edit_item_1.PdVisEditItem.gentEditItem(s)}this.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-content").append('\n        <div class="pdsdk-editor-add-relation-dialog-content-normal">\n            <div class="pdsdk-editor-add-relation-dialog-tip"></div>\n            <div class="pdsdk-editor-add-relation-dialog-main">\n                <div class="pdsdk-editor-add-relation-dialog-item pdsdk-editor-add-relation-dialog-item-start clearfix">\n                    <div class="pdsdk-editor-add-relation-dialog-label">起点</div>\n                    <div class="pdsdk-editor-add-relation-dialog-start pdsdk-editor-add-relation-dialog-item-main clearfix"></div>\n                </div>\n                <div class="pdsdk-editor-add-relation-dialog-item pdsdk-editor-add-relation-dialog-item-switch clearfix">\n                    <div class="pdsdk-editor-add-relation-dialog-dashed"></div>\n                    <div class="pdsdk-editor-add-relation-dialog-switch">\n                        '+a+'\n                    </div>\n                </div>\n                <div class="pdsdk-editor-add-relation-dialog-item clearfix">\n                    <div class="pdsdk-editor-add-relation-dialog-label">终点</div>\n                    <div class="pdsdk-editor-add-relation-dialog-end pdsdk-editor-add-relation-dialog-item-main clearfix"></div>\n                </div>\n                <div class="pdsdk-editor-add-relation-dialog-item clearfix">\n                <div class="pdsdk-editor-add-relation-dialog-label">关系类型</div>\n                    <div class=" pdsdk-editor-add-relation-dialog-item-main clearfix">\n                        <div class="pdsdk-editor-add-relation-dialog-select">\n                            <select name="attDefId"></select>\n                        </div>\n                        <div class="pdsdk-editor-add-relation-add-define">\n                            无匹配项？<span class="pdsdk-editor-add-relation-add-define-public">新建关系类型</span>\n                            或<span class="pdsdk-editor-add-relation-add-define-self">创建私有关系</span>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div class="pdsdk-editor-add-relation-dialog-content-add-self-attr hide">\n            '+n+'\n        </div>\n        <div class="pdsdk-editor-add-relation-dialog-content-add-relation hide">\n            '+g+"\n        </div>\n        ");var m=(new alert_1.PdVisAlert({text:"可新建更多关系类型，所有该概念下的实体将继承新建的关系类型",type:"warning",selector:this.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-tip"),showIcon:!0,closable:!0}),$.extend(!0,{},{kgName:this.settings.kgName,ajaxSettings:this.settings.ajaxSettings},{selector:this.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-start"),schema:this.settings.schema,autocompleteSettings:{placeholder:"起点",name:"start",onSearch:function(t){e.startData=t,e.getAttributeList().then(function(t){e.setSelectOptions(t),t[0]&&(e.endRange=t[0].range.split(" "))})},onSearchTextChange:function(){e.startData=null}}},this.settings.startPromptSettings));this.startPrompt=new prompt_1.PdSDKPrompt(m);var u=$.extend(!0,{},{kgName:this.settings.kgName,ajaxSettings:this.settings.ajaxSettings},{selector:this.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-end"),schema:this.settings.schema,dynamicSettings:function(t){return $.extend(!0,{},t,{queryData:{allowTypes:e.endRange}})},autocompleteSettings:{placeholder:"终点",name:"end",onSearch:function(t){e.endData=t},onSearchTextChange:function(){e.endData=null}}},this.settings.endPromptSettings);this.endPrompt=new prompt_1.PdSDKPrompt(u);var f=m;f.selector=this.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-content-add-self-attr-start"),this.selfStartPrompt=new prompt_1.PdSDKPrompt(f);var h=u;h.selector=this.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-content-add-self-attr-end"),delete h.dynamicSettings,this.selfEndPrompt=new prompt_1.PdSDKPrompt(h);var D=this.editDialog.$el.find(".pdsdk-editor-add-relation-define-range-prompt"),v=$.extend(!0,{},{kgName:this.settings.kgName,autocompleteSettings:{placeholder:"值域"},promptType:"100",ajaxSettings:this.settings.ajaxSettings},this.settings.addRelationRangePromptSettings);this.addRelationRangePromptTag=new tag_prompt_1.PdSDKTagPrompt({size:"sm",data:[],labelKey:"name",valueKey:"id",selector:D,beforeAdd:function(t){return Promise.resolve(t)},beforeDelete:function(t){return Promise.resolve(t)},promptSettings:v}),this.editDialog.$el.find(".pdui-modal-head .pdui-modal-title").after(d),this.bindDialogEvent()},e.prototype.onClick=function(t){var e=this;this.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-content-normal").removeClass("hide").siblings().addClass("hide"),this.showEdit({},t),this.setInputValue(),this.startData&&this.getAttributeList().then(function(t){if(e.attsData=t,e.setSelectOptions(t),e.endData&&t.length)for(var a=0,d=t;a<d.length;a++){var i=d[a];if(i.range.indexOf(e.endData.classId)>=0)return e.endRange=i.range.split(" "),void form_1.PdUIForm.setFormData(e.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-select"),{attDefId:i.id})}else t&&t[0]&&(e.endRange=t[0].range.split(" "))}),this.addEvent("updateAtts",function(t){var a=e.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-select");a.find("select").append('<option value="'+t.attr.k+'">'+t.attr.v+"</option>"),form_1.PdUIForm.setFormData(a,{attDefId:t.attr.k})},this.settings.sdkNetChart.editor.tools.defineRelation)},e.prototype.setInputValue=function(){var t={start:this.startData&&this.startData.name?this.startData.name:"",end:this.endData&&this.endData.name?this.endData.name:""};form_1.PdUIForm.setFormData(this.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-content-normal"),t)},e.prototype.setSelectOptions=function(t){for(var e="",a=0,d=t;a<d.length;a++){var i=d[a];e+='<option value="'+i.id+'">'+i.name+"</option>"}this.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-select select").html(e)},e.prototype.unbindEvent=function(){t.prototype.unbindEvent.call(this),this.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-switch").off("click"),this.editDialog.$el.find(".pdsdk-editor-add-relation-dialog-select").off("change"),this.editDialog.$el.find(".pdsdk-editor-add-relation-add-define-public").off("click"),this.editDialog.$el.find(".pdsdk-editor-add-relation-add-define-self").off("click")},e.defaultPromptSettings={promptType:"010",autocompleteSettings:{size:"sm",theme:"normal"},ajaxSettings:{queryData:{isInherit:!0}}},e.defaultSettings={cls:["pd-btn-float","pdsdk-editor-button-border"],name:"addRelation",title:"新增关系",disabled:!1,visible:!0,icon:add_circle_1["default"](20),startPromptSettings:e.defaultPromptSettings,endPromptSettings:e.defaultPromptSettings},e.editFormSettings=[],e}(editor_tool_1.PdSDKEditorTool);exports.PdSDKEditorAddRelation=PdSDKEditorAddRelation;