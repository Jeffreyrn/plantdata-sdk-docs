"use strict";var __extends=this&&this.__extends||function(){var t=function(e,a){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])})(e,a)};return function(e,a){function i(){this.constructor=e}t(e,a),e.prototype=null===a?Object.create(a):(i.prototype=a.prototype,new i)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),common_1=require("../../../../common/common"),editor_tool_1=require("./editor-tool"),edit_item_1=require("../../../../vis/utils/edit-item/edit-item"),utils_1=require("../../../utils/utils"),inbox_1=require("../../../../icon/inbox"),mode_edit_1=require("../../../../icon/mode-edit"),delete_1=require("../../../../icon/delete"),PdSDKEditorEditInstanceAttr=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.destroy=function(){t.prototype.destroy.call(this)},e.prototype.updateStatusBySelection=function(t,e,a){if(1===t.length&&0===e.length){var i=t[0];0===i.type?(this.updateStatus(!1),this.updateVisibility(!1)):1===i.type&&(this.data=i,this.updateStatus(!0),this.updateVisibility(!0))}else this.updateStatus(!1),this.updateVisibility(!1)},e.prototype.addAttr=function(t,e){var a=this.settings.ajaxSettings,i=a.queryData||{},n=a.formData||{};i.kgName=this.settings.kgName,n.instanceId=this.data.id,n.attDefId=t.attDefId,n.attName=$.trim(t.name),n.dataValue=$.trim(e),n.attType="0";var d={url:a.baseUrl+"attribute/add/attribute",type:"POST",data:n};return d=$.extend(!0,{},d,a,this.settings.addAttrSettings),d.url=utils_1.PdSDKUtils.buildUrl(d.url,i),utils_1.PdSDKUtils.ajax(d)},e.prototype.bindDialogEvent=function(){var t=this;this.editDialog.$el.on("blur",".pdsdk-editor-change",function(e){if("1"===$(e.currentTarget).attr("data-type")){var a=$(e.currentTarget).val(),i=$(e.currentTarget).attr("name");t.updateScore(a,i).then(function(){common_1.PdCommonUtils.success("修改成功"),$(e.currentTarget).removeClass("pdsdk-editor-change")})}else if($(e.currentTarget).closest(".pdvis-edit-item-single").hasClass("new")){if("name"===$(e.currentTarget).attr("type")){var n={name:$(e.currentTarget).val(),attDefId:0},a=$(e.currentTarget).closest(".pdvis-edit-item-single").find(".pdsdk-editor-instance-edit-attr-item-value").val();t.addAttr(n,a).then(function(a){n.dataValueTripleId=a,t.attsData.push(n),$(e.currentTarget).closest(".pdvis-edit-item-single").find("input").attr("placeholder",$(e.currentTarget).val()),common_1.PdCommonUtils.success("私有属性添加成功"),$(e.currentTarget).closest(".pdvis-edit-item-single").removeClass("new"),$(e.currentTarget).closest(".pdvis-edit-item-single").find("input").removeClass("pdsdk-editor-change")})}}else{var d=$(e.currentTarget).attr("placeholder"),s=d;if("name"===$(e.currentTarget).attr("type")&&(d=$(e.currentTarget).val(),$(e.currentTarget).closest(".pdvis-edit-item-single").find("input").attr("placeholder",d)),d){var r=$(e.currentTarget).attr("name"),l=$(e.currentTarget).closest(".pdvis-edit-item-single"),o=l.find("input").eq(-1).val();"51"===$(e.currentTarget).attr("data-type")&&(o={name:l.find("input").eq(-2).val(),href:l.find("input").eq(-1).val()});for(var p=null,u=0,c=0;c<t.attsData.length;c++)t.attsData[c].attDefId.toString()!==r.toString()||t.attsData[c].name!==s&&"51"!==$(e.currentTarget).attr("data-type")||(p=t.attsData[c],d=t.attsData[c].name,u=c);p.name=d,p.dataValueTripleId?t.deleteAttr(p).then(function(a){o?t.addAttr(p,o).then(function(a){t.attsData[u].dataValueTripleId=a,common_1.PdCommonUtils.success("修改成功"),$(e.currentTarget).removeClass("pdsdk-editor-change")}):(common_1.PdCommonUtils.success("删除成功"),$(e.currentTarget).removeClass("pdsdk-editor-change"))}):o&&t.addAttr(p,o).then(function(e){t.attsData[u].dataValueTripleId=e,common_1.PdCommonUtils.success("修改成功")})}else common_1.PdCommonUtils.error("属性名必填")}}).on("change","input",function(t){$(t.currentTarget).addClass("pdsdk-editor-change")}).on("click",".pdsdk-editor-instance-edit-attr-item-delete",function(e){for(var a,i,n=$(e.currentTarget).closest(".pdvis-edit-item-single").find(".pdsdk-editor-instance-edit-attr-item-name").val(),d=0;d<t.attsData.length;d++)t.attsData[d].name===n&&(a=t.attsData[d],i=d);a&&a.dataValueTripleId?t.deleteAttr(a).then(function(a){t.attsData.splice(i,1),$(e.currentTarget).closest(".pdvis-edit-item-single").remove()}):$(e.currentTarget).closest(".pdvis-edit-item-single").remove()}).on("click",".pdsdk-editor-instance-edit-attr-add-self-attr-btn",function(t){var e=delete_1["default"](18,{"class":"pdsdk-editor-instance-edit-attr-item-delete"}),a='<div class="pdvis-edit-item  pdvis-edit-item-single clearfix new" data-path="0">\n                        <input class=" pdui-input pdui-input-sm pdsdk-editor-instance-edit-attr-item-name"\n                         placeholder="" value="" name="0" autocomplete="off" type="name">:\n                        <input class=" pdui-input pdui-input-sm pdsdk-editor-instance-edit-attr-item-value"\n                         placeholder="" value="" name="0" autocomplete="off">\n                         '+e+"\n                    </div>";$(t.currentTarget).before(a)}).on("click",".pdsdk-editor-instance-edit-attr-no-data-add",function(e){var a=delete_1["default"](18,{"class":"pdsdk-editor-instance-edit-attr-item-delete"}),i='<div class="pdvis-edit-item  pdvis-edit-item-single clearfix new" data-path="0">\n                        <input class=" pdui-input pdui-input-sm pdsdk-editor-instance-edit-attr-item-name"\n                         placeholder="" value="" name="0" autocomplete="off" type="name">:\n                        <input class=" pdui-input pdui-input-sm pdsdk-editor-instance-edit-attr-item-value"\n                         placeholder="" value="" name="0" autocomplete="off">\n                         '+a+"\n                    </div>";i+='<div class="pdsdk-editor-instance-edit-attr-add-self-attr-btn">添加私有属性</div>',t.editDialog.$el.find(".pdui-modal-body").empty().append(i)})},e.prototype.createEditDialogSettings=function(){var t='<div class=""></div>';return{cls:"pdsdk-editor-instance-edit-attr-dialog",title:'实体"<span class="pdsdk-editor-instance-edit-attr-name"></span>"属性编辑',body:t,positiveClick:function(){return Promise.resolve({})}}},e.prototype.deleteAttr=function(t){var e=this.settings.ajaxSettings,a=e.queryData||{},i=e.formData||{};a.kgName=this.settings.kgName,i.instanceId=this.data.id,i.attDefId=t.attDefId,i.attId=t.dataValueTripleId,i.attType="0";var n={url:e.baseUrl+"attribute/delete/attribute",type:"POST",data:i};return n=$.extend(!0,{},n,e,this.settings.deleteAttrSettings),n.url=utils_1.PdSDKUtils.buildUrl(n.url,a),utils_1.PdSDKUtils.ajax(n)},e.prototype.getInstance=function(){var t=this.settings.ajaxSettings,e=t.queryData||{};e.kgName=this.settings.kgName,e.instanceId=this.data.id;var a={url:t.baseUrl+"instance/get",type:"GET"};return a=$.extend(!0,{},a,t,this.settings.getInstanceSettings),a.url=utils_1.PdSDKUtils.buildUrl(a.url,e),utils_1.PdSDKUtils.ajax(a)},e.prototype.initSettings=function(a){var i=$.extend(!0,{},e.defaultSettings);return $.extend(!0,{},t.prototype.initSettings.call(this,i),a)},e.prototype.mounted=function(){t.prototype.mounted.call(this),this.bindDialogEvent()},e.prototype.onClick=function(t){var e=this;this.editDialog.$el.find(".pdsdk-editor-instance-edit-attr-name").text(this.data.name),this.getInstance().then(function(t){t.atts||(t.atts=[]);var a='\n<div class="pdvis-edit-item pdvis-edit-item-single clearfix" data-path="source">\n    <label title="来源">\n        <span class="pdvis-edit-item-label">来源</span>:\n    </label>\n    <input class="pdui-input pdui-input-sm" placeholder="请输入来源"\n     value="'+(t.source||"")+'" data-type="1"  name="source" autocomplete="off">\n</div>\n<div class="pdvis-edit-item pdvis-edit-item-single clearfix" data-path="reliability">\n    <label title="置信度">\n        <span class="pdvis-edit-item-label">置信度</span>:\n    </label>\n    <input class="pdui-input pdui-input-sm" type="number" min="0" max="1" step="0.1" placeholder="请输入置信度"\n     value="'+(t.reliability||"")+'" data-type="1" name="reliability" autocomplete="off">\n</div>\n<div class="pdvis-edit-item pdvis-edit-item-single clearfix" data-path="score">\n    <label title="权重">\n        <span class="pdvis-edit-item-label">权重</span>:\n    </label>\n    <input class="pdui-input pdui-input-sm" type="number" min="0" max="1" step="0.1" placeholder="请输入权重"\n     value="'+(t.score||"")+'" data-type="1" name="score" autocomplete="off">\n</div>';e.attsData=[];for(var i=[],n=0,d=t.atts;n<d.length;n++){var s=d[n];if(0===s.type)if(s.attDefId)if(e.attsData.push(s),51===s.dataType){if(s.dataValue){var r=s.dataValue;s.dataName=r.name,s.dataHref=r.href}else s.dataName="",s.dataHref="";a+='\n<div class="pdvis-edit-item pdvis-edit-item-half pdvis-edit-item-single clearfix" data-path="'+s.attDefId+'">\n<label title="'+s.name+'">\n    <span class="pdvis-edit-item-label">'+s.name+'</span>:\n</label>\n<input class="pdui-input pdui-input-sm" data-type="'+s.dataType+'" placeholder="请输入超链接名称"\n value="'+s.dataName+'" name="'+s.attDefId+'" autocomplete="off">\n<input class="pdui-input pdui-input-sm" data-type="'+s.dataType+'" placeholder="请输入超链接地址"\n value="'+s.dataHref+'" name="'+s.attDefId+'" autocomplete="off">\n</div>'}else a+=edit_item_1.PdVisEditItem.gentEditItem({type:"input",key:s.attDefId,label:s.name,value:s.dataValue,mode:"label",postfix:s.dataUnit});else i.push(s)}if(e.attsData=e.attsData.concat(i),i&&i.length)for(var l=delete_1["default"](18,{"class":"pdsdk-editor-instance-edit-attr-item-delete"}),o=0,p=i;o<p.length;o++){var s=p[o];a+='<div class="pdvis-edit-item  pdvis-edit-item-single clearfix" data-path="0">\n                        <input class=" pdui-input pdui-input-sm pdsdk-editor-instance-edit-attr-item-name"\n                         placeholder="'+s.name+'" value="'+s.name+'" name="'+s.attDefId+'" autocomplete="off" type="name">:\n                        <input class=" pdui-input pdui-input-sm pdsdk-editor-instance-edit-attr-item-value"\n                         placeholder="'+s.name+'" value="'+s.dataValue+'" name="'+s.attDefId+'" autocomplete="off">\n                         '+l+"\n                    </div>"}if(a)a+='<div class="pdsdk-editor-instance-edit-attr-add-self-attr-btn">添加私有属性</div>';else{var u=inbox_1["default"](40);a='<div class="pdsdk-editor-instance-edit-attr-no-data">\n                                    <div class="pdsdk-editor-instance-edit-attr-no-data-content">'+u+'<br/>\n                                    <div class="pdsdk-editor-instance-edit-attr-no-data-add">暂无数据,<span>点击添加私有属性</span></div>\n                                </div></div>'}e.editDialog.$body.html(a)}),this.showEdit({parent:this.data?this.data.name:""},t)},e.prototype.validate=function(e){var a=!0;return this.editDialog&&(a=t.prototype.validate.call(this,e)),a},e.prototype.unbindEvent=function(){t.prototype.unbindEvent.call(this),this.editDialog.$el.off("blur","input").off("change","input").off("click",".pdsdk-editor-instance-edit-attr-item-delete").off("click",".pdsdk-editor-instance-edit-attr-add-self-attr-btn").off("click",".pdsdk-editor-instance-edit-attr-no-data-add")},e.prototype.updateScore=function(t,e){if(parseFloat(t)>1||parseFloat(t)<0){if("reliability"===e)return common_1.PdCommonUtils.error("置信度值域为0~1"),Promise.reject(new Error("置信度值域为0~1"));if("score"===e)return common_1.PdCommonUtils.error("权重值域为0~1"),Promise.reject(new Error("权重值域为0~1"))}var a=this.settings.ajaxSettings,i=a.queryData||{},n=a.formData||{};i.kgName=this.settings.kgName,n.instanceId=this.data.id,n[e]=$.trim(t)||"";var d={url:a.baseUrl+"instance/update/score",type:"POST",data:n};return d=$.extend(!0,{},d,a,this.settings.addAttrSettings),d.url=utils_1.PdSDKUtils.buildUrl(d.url,i),utils_1.PdSDKUtils.ajax(d)},e.defaultSettings={cls:["pd-btn-float","pdsdk-editor-button-border"],name:"editInstanceAttr",title:"属性编辑",disabled:!0,visible:!1,icon:mode_edit_1["default"](20)},e}(editor_tool_1.PdSDKEditorTool);exports.PdSDKEditorEditInstanceAttr=PdSDKEditorEditInstanceAttr;