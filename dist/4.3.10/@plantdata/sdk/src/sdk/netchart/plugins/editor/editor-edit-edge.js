"use strict";var __extends=this&&this.__extends||function(){var t=function(e,a){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])})(e,a)};return function(e,a){function i(){this.constructor=e}t(e,a),e.prototype=null===a?Object.create(a):(i.prototype=a.prototype,new i)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),common_1=require("../../../../common/common"),editor_tool_1=require("./editor-tool"),edit_item_1=require("../../../../vis/utils/edit-item/edit-item"),utils_1=require("../../../utils/utils"),tag_prompt_1=require("../../../utils/tag-prompt/tag-prompt"),form_1=require("../../../../ui/components/form/form"),mode_edit_1=require("../../../../icon/mode-edit"),PdSDKEditorEditEdge=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.transformTime=function(t){if(t){var e=new Date(t),a=e.getFullYear();if(!a)return common_1.PdCommonUtils.error("格式错误"),"0";var i=e.getMonth()+1;i=i<10?"0"+i:i;var n=e.getDate();return n=n<10?"0"+n:n,a+"-"+i+"-"+n}return""},e.prototype.destroy=function(){t.prototype.destroy.call(this)},e.prototype.updateStatusBySelection=function(t,e,a){if(0===t.length&&1===e.length){a=this.settings.netChart.getData();var i=lodash_1.find(a.nodes,function(t){return t.id.toString()===e[0].from.toString()}),n=lodash_1.find(a.nodes,function(t){return t.id.toString()===e[0].to.toString()});"1"===i.type.toString()&&"1"===n.type.toString()&&"0"!==e[0].attId.toString()?(this.data=e[0],this.updateStatus(!0),this.updateVisibility(!0)):(this.updateStatus(!1),this.updateVisibility(!1))}else this.updateStatus(!1),this.updateVisibility(!1)},e.prototype.addEdge=function(t){var e=this.settings.ajaxSettings,a=e.queryData||{},i=e.formData||{};a.kgName=this.settings.kgName,i.tripleId=this.data.id,i.attDefId=this.data.attId,i=$.extend(!0,{},i,t);var n={url:e.baseUrl+"attribute/add/edge",type:"POST",data:i};return n=$.extend(!0,{},n,e,this.settings.addEdgeSettings),n.url=utils_1.PdSDKUtils.buildUrl(n.url,a),utils_1.PdSDKUtils.ajax(n)},e.prototype.bindDialogEvent=function(){var t=this;this.editDialog.$el.on("blur",".pdsdk-editor-change",function(a){if($(a.currentTarget).hasClass("time")){var i=form_1.PdUIForm.getFormData(t.editDialog.$el);if(i.attrTimeTo=e.transformTime(i.attrTimeTo),i.attrTimeFrom=e.transformTime(i.attrTimeFrom),"0"===i.attrTimeTo||"0"===i.attrTimeFrom)return;return t.addEdge({attrTimeFrom:i.attrTimeFrom,attrTimeTo:i.attrTimeTo}).then(function(){if($(a.currentTarget).removeClass("pdsdk-editor-change"),form_1.PdUIForm.setFormData(t.editDialog.$el,{attrTimeFrom:i.attrTimeFrom,attrTimeTo:i.attrTimeTo}),t.data.nRInfo&&t.data.nRInfo.length){for(var e=null,n=0;n<t.data.nRInfo[0].ks.length;n++)"开始时间"===t.data.nRInfo[0].ks[n]&&(e=n);e||0===e?t.data.nRInfo[0].kvs[e].v=i.attrTimeFrom:(t.data.nRInfo[0].ks.push("开始时间"),t.data.nRInfo[0].kvs.push({k:"开始时间",v:i.attrTimeFrom})),e=null;for(var n=0;n<t.data.nRInfo[0].ks.length;n++)"结束时间"===t.data.nRInfo[0].ks[n]&&(e=n);e?t.data.nRInfo[0].kvs[e].v=i.attrTimeTo:(t.data.nRInfo[0].ks.push("结束时间"),t.data.nRInfo[0].kvs.push({k:"结束时间",v:i.attrTimeTo}))}else t.data.nRInfo=[{id:t.data.id,ks:["开始时间","结束时间"],kvs:[{k:"开始时间",v:i.attrTimeFrom},{k:"结束时间",v:i.attrTimeTo}]}];common_1.PdCommonUtils.success("修改成功")})}if(!$(a.currentTarget).hasClass("pdui-autofill-input")){if(!($(a.currentTarget).hasClass("score")||$(a.currentTarget).hasClass("reliability")||$(a.currentTarget).hasClass("source")||$(a.currentTarget).hasClass("displayName"))){var n={},r=$(a.currentTarget).val();return n[$(a.currentTarget).attr("name")]=$(a.currentTarget).val(),t.addEdge({relationDataValue:n}).then(function(){var e=$(a.currentTarget).siblings("label").attr("title");if(t.data.nRInfo&&t.data.nRInfo.length){for(var i=null,n=0;n<t.data.nRInfo[0].ks.length;n++)t.data.nRInfo[0].ks[n]===e&&(i=n);i||0===i?t.data.nRInfo[0].kvs[i].v=r:(t.data.nRInfo[0].ks.push(e),t.data.nRInfo[0].kvs.push({k:e,v:r}))}else t.data.nRInfo=[{id:t.data.id,ks:[e],kvs:[{k:e,v:r}]}];common_1.PdCommonUtils.success("修改成功"),$(a.currentTarget).removeClass("pdsdk-editor-change")})}t.updateAttribute().then(function(){$(a.currentTarget).removeClass("pdsdk-editor-change"),common_1.PdCommonUtils.success("修改成功")})}}).on("change","input",function(t){$(t.currentTarget).addClass("pdsdk-editor-change")})},e.prototype.createEditDialogSettings=function(){var t='<div class=""></div>';return{cls:"pdsdk-editor-edge-dialog",title:'"<span class="pdsdk-editor-edge-name"></span>"边属性编辑',body:t,positiveClick:function(){return Promise.resolve({})}}},e.prototype.deleteEdge=function(t){var e=this.settings.ajaxSettings,a=e.queryData||{},i=e.formData||{};a.kgName=this.settings.kgName,i.tripleId=this.data.id,i.attDefId=this.data.attId,i=$.extend(!0,{},i,t);var n={url:e.baseUrl+"attribute/delete/edge",type:"POST",data:i};return n=$.extend(!0,{},n,e,this.settings.deleteEdgeSettings),n.url=utils_1.PdSDKUtils.buildUrl(n.url,a),utils_1.PdSDKUtils.ajax(n)},e.prototype.getDefinition=function(){var t=this.settings.ajaxSettings,e=t.queryData||{};e.kgName=this.settings.kgName,e.id=this.data.from,e.type="1";var a={url:t.baseUrl+"attribute/get/definition",type:"GET"};return a=$.extend(!0,{},a,t,this.settings.getDefinitionSettings),a.url=utils_1.PdSDKUtils.buildUrl(a.url,e),utils_1.PdSDKUtils.ajax(a)},e.prototype.getInstance=function(){var t=this.settings.ajaxSettings,e=t.queryData||{};e.kgName=this.settings.kgName,e.instanceId=this.data.from;var a={url:t.baseUrl+"instance/get",type:"GET"};return a=$.extend(!0,{},a,t,this.settings.getInstanceSettings),a.url=utils_1.PdSDKUtils.buildUrl(a.url,e),utils_1.PdSDKUtils.ajax(a)},e.prototype.initSettings=function(a){var i=$.extend(!0,{},e.defaultSettings);return i.instancePromptSettings.ajaxSettings=$.extend(!0,{},a.ajaxSettings,i.instancePromptSettings.ajaxSettings),$.extend(!0,{},t.prototype.initSettings.call(this,i),a)},e.prototype.mounted=function(){t.prototype.mounted.call(this),this.bindDialogEvent()},e.prototype.onClick=function(t){var e=this;if(this.editDialog.$el.find(".pdsdk-editor-edge-name").text(this.data.attName),this.promptList&&this.promptList.length)for(var a=0,i=this.promptList;a<i.length;a++){var n=i[a];n.destroy()}this.promptList=[],Promise.all([this.getInstance(),this.getDefinition()]).then(function(t){var a=lodash_1.find(t[1].rsData,function(t){return t.id.toString()===e.data.attId.toString()}),i=t[0],n=lodash_1.find(i.atts,function(t){return t.attDefId.toString()===e.data.attId.toString()});e.editDialog.$body.html('\n            <div class="pdvis-edit-item  pdvis-edit-item-single clearfix" data-path="4">\n                <label title="起止时间（时序）">\n                    <span class="pdvis-edit-item-label">起止时间（时序）</span>:\n                </label>\n                <input class=" pdui-input pdui-input-sm time" name="attrTimeFrom" placeholder="2018-09-03"\n                 autocomplete="off">\n                <span class="attr-time">-</span>\n                <input class=" pdui-input pdui-input-sm time" name="attrTimeTo" placeholder="2018-09-03"\n                 autocomplete="off">\n             </div>\n            <div class="pdvis-edit-item  pdvis-edit-item-single clearfix" data-path="source">\n                <label title="来源">\n                    <span class="pdvis-edit-item-label">来源</span>:\n                </label>\n                <input class=" pdui-input pdui-input-sm source" name="source" placeholder="请输入来源"\n                 autocomplete="off">\n              </div>\n             <div class="pdvis-edit-item  pdvis-edit-item-single clearfix" data-path="reliability">\n                <label title="置信度">\n                    <span class="pdvis-edit-item-label">置信度</span>:\n                </label>\n                <input class=" pdui-input pdui-input-sm reliability" name="reliability" placeholder="请输入置信度"\n                 autocomplete="off" type="number" min="0" max="1" step="0.1">\n              </div>\n             <div class="pdvis-edit-item  pdvis-edit-item-single clearfix" data-path="score">\n                <label title="权重">\n                    <span class="pdvis-edit-item-label">权重</span>:\n                </label>\n                <input class=" pdui-input pdui-input-sm score" name="score" placeholder="请输入权重"\n                 autocomplete="off" type="number" min="0" max="1" step="0.1">\n              </div>\n             <!--<div class="pdvis-edit-item  pdvis-edit-item-single clearfix" data-path="displayName">-->\n                <!--<label title="展示名">-->\n                    <!--<span class="pdvis-edit-item-label">展示名</span>:-->\n                <!--</label>-->\n                <!--<input class=" pdui-input pdui-input-sm displayName" name="displayName" placeholder="请输入展示名"-->\n                 <!--autocomplete="off">-->\n              <!--</div>-->');var r=lodash_1.find(n.objectValues,function(t){return t.id.toString()===e.data.to.toString()});r.relationDataValue||(r.relationDataValue={}),a.extraInfoList||(a.extraInfoList=[]);for(var o=function(t){if(0===t.type)e.editDialog.$body.append(edit_item_1.PdVisEditItem.gentEditItem({type:"input",key:t.seqNo,label:t.name,mode:"label",postfix:t.dataUnit}));else{r.relationDataValue||(r.relationDataValue={}),r.relationObjectValues||(r.relationObjectValues=[]),e.editDialog.$body.append(edit_item_1.PdVisEditItem.gentEditItem({type:"custom",key:t.seqNo,label:t.name,mode:"label",postfix:t.dataUnit,html:'<div class="pdsdk-editor-edge-prompt"></div>'}));var a=e.editDialog.$el.find(".pdsdk-editor-edge-prompt").eq(-1),i=$.extend(!0,{},{kgName:e.settings.kgName,autocompleteSettings:{placeholder:t.name},ajaxSettings:e.settings.ajaxSettings,dynamicSettings:function(e){return $.extend(!0,{},e,{queryData:{allowTypes:t.objRange?t.objRange.split(" "):[]}})}},e.settings.instancePromptSettings);e.promptList.push(new tag_prompt_1.PdSDKTagPrompt({size:"sm",data:r.relationObjectValues[t.seqNo]||[],labelKey:"name",valueKey:"id",selector:a,beforeAdd:function(t,a){var i=lodash_1.cloneDeep(a.getData());i.push(t);var n={};return n[$(a.$el).closest(".pdvis-edit-item").attr("data-path")]=lodash_1.map(i,"id"),e.addEdge({relationObjValIds:n}).then(function(n){var r=a.$el.siblings("label").attr("title");if(e.data.oRInfo&&e.data.oRInfo.length){for(var o=null,s=0;s<e.data.oRInfo.length;s++)e.data.oRInfo[s].ks[0]===r&&(o=s);o||0===o?(e.data.oRInfo[o].ks=lodash_1.fill(Array(i.length),r),e.data.oRInfo[o].kvs=lodash_1.map(i,function(t){return{k:r,v:t.name}})):e.data.oRInfo.push({id:e.data.id,ks:lodash_1.fill(Array(i.length),r),kvs:lodash_1.map(i,function(t){return{k:r,v:t.name}})})}else e.data.oRInfo=[{id:e.data.id,ks:lodash_1.fill(Array(i.length),r),kvs:lodash_1.map(i,function(t){return{k:r,v:t.name}})}];return common_1.PdCommonUtils.success("修改成功"),Promise.resolve(t)})},beforeDelete:function(t,a){var i=lodash_1.cloneDeep(a.getData());return lodash_1.remove(i,function(e){return e.id.toString()===t.id.toString()}),e.deleteEdge({relationAttDefId:$(a.$el).closest(".pdvis-edit-item").attr("data-path"),relationObjValId:t.id}).then(function(n){for(var r=a.$el.siblings("label").attr("title"),o=null,s=0;s<e.data.oRInfo.length;s++)e.data.oRInfo[s].ks[0]===r&&(o=s);return o||0===o?(e.data.oRInfo[o].ks=lodash_1.fill(Array(i.length),r),e.data.oRInfo[o].kvs=lodash_1.map(i,function(t){return{k:r,v:t.name}})):e.data.oRInfo.push({id:e.data.id,ks:lodash_1.fill(Array(i.length),r),kvs:lodash_1.map(i,function(t){return{k:r,v:t.name}})}),common_1.PdCommonUtils.success("修改成功"),Promise.resolve(t)})},promptSettings:i}))}},s=0,d=a.extraInfoList;s<d.length;s++){var l=d[s];o(l)}r.relationDataValue.attrTimeFrom=r.attrTimeFrom,r.relationDataValue.attrTimeTo=r.attrTimeTo,r.relationDataValue.score=r.score,r.relationDataValue.reliability=r.reliability,r.relationDataValue.source=r.source,form_1.PdUIForm.setFormData(e.editDialog.$el,r.relationDataValue)}),this.showEdit({},t)},e.prototype.validate=function(e){var a=!0;return this.editDialog&&(a=t.prototype.validate.call(this,e)),a},e.prototype.unbindEvent=function(){t.prototype.unbindEvent.call(this),this.editDialog.$el.off("blur","input")},e.prototype.updateAttribute=function(){var t=$.trim(this.editDialog.$el.find("input.score").val()),e=$.trim(this.editDialog.$el.find("input.reliability").val()),a=$.trim(this.editDialog.$el.find("input.source").val());if(parseFloat(e)>1||parseFloat(e)<0)return common_1.PdCommonUtils.error("置信度值域为0~1"),Promise.reject(new Error("置信度值域为0~1"));if(parseFloat(t)>1||parseFloat(t)<0)return common_1.PdCommonUtils.error("权重值域为0~1"),Promise.reject(new Error("权重值域为0~1"));var i=this.settings.ajaxSettings,n=i.queryData||{},r=i.formData||{};n.kgName=this.settings.kgName,r.attId=this.data.id,r.score=t,r.reliability=e,r.source=a;var o={url:i.baseUrl+"attribute/update/attribute",type:"POST",data:r};return o=$.extend(!0,{},o,i,this.settings.addAttrSettings),o.url=utils_1.PdSDKUtils.buildUrl(o.url,n),utils_1.PdSDKUtils.ajax(o)},e.defaultPromptSettings={promptType:"010"},e.defaultSettings={cls:["pd-btn-float","pdsdk-editor-button-border"],name:"editEdge",title:"属性编辑",disabled:!0,visible:!1,icon:mode_edit_1["default"](20),instancePromptSettings:e.defaultPromptSettings},e}(editor_tool_1.PdSDKEditorTool);exports.PdSDKEditorEditEdge=PdSDKEditorEditEdge;