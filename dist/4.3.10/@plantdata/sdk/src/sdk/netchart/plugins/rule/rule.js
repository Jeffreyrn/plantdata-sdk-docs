"use strict";var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),common_1=require("../../../../common/common"),edit_1=require("../../../../vis/netchart/plugins/edit/edit"),utils_1=require("../../../utils/utils"),edit_item_1=require("../../../../vis/utils/edit-item/edit-item"),index_1=require("../../../../ui/components/checkbox/index"),confirm_1=require("../../../../vis/utils/modal/confirm/confirm"),dialog_1=require("../../../../vis/utils/modal/dialog/dialog"),index_2=require("../../../../ui/components/form/index"),add_1=require("../../../../icon/add"),google_circles_exten_1=require("../../../../icon/google-circles-exten"),PdSDKPluginRule=function(e){function t(t){var i=e.call(this,t)||this;return i.isValidate=!0,i}return __extends(t,e),t.prototype.clearValidate=function(){for(var e=0,t=this.settings.editItemSettings;e<t.length;e++)for(var i=t[e],r=i.children,a=0,n=r;a<n.length;a++){var d=n[a],s=i.key+"."+d.key,l=this.select('.pdvis-edit-item[data-path="'+s+'"]');edit_item_1.PdVisEditItem.clearEditItemStatus(l)}},t.prototype.getPluginType=function(){return"rule"},t.prototype.getSelectedData=function(){for(var t=e.prototype.getData.call(this),i={},r=0,a=this.settings.editItemSettings;r<a.length;r++){var n=a[r];t["ruleEnable-"+n.key].length&&(i[n.key]=t[n.key])}return i},t.prototype.add=function(e){var t=$.extend(!0,{ajaxSettings:this.settings.ajaxSettings,kgName:this.settings.kgName},this.settings.addSettings),i=t.ajaxSettings,r=i.queryData||{};r.kgName=t.kgName;var a=i.formData||{};a.bean=JSON.stringify(e);var n={url:i.baseUrl+"rule/add",type:"POST",el:this.container.$el[0],data:a};return n=$.extend(!0,{},n,i),n.url=utils_1.PdSDKUtils.buildUrl(n.url,r),this.executeLoad(n)},t.prototype["delete"]=function(e){var t=$.extend(!0,{ajaxSettings:this.settings.ajaxSettings,kgName:this.settings.kgName},this.settings.deleteSettings),i=t.ajaxSettings,r=i.queryData||{};r.kgName=t.kgName,r.id=e;var a={url:i.baseUrl+"rule/delete",type:"POST",el:this.container.$el[0]};return a=$.extend(!0,{},a,i),a.url=utils_1.PdSDKUtils.buildUrl(a.url,r),utils_1.PdSDKUtils.ajax(a)},t.prototype.list=function(e){var t=this;void 0===e&&(e=1);var i=$.extend(!0,{ajaxSettings:this.settings.ajaxSettings,kgName:this.settings.kgName},this.settings.listSettings),r=i.ajaxSettings,a=r.queryData||{};a.pageNo=e,a.pageSize=10,a.kgName=i.kgName;var n={url:r.baseUrl+"rule/get/list",type:"GET",el:this.container.$el[0]};return n=$.extend(!0,{},n,r),n.url=utils_1.PdSDKUtils.buildUrl(n.url,a),utils_1.PdSDKUtils.ajax(n).then(function(e){if(n.success)return e;t.ruleList=e.rsData;for(var i=[],r=0,a=t.ruleList;r<a.length;r++){var d=a[r],s=[];try{s=JSON.parse(d.ruleSettings)}catch(l){s=common_1.PdCommonUtils.eval(d.ruleSettings)}i.push({key:d.ruleId.toString(),label:d.ruleName,children:s,type:"group"})}return t.settings.editItemSettings=i,t.updateRule(),e})},t.prototype.validate=function(){var e=!0,t=this.getSelectedData();for(var i in t)if(t.hasOwnProperty(i)){var r=lodash_1.find(this.settings.editItemSettings,["key",i]);if(r)for(var a=r.children,n=0,d=a;n<d.length;n++){var s=d[n];if(s.required){var l=!!t[i][s.key];switch(l||(e=!1),s.type){case"input":case"date":case"datetime":case"dateRange":case"datetimeRange":var o=i+"."+s.key,u=this.select('.pdvis-edit-item[data-path="'+o+'"]');edit_item_1.PdVisEditItem.updateEditItemStatus(u,l)}}}}return this.isValidate=e,e},t.prototype.update=function(e,t){var i=$.extend(!0,{ajaxSettings:this.settings.ajaxSettings,kgName:this.settings.kgName},this.settings.editSettings),r=i.ajaxSettings,a=r.queryData||{};a.kgName=i.kgName;var n=r.formData||{};n.id=e,n.bean=JSON.stringify(t);var d={url:r.baseUrl+"rule/update",type:"POST",el:this.container.$el[0],data:n};return d=$.extend(!0,{},d,r),d.url=utils_1.PdSDKUtils.buildUrl(d.url,a),this.executeLoad(d)},t.prototype.addRuleField=function(){for(var e=[{label:"字段",key:"key",type:"input",required:!0,mode:"placeholder"},{label:"名称",key:"label",type:"input",required:!0,mode:"placeholder"},{label:"类型",key:"type",type:"select",value:"input",mode:"placeholder",required:!0,options:{date:"日期",dateRange:"日期范围",datetime:"日期时间",datetimeRange:"日期时间范围",input:"文本"}},{label:"默认值",key:"value",type:"input",mode:"placeholder"},{label:"是否必填",key:"required",type:"switch",options:["是","否"]}],t='<tr class="'+index_2.PdUIForm.clsFieldsetName+'" '+index_2.PdUIForm.attrArray+' name="ruleSettings">',i=0,r=e;i<r.length;i++){var a=r[i];t+="<td>"+edit_item_1.PdVisEditItem.gentEditItem(a)+"</td>"}return t+="</tr>"},t.prototype.bindEvent=function(){var t=this;e.prototype.bindEvent.call(this),this.addEvent("beforeload",function(e){return!t.validate()}),this.$el.on("input",".pdvis-edit-item-required.pdvis-edit-item-single input",function(){var e=t.isValidate;if(t.validate(),e!==t.isValidate){var i=t.eventData;i.validate=t.isValidate,i.data=t.getSelectedData(),t.dispatch("validateChange",i)}})},t.prototype.createEditDialogBody=function(){var e={label:"关系名称",key:"ruleName",type:"input",required:!0,mode:"label"},t={label:"关系配置",key:"ruleConfig",type:"textarea",required:!0,mode:"label"},i={label:"关系参数配置",key:"ruleSettings",type:"label",required:!0,mode:"label"},r=edit_item_1.PdVisEditItem.gentEditItem(e);r+=edit_item_1.PdVisEditItem.gentEditItem(t),r+=edit_item_1.PdVisEditItem.gentEditItem(i),r+='<table class="pdui-table" width="100%"><thead><tr><th>字段</th><th>名称</th><th>类型</th><th>默认值</th><th class="center">必填</th></tr></thead><tbody>'+this.addRuleField()+"</tbody></table>";var a=add_1["default"](24);return r+='<div><button class="pdui-btn pdui-btn-primary pdvis-rule-add-new">'+a+"添加规则字段</button></div>"},t.prototype.executeLoad=function(e){var t=this;return utils_1.PdSDKUtils.ajax(e).then(function(i){return e.success?i:void t.list(1)})},t.prototype.getDialogData=function(){var e=index_2.PdUIForm.getFormData(this.editDialog.$el);return e.ruleSettings=JSON.stringify(e.ruleSettings),e},t.prototype.getMainContainer=function(){return this.select(".pdvis-edit-rule-panel")},t.prototype.initSettings=function(i){return $.extend(!0,{},e.prototype.initSettings.call(this,t.defaultSettings),i)},t.prototype.initTemplate=function(){var e="关系推理",t=google_circles_exten_1["default"](20),i='<div class="pdvis-edit-rule-panel"><div class="pdvis-edit-rule-body"></div></div>';return this.buildPluginTemplate(i,t,e)},t.prototype.mounted=function(){e.prototype.mounted.call(this),this.updateRule()},t.prototype.showDialog=function(e,t){var i=this;this.editDialog=new dialog_1.PdVisDialog(t),this.editDialog.$el.on("click",".pdvis-rule-add-new",function(){i.editDialog.$el.find("tbody").append(i.addRuleField())}).on("input",".pdvis-edit-item-required.pdvis-edit-item-single input",function(e){edit_item_1.PdVisEditItem.checkValueItemRequired($(e.currentTarget).closest(".pdvis-edit-item"))}).on("blur",".pdvis-edit-item-required.pdvis-edit-item-single textarea",function(e){edit_item_1.PdVisEditItem.checkValueItemRequired($(e.currentTarget).closest(".pdvis-edit-item"))}),this.editDialog.open({event:e})},t.prototype.showAddDialog=function(e){var t=this,i=$.extend(!0,{cls:"pdvis-rule-editor pdvis-rule-add",body:this.createEditDialogBody(),positiveClick:function(){return t.validateDialog()?t.add(t.getDialogData()):Promise.reject("请将表单填写完整")}},this.settings.add);this.showDialog(e,i)},t.prototype.showDeleteDialog=function(e,t){var i=this;this.deleteDialog=new confirm_1.PdVisConfirm($.extend(!0,{title:"删除确认",body:"确认删除规则吗？",positiveClick:function(){return i["delete"](parseInt(t.key,10)).then(function(){return $(e.currentTarget).closest(".pdvis-edit-item").remove(),Promise.resolve()},function(e){return common_1.PdCommonUtils.error(e),Promise.reject(e)})}},t["delete"])),this.deleteDialog.open({event:e})},t.prototype.showEditDialog=function(e,t){var i=this,r=$.extend(!0,{cls:"pdvis-rule-editor pdvis-rule-edit",body:this.createEditDialogBody(),positiveClick:function(){return i.validateDialog()?i.update(parseInt(t.key,10),i.getDialogData()):Promise.reject("请将表单填写完整")}},t.edit);this.showDialog(e,r);var a=lodash_1.find(this.ruleList,function(e){return e.ruleId.toString()===t.key});a?a.ruleSettings=JSON.parse(a.ruleSettings):a=$.extend(!0,{ruleId:parseInt(t.key,10),ruleName:t.label,ruleSettings:t.children},t.data),index_2.PdUIForm.setFormData(this.editDialog.$el,a)},t.prototype.unbindEvent=function(){e.prototype.unbindEvent.call(this),this.$el.off("input",".pdvis-edit-item-required.pdvis-edit-item-single input")},t.prototype.updateEdit=function(t){if(void 0===t&&(t=[]),e.prototype.updateEdit.call(this,t),t===this.settings.editItemSettings){for(var i=this.getData(),r=0,a=this.settings.editItemSettings;r<a.length;r++){var n=a[r],d=this.select('.pdvis-edit-item[data-path="'+n.key+'"]'),s=common_1.PdCommonUtils.createId(n.key+"-"),l="ruleEnable-"+n.key,o={html:"",cls:"pdsdk-rule-select",input:{atts:{id:s,name:l,value:"on"}}},u=n.key.toString(),p=$.extend(!0,{},i[u],this.settings.ruleChecked[u]);this.settings.ruleChecked[u]&&(o.input.atts.checked=!0,i[l]=["on"],i[u]=p);var c=index_1.PdUICheckbox.create(o);d.append(c)}this.setData(i)}},t.prototype.updateRule=function(){this.select(".pdvis-edit-rule-body").empty().append(this.buildEdit()),this.updateEdit(this.settings.editItemSettings)},t.prototype.validateDialog=function(){var e=".pdvis-edit-item-required.pdvis-edit-item-single",t=e+" input, "+e+" textarea",i=!0;return this.editDialog.$el.find(t).each(function(e,t){edit_item_1.PdVisEditItem.checkValueItemRequired($(t).closest(".pdvis-edit-item"))||(i=!1)}),i},t.defaultSettings={side:"right",ruleChecked:{},editItemSettings:[]},t}(edit_1.PdVisPluginEdit);exports.PdSDKPluginRule=PdSDKPluginRule;