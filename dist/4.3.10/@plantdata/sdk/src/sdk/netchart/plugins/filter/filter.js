"use strict";var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function a(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}();Object.defineProperty(exports,"__esModule",{value:!0});var $=require("jquery"),lodash_1=require("lodash"),add_1=require("../../../../icon/add"),filter_1=require("../../../../vis/netchart/plugins/filter/filter"),common_1=require("../../../../common/common"),edit_item_1=require("../../../../vis/utils/edit-item/edit-item"),utils_1=require("../../../utils/utils"),autocomplete_1=require("../../../../ui/components/autocomplete/autocomplete"),form_1=require("../../../../ui/components/form/form"),dialog_1=require("../../../../vis/utils/modal/dialog/dialog"),tag_1=require("../../../../ui/components/tag/tag"),PdSDKPluginFilter=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.mergeFilterSettings=function(t,e){var i=lodash_1.cloneDeep(t);if(e)for(var a=0,r=e;a<r.length;a++){var s=r[a],l=lodash_1.findIndex(i,["key",s.key]);if(l>=0){var n=$.extend({},i[l],s);i.splice(l,1,n)}else i.push(s)}return i},e.prototype.getData=function(){var e=t.prototype.getData.call(this);return this.aloneToReservedAtt(e),e},e.prototype.setData=function(e,i){void 0===e&&(e={}),void 0===i&&(i=!1),this.reservedAttToAlone(e),t.prototype.setData.call(this,e)},e.prototype.aloneToReservedAtt=function(t){t.reservedAttFilters=[],t.reliability&&(t.reservedAttFilters.push({seqNo:12,$gte:t.reliability[0],$lte:t.reliability[1]}),delete t.reliability),t.score&&(t.reservedAttFilters.push({seqNo:3,$gte:t.score[0],$lte:t.score[1]}),delete t.score)},e.prototype.bindEvent=function(){var e=this;t.prototype.bindEvent.call(this),this.getMainContainer().on("click",".pdsdk-filter-att-add",function(t){e.updateEdgeForm(),e.editDialog.open({event:t})}).on("click",".pdvis-filter-edge-tag-item",function(t){var i=$(t.currentTarget).index();e.updateEdgeForm(e.attAttFilters[i]),e.editDialog.open({event:t})}).on("click",".pdvis-filter-edge-tag-item .close-icon",function(t){var i=$(t.currentTarget).closest(".pdvis-filter-edge-tag-item"),a=i.index();i.remove(),e.attAttFilters.splice(a,1),t.stopPropagation()})},e.prototype.buildFilter=function(t){var i=this,a=t.schema,r=[],s=[],l=[],n=function(t){for(var e=[],a=[],r=0,s=t;r<s.length;r++){var n=s[r];if(1===n.type){var o={value:n.k.toString(),label:n.v};e.push(o),a.push(n.k)}}return e=lodash_1.orderBy(e,["label"],["asc"]),{key:"allowAtts",label:"设定分析关系",selected:a,index:8,options:e,filterable:!0,onchange:function(t){l=t,i.isItemEnable("attAttFilters")&&i.select('[data-path="attAttFilters"]').find('[name="attrId"]').each(function(t,e){var i=$(e).val();lodash_1.indexOf(l,i)<0&&$(e).closest(".pdvis-filter-att-item").remove()})}}},o=n(a.atts);l=o.selected;var d={},p=common_1.PdCommonUtils.listToTree(a.types,"0","k","v","parentId"),c=function(t,e,i){for(var a=0,r=t;a<r.length;a++){var s=r[a],l=s.value.toString();i[l]=e.concat([l]),s.children&&c(s.children,i[l],i)}};if(c(p,["0"],d),t.showAllSchemaOptions){r=p;for(var u=0,v=a.types;u<v.length;u++){var f=v[u];s.push(f.k)}}else for(var g=0,h=a.types;g<h.length;g++){var f=h[g];"0"===f.parentId&&(r.push({value:f.k,label:f.v}),s.push(f.k))}var m=[{key:"distance-expend",label:"设定扩展层级",selected:"0",index:1,options:{0:"自动",1:"1层",2:"2层",3:"3层"}},{key:"direction",label:"设定查询边关系的方向",selected:"0",index:2,options:{0:"双向",1:"正向",2:"反向"}},{key:"isRelationMerge",label:"设定关系展示合并",selected:"false",index:3,options:{"false":"不合并","true":"合并"}},{key:"hyponymyDistance",label:"设定查询上下位层数",selected:6,index:4,type:"custom",customType:"slider",settings:{min:0,max:6,step:1}},{key:"reliability",label:"设定查询节点、关系的置信度范围",selected:[0,1],index:5,type:"custom",customType:"slider",settings:{min:0,max:1,step:.1,range:!0}},{key:"score",label:"设定查询节点、关系的权重范围",selected:[0,1],index:6,type:"custom",customType:"slider",settings:{min:0,max:1,step:.1,range:!0}},{key:"allowTypes",label:"设定分析主体",selected:s,index:7,options:r,filterable:!0,isTree:t.showAllSchemaOptions,onchange:function(t){if(i.isItemEnable("allowTypes")){for(var e=[],r=0,s=t;r<s.length;r++){var o=s[r];e.push(d[o])}for(var p=lodash_1.uniq(lodash_1.flatten(e)),c=[],u=0,v=a.atts;u<v.length;u++){var o=v[u];if(p.indexOf(o.domain)>=0)for(var f=0,g=o.range;f<g.length;f++){var h=g[f];if(p.indexOf(h.toString())>=0){c.push(o);break}}}var m=n(c);m.selected=l,i.updateFilter(m)}}},o,{key:"attAttFilters",label:"设定分析边关系",index:9,type:"custom",customType:"custom",getValue:function(t,e){return lodash_1.map(i.attAttFilters,function(t){var e=lodash_1.cloneDeep(t);return e.$in=e.edgeValue,delete e.edgeValue,e})},setValue:function(t,e,a){i.setEdgeValue(a)},buildItem:function(t){var e=lodash_1.find(i.settings.schema.atts,function(t){return 1===t.type&&t.extraInfos&&t.extraInfos.length}),a="";if(e){var r=add_1["default"](24),s='<div class="pdsdk-filter-add pdsdk-filter-att-add"><button class="pdui-btn pdui-btn-primary-outline">'+r+"添加条件</button></div>";a='<div class="pdvis-filter-custom-container"><div class="pdvis-filter-edge-tags"></div>'+s+"</div>"}else a='<div class="pd-no-data">不存在可以进行边关系筛选的关系</div>';return $(edit_item_1.PdVisEditItem.buildEditItem(t.label,a,"",t.key))}}],y=t?t.editItemSettings:[];return e.mergeFilterSettings(m,y)},e.prototype.initSettings=function(i){var a=this.buildFilter(i),r=$.extend(!0,{},t.prototype.initSettings.call(this,e.defaultSettings),i);return r.editItemSettings=a,r},e.prototype.isItemEnable=function(t){var e=lodash_1.find(this.settings.editItemSettings,["key",t]);return e&&e.disabled!==!1},e.prototype.list=function(t,e){void 0===t&&(t=1);var i=$.extend(!0,{ajaxSettings:this.settings.ajaxSettings,kgName:this.settings.kgName},{}),a=i.ajaxSettings,r=a.queryData||{};r.pageNo=t,r.pageSize=1e3,r.kgName=i.kgName;var s={url:a.baseUrl+"app/attr/prompt",type:"POST",el:this.editDialog.$el[0],data:$.extend(!0,{},a.formData,e,{})};return s=$.extend(!0,{},s,a),s.url=utils_1.PdSDKUtils.buildUrl(s.url,r),utils_1.PdSDKUtils.ajax(s)},e.prototype.mounted=function(){var e=this;t.prototype.mounted.call(this);var i=lodash_1.find(this.settings.editItemSettings,["key","attAttFilters"]);if(this.setEdgeValue(i?i.selected||[]:[]),!this.editDialog){var a=edit_item_1.PdVisEditItem.createInput({key:"$gte",placeholder:"最小值"}),r=edit_item_1.PdVisEditItem.createInput({key:"$lte",placeholder:"最大值"});this.editDialog=new dialog_1.PdVisDialog({cls:"pdsdk-filter-edge-dialog",title:"添加边关系分析条件",body:'<div class="pdvis-filter-att-item"><div class="pdvis-filter-att-edge"></div><div class="pdvis-filter-att-edge-att"></div><div class="pdvis-filter-att-type"></div><div class="pdvis-filter-att-start hide">'+a+'</div><div class="pdvis-filter-att-end hide">'+r+'</div><div class="pdvis-filter-att-prompt hide"></div><div class="pdvis-filter-att-list hide"></div></div>',positiveClick:function(){var t=form_1.PdUIForm.getFormData(e.editDialog.$el);e.attAttFilters||(e.attAttFilters=[]);var i=lodash_1.findIndex(e.attAttFilters,function(e){return e.attrId===t.attrId&&e.seqNo===t.seqNo});return t="0"===t.type?lodash_1.pick(t,["attrId","seqNo","type","$in","edgeValue"]):lodash_1.pick(t,["attrId","seqNo","type","$lte","$gte"]),i<0?e.attAttFilters.push(t):e.attAttFilters.splice(i,1,t),e.updateEdge(),Promise.resolve(t)}})}},e.prototype.reservedAttToAlone=function(t){t.reservedAttFilters&&t.reservedAttFilters.length&&t.reservedAttFilters.forEach(function(e,i){switch(e.seqNo.toString()){case"12":t.reliability=[e.$gte||0,e.$lte||1];break;case"3":t.score=[e.$gte||0,e.$lte||1]}})},e.prototype.setEdgeValue=function(t){t&&t.length&&(this.attAttFilters=lodash_1.map(t,function(t){var e=lodash_1.cloneDeep(t);return e.edgeValue=e.$in,delete e.$in,e}),this.updateEdge())},e.prototype.updateEdge=function(){var t=this.select('[data-path="attAttFilters"]').find(".pdvis-filter-edge-tags").empty(),e=this.settings.schema.atts,i=[];this.attAttFilters.forEach(function(a,r){var s=lodash_1.find(e,["k",parseInt(a.attrId,10)]);if(s){var l=lodash_1.find(s.extraInfos,["seqNo",parseInt(a.seqNo,10)]);if(l){i.push(a);var n="";"1"===a.type?(a.$gte||a.$lte)&&(n=(a.$gte||"不限")+" ~ "+(a.$lte||"不限")):n=a.edgeValue&&a.edgeValue.length?a.edgeValue.join(","):"未设置";var o=s.v+" - "+l.name+" - "+(n?n:"不限"),d=l.name+(n?"为"+n:"不限")+"的"+s.v+"关系";t.append(tag_1.PdUITag.create({size:"sm",type:"primary",removable:!0,html:"<span>"+o+"</span>",cls:"pdvis-filter-edge-tag-item",atts:{title:d}}))}}}),this.attAttFilters=i},e.prototype.updateFilterType=function(t){var e=this.editDialog.$el,i=e.find(".pdvis-filter-att-prompt, .pdvis-filter-att-list"),a=e.find(".pdvis-filter-att-start, .pdvis-filter-att-end");switch(t.toString()){case"0":a.addClass("hide"),i.removeClass("hide");break;case"1":i.addClass("hide"),a.removeClass("hide")}},e.prototype.updateEdgeForm=function(t){var e,i=this,a=this.editDialog.$el.find(".pdvis-filter-att-item"),r=t?t.type||"0":"0",s=[];if(this.isItemEnable("allowTypes")){var l=this.getData();e=l.allowAtts}for(var n=this.settings.schema.atts,o={},d=t?t.attrId.toString():null,p=0,c=n;p<c.length;p++){var u=c[p];if(1===u.type&&u.extraInfos&&u.extraInfos.length){var v=u.k.toString();if(!e||lodash_1.indexOf(e,v)>=0){o[v]=u.extraInfos,d||(d=v);var f={value:v,label:u.v,checked:d===v};s.push(f)}}}var g=$(edit_item_1.PdVisEditItem.createSelect({key:"attrId",placeholder:"请选择关系",options:s})),h=function(e){var s=lodash_1.concat([],o[e]),l=lodash_1.map(s,function(e){return{value:e.seqNo.toString(),label:e.name,checked:!!t&&t.seqNo.toString()===e.seqNo.toString()}}),n=t?t.seqNo:l[0].value,d=$(edit_item_1.PdVisEditItem.createSelect({key:"seqNo",placeholder:"请选择边关系",options:l}));a.find(".pdvis-filter-att-edge-att").empty().append(d);var p=$("<div></div>");a.find(".pdvis-filter-att-prompt").empty().append(p);var c=function(t){u(t)},u=(new autocomplete_1.PdUIAutocomplete({selector:p,size:"sm",name:null,prompt:!1,theme:"normal",onSearch:c,icon:{close:{onclick:function(t){t.clear(),c("")}}}}),function(r,s){void 0===r&&(r=""),void 0===s&&(s="");var l=a.find(".pdvis-filter-att-list").empty();"0"===a.find(".pdvis-filter-att-type select").val()&&i.list(1,{attrId:e,seqNo:n,kw:r,searchOption:s,isReserved:lodash_1.indexOf(["3","11","12","13","15"],n)<0?0:1}).then(function(a){var r=lodash_1.find(i.attAttFilters||[],function(t){return t.attrId===e&&t.seqNo===n}),s=edit_item_1.PdVisEditItem.createCheckbox({key:"edgeValue",value:t?t.edgeValue:r?r.edgeValue:[],options:lodash_1.sortBy(lodash_1.map(a,function(t){return t.key}))});l.append(s)},function(){l.append(common_1.PdCommonUtils.buildNoData("无相关数据"))})}),v=function(){var t=[{label:"完全匹配",value:"0",checked:"0"===r.toString()}],e=lodash_1.find(s,["seqNo",parseInt(n,10)]);e&&5!==e.dataType?t.push({label:"范围筛选",value:"1",checked:"1"===r.toString()}):"1"===r.toString()&&(r="0");var l=$(edit_item_1.PdVisEditItem.createSelect({key:"type",placeholder:"请选择过滤类型",options:t}));l.on("change",function(t){u(),i.updateFilterType($(t.currentTarget).val().toString())}),a.find(".pdvis-filter-att-type").empty().append(l),i.updateFilterType(r.toString())};d.on("change",function(t){n=$(t.currentTarget).val(),v(),u()}),n&&(v(),u())};g.on("change",function(t){var e=$(t.currentTarget).val();h(e)}),a.find(".pdvis-filter-att-edge").empty().append(g),d&&h(d),a.find(".pdvis-filter-att-start input").val(t?t.$gte||"":""),a.find(".pdvis-filter-att-end input").val(t?t.$lte||"":"")},e.prototype.unbindEvent=function(){t.prototype.unbindEvent.call(this),this.getMainContainer().off("click",".pdsdk-filter-att-add").off("click",".pdvis-filter-edge-tag-item").off("click",".pdvis-filter-edge-tag-item .close-icon")},e.defaultSettings={},e}(filter_1.PdVisPluginFilter);exports.PdSDKPluginFilter=PdSDKPluginFilter;